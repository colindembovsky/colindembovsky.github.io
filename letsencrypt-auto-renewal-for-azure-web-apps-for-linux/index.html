<!DOCTYPE html>
<html lang="en"><head><title>LetsEncrypt Auto-Renewal For Azure Web Apps for Linux | Colin’s ALM Corner</title><meta name="generator" content="Jekyll v3.9.0" /><meta property="og:title" content="LetsEncrypt Auto-Renewal For Azure Web Apps for Linux" /><meta name="author" content="Colin Dembovsky" /><meta property="og:locale" content="en" /><meta name="description" content="In this post I show how I achieved automated LetsEncrypt cert registration and renewal for Azure Web Apps for Linux using nginx and CertBot." /><meta property="og:description" content="In this post I show how I achieved automated LetsEncrypt cert registration and renewal for Azure Web Apps for Linux using nginx and CertBot." /><link rel="canonical" href="https://github.com/pages/colindembovsky/letsencrypt-auto-renewal-for-azure-web-apps-for-linux/" /><meta property="og:url" content="https://github.com/pages/colindembovsky/letsencrypt-auto-renewal-for-azure-web-apps-for-linux/" /><meta property="og:site_name" content="Colin’s ALM Corner" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-04-24T22:34:56+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="LetsEncrypt Auto-Renewal For Azure Web Apps for Linux" /><meta name="twitter:site" content="@colindembovsky" /><meta name="twitter:creator" content="@colindembovsky" /> <script type="application/ld+json"> {"description":"In this post I show how I achieved automated LetsEncrypt cert registration and renewal for Azure Web Apps for Linux using nginx and CertBot.","url":"https://github.com/pages/colindembovsky/letsencrypt-auto-renewal-for-azure-web-apps-for-linux/","@type":"BlogPosting","headline":"LetsEncrypt Auto-Renewal For Azure Web Apps for Linux","dateModified":"2020-04-24T22:34:56+00:00","datePublished":"2020-04-24T22:34:56+00:00","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://github.com/pages/colindembovsky/assets/img/logo.png"},"name":"Colin Dembovsky"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://github.com/pages/colindembovsky/letsencrypt-auto-renewal-for-azure-web-apps-for-linux/"},"author":{"@type":"Person","name":"Colin Dembovsky"},"@context":"https://schema.org"}</script><meta name="keywords" content="devops,github,actions,build,ci,cd"><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Colin's ALM Corner"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="application-name" content="Colin's ALM Corner"><meta name="theme-color" content="rgb(5,19,24)"><meta name="generator" content="Hydejack v9.1.4" /><link rel="alternate" href="https://github.com/pages/colindembovsky/letsencrypt-auto-renewal-for-azure-web-apps-for-linux/" hreflang="en"><link type="application/atom+xml" rel="alternate" href="https://github.com/pages/colindembovsky/feed.xml" title="Colin's ALM Corner" /><link rel="shortcut icon" href="/pages/colindembovsky/assets/icons/favicon.ico"><link rel="apple-touch-icon" href="/pages/colindembovsky/assets/icons/icon-192x192.png"><link rel="manifest" href="/pages/colindembovsky/assets/site.webmanifest"><link rel="dns-prefetch" href="https://fonts.googleapis.com"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preload" href="/pages/colindembovsky/assets/img/swipe.svg" as="image" id="_hrefSwipeSVG"><link rel="dns-prefetch" href="/pages/colindembovsky/assets/js/search-worker-9.1.4.js" as="worker" id="_hrefSearch"> <script>!function(r,c){"use strict";function a(e,t,n,o){e.addEventListener?e.addEventListener(t,n,o):e.attachEvent?e.attachEvent("on"+t,n):e["on"+t]=n}r.loadJS=function(e,t){var n=c.createElement("script");n.src=e,t&&a(n,"load",t,{once:!0});t=c.scripts[0];return t.parentNode.insertBefore(n,t),n},r._loaded=!1,r.loadJSDeferred=function(e,t){var n=c.createElement("script");function o(){r._loaded=!0,t&&a(n,"load",t,{once:!0});var e=c.scripts[0];e.parentNode.insertBefore(n,e)}return n.src=e,r._loaded?o():a(r,"load",o,{once:!0}),n},r.setRel=r.setRelStylesheet=function(e){a(c.getElementById(e),"load",function(){this.rel="stylesheet"},{once:!0})}}(window,document); !function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this); !function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this); !function(w) { w._baseURL = '/pages/colindembovsky/'; w._publicPath = '/pages/colindembovsky/assets/js/'; w._noPushState = false; w._noDrawer = false; w._noNavbar = false; w._noToc = false; w._noSearch = false; w._advertise = false; w._search = { DATA_URL: '/pages/colindembovsky/assets/sitedata.json?no-cache', STORAGE_KEY: 'mini-search/pages/colindembovsky/', INDEX_KEY: 'index--2021-11-18T20:23:33+00:00', }; w._clapButton = false; }(window);</script> <script async src="/pages/colindembovsky/assets/bower_components/MathJax/es5/tex-mml-chtml.js" id="_MathJax"></script> <!--[if gt IE 8]><!----><style id="_styleInline"> .clearfix,.sidebar-social::after{content:"";display:table;clear:both}.color-transition,body,p,hr,.hr,.hr-after::after,.hr-bottom,.message,.note-sm,.note,#markdown-toc,.navbar,.nav-btn-bar,.nav-btn,.content .avatar{transition:none}#_dark-mode{font-size:1.25rem}@media screen{body.light-mode{--body-color: #333;--body-bg: #fff;--border-color: #ebebeb;--gray: #777;--gray-bg: rgba(0,0,0,0.025);--gray-text: #666;--menu-text: #bbb;--inv-body-color: #ccc;--inv-body-bg: var(--dark-mode-body-bg)}body.light-mode .content{-webkit-font-smoothing:initial;-moz-osx-font-smoothing:initial}body.dark-mode{--body-color: #ccc;--body-bg: var(--dark-mode-body-bg);--border-color: var(--dark-mode-border-color);--gray: rgba(255,255,255,.5);--gray-bg: rgba(255,255,255,.033);--gray-text: rgba(255,255,255,.625);--menu-text: rgba(255,255,255,.25);--inv-body-color: #333;--inv-body-bg: #fff}body.dark-mode .content{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}}@media screen and (prefers-color-scheme: dark){body{--body-color: #ccc;--body-bg: var(--dark-mode-body-bg);--border-color: var(--dark-mode-border-color);--gray: rgba(255,255,255,.5);--gray-bg: rgba(255,255,255,.033);--gray-text: rgba(255,255,255,.625);--menu-text: rgba(255,255,255,.25);--inv-body-color: #333;--inv-body-bg: #fff}body .content{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.tippy-content{-webkit-font-smoothing:initial;-moz-osx-font-smoothing:initial}}html{--font-family: Noto Sans,Helvetica,Arial,sans-serif;--font-family-heading: Roboto Slab,Helvetica,Arial,sans-serif;--code-font-family: Fira Code,Menlo,Monaco,Consolas,monospace;--body-color: #333;--body-bg: #fff;--border-color: #ebebeb;--gray: #777;--gray-bg: rgba(0,0,0,0.025);--gray-text: #666;--menu-text: #bbb;--inv-body-color: #ccc;--inv-body-bg: var(--dark-mode-body-bg);--root-font-size: 15px;--root-font-size-medium: 16px;--root-font-size-large: 17px;--root-font-size-print: 8pt;--root-line-height: 1.75;--font-weight: 400;--font-weight-bold: 700;--font-weight-heading: 700;--content-width-5: 54rem;--content-margin-5: 4rem;--sidebar-width: 21rem;--half-content: 31rem;--break-point-3: 64em;--break-point-5: 86em;--break-point-dynamic: 1664px}html .content{-webkit-font-smoothing:initial;-moz-osx-font-smoothing:initial}*{box-sizing:border-box}html,body{margin:0;padding:0}html{font-family:var(--font-family);font-size:var(--root-font-size);line-height:var(--root-line-height)}body{color:var(--body-color);background-color:var(--body-bg);font-weight:var(--font-weight);overflow-y:scroll}.content img,.img,.content video,.video{max-width:100%;height:auto}.lead{margin-left:-1rem;margin-right:-1rem;margin-bottom:1.5rem}img.lead,video.lead{display:block;max-width:calc(100% + 2rem);width:calc(100% + 2rem);height:auto}.heading,.f1,h1,.h1,.f2,h2,.h2,.f3,h3,.h3,.f4,h4,.h4,.post-date,.sidebar-nav-item,.f5,h5,.h5,.f6,h6,.h6{font-family:var(--font-family-heading);font-weight:var(--font-weight-heading)}.f1,h1,.h1{font-size:2rem;line-height:1.3}.f2,h2,.h2{font-size:1.5rem;line-height:1.4}.f3,h3,.h3{font-size:1.2em;line-height:1.5}.f4,h4,.h4,.post-date,.sidebar-nav-item{font-size:1.08rem;line-height:1.6}.f5,h5,.h5{font-size:1.04rem;line-height:1.7}.f6,h6,.h6{font-size:1rem}.content h1>a,.content .h1>a{text-decoration:none;border-bottom:none}@media screen and (max-width: 42em){.content h1,.content .h1{font-size:1.7rem;line-height:1.35}}@media screen and (min-width: 86em){.content h1,.content .h1{font-size:2.4rem;line-height:1.25}}@media screen and (min-width: 1664px){body:not(.no-large-headings) .content h1,body:not(.no-large-headings) .content .h1{width:calc(100% + 50vw - 32rem);font-size:3rem;line-height:1.2}}@media screen and (min-width: 124em){body:not(.no-large-headings) .content h1,body:not(.no-large-headings) .content .h1{font-size:4rem;line-height:1.1}}h1,h2,h3,.h1,.h2,.h3{margin:4rem 0 1rem}h4,h5,h6,.h4,.post-date,.h5,.h6{margin:3rem 0 .5rem}p{margin-top:0;margin-bottom:1rem}p.lead{font-size:1.2em;margin-top:1.5rem;margin-bottom:1.5rem;padding:0 1rem}ul,ol,dl{margin-top:0;margin-bottom:1rem}ul,ol{padding-left:1.25rem}hr,.hr{border:0;margin:1rem 0;border-top:1px solid var(--border-color)}.hr-after::after{content:"";display:block;margin:1rem 0;border-top:1px solid var(--border-color)}.hr-bottom{border-bottom:1px solid var(--border-color);padding-bottom:.75rem;margin-bottom:1rem}.page{margin-bottom:3em}.page li+li{margin-top:.25rem}.page>header{position:relative;margin-bottom:1.5rem}@media screen and (min-width: 1664px){body:not(.no-third-column) .page>header>.lead+.note-sm,body:not(.no-third-column) .page>header>.lead+.note,body:not(.no-third-column) .page>header>.lead+#markdown-toc,body:not(.no-third-column) .page>header>a.no-hover+.note-sm,body:not(.no-third-column) .page>header>a.no-hover+.note,body:not(.no-third-column) .page>header>a.no-hover+#markdown-toc{position:absolute;right:-25rem;width:21rem;bottom:0;margin-bottom:0}}.page-title,.post-title{margin-top:0}.post-date{display:flex;justify-content:space-between;margin-top:-.6rem;height:2rem;margin-bottom:.85rem;color:var(--gray)}.post-date>.ellipsis,#breadcrumbs.post-date>ul{cursor:pointer}.post-date [class^="icon-"]{display:inline-block;font-size:smaller;margin-right:.25rem}.related-posts{padding-left:0;list-style:none;margin-bottom:2rem}.related-posts>li,.related-posts>li+li{margin-top:1rem}.message,.note-sm,.note,#markdown-toc{margin-bottom:1rem;padding:1rem;color:var(--gray-text);background-color:var(--gray-bg);margin-left:-1rem;margin-right:-1rem}.note-sm,.note,#markdown-toc{background:transparent;color:var(--body-color);font-size:smaller;border-left:1px solid var(--border-color);padding:1.2rem 1rem 0 1rem;margin:1rem -1rem;position:relative}.note-sm:before,.note:before,#markdown-toc:before{font-size:0.667rem;font-weight:bold;font-style:normal;letter-spacing:.025rem;text-transform:uppercase;color:var(--menu-text);position:absolute;top:0}.note-sm[title]:before,[title].note:before,[title]#markdown-toc:before{content:attr(title) !important}.note{font-size:1rem}@media screen{body::before{content:'';width:.5rem;background:var(--gray-bg);position:fixed;left:0;top:0;bottom:0}}@media (min-width: 64em){body::before{width:21rem}}@media (min-width: 1664px){body::before{width:calc(50% - 31rem)}}@media screen and (min-width: 42em){html{font-size:var(--root-font-size-medium)}}@media screen and (min-width: 124em){html{font-size:var(--root-font-size-large)}}#breadcrumbs>ul{height:1rem;margin:-1.5rem 0 .5rem;padding:0;font-size:.667rem;color:var(--menu-text);text-transform:uppercase;width:100%;list-style:none}#breadcrumbs>ul>li{display:inline}#breadcrumbs>ul>li a{color:var(--gray);text-decoration:none;border-bottom:none}.fl{float:left}.fr{float:right}.mb4{margin-bottom:4rem}.mb6{margin-bottom:6rem}.mt0{margin-top:0}.mt1{margin-top:1rem}.mt2{margin-top:2rem}.mt3{margin-top:3rem}.mt4{margin-top:4rem}.pb0{padding-bottom:0}.ml1{margin-left:1rem}.mr1{margin-right:1rem}.sixteen-nine{position:relative}.sixteen-nine::before{display:block;content:"";width:100%;padding-top:56.25%}.sixteen-nine>*{position:absolute;top:0;left:0;right:0;bottom:0}.sixteen-ten{position:relative}.sixteen-ten::before{display:block;content:"";width:100%;padding-top:62.5%}.sixteen-ten>*{position:absolute;top:0;left:0;right:0;bottom:0}.four-three{position:relative}.four-three::before{display:block;content:"";width:100%;padding-top:75%}.four-three>*{position:absolute;top:0;left:0;right:0;bottom:0}.sr-only{display:none}.larger{font-size:larger}.smaller{font-size:smaller}.clearfix,.sidebar-social::after{content:"";display:table;clear:both}.ellipsis,#breadcrumbs>ul{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.border{border:1px solid var(--border-color)}@media (min-width: 42em){.border-radius,.lead,.page .aspect-ratio.sixteen-nine.lead{border-radius:.5rem}}.fallback-img{background-position:center;background-repeat:no-repeat;background-image:url("data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4KPHN2ZyB3aWR0aD0iMTYwIiBoZWlnaHQ9IjkwIiB2aWV3Qm94PSIwIDAgMTYwIDkwIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgogIDxnIHRyYW5zZm9ybT0ibWF0cml4KDAuMDQ4ODI4LCAwLCAwLCAwLjA0Nzk5MSwgNTQuOTk5OTczLCAyMC40MjgxNDgpIj4KICAgIDxwYXRoIHN0eWxlPSJmaWxsOnJnYmEoMTI4LDEyOCwxMjgsLjMzKSIgZD0iTTk1OS44ODQgMTI4YzAuMDQwIDAuMDM0IDAuMDgyIDAuMDc2IDAuMTE2IDAuMTE2djc2Ny43N2MtMC4wMzQgMC4wNDAtMC4wNzYgMC4wODItMC4xMTYgMC4xMTZoLTg5NS43N2MtMC4wNDAtMC4wMzQtMC4wODItMC4wNzYtMC4xMTQtMC4xMTZ2LTc2Ny43NzJjMC4wMzQtMC4wNDAgMC4wNzYtMC4wODIgMC4xMTQtMC4xMTRoODk1Ljc3ek05NjAgNjRoLTg5NmMtMzUuMiAwLTY0IDI4LjgtNjQgNjR2NzY4YzAgMzUuMiAyOC44IDY0IDY0IDY0aDg5NmMzNS4yIDAgNjQtMjguOCA2NC02NHYtNzY4YzAtMzUuMi0yOC44LTY0LTY0LTY0djB6Ii8+CiAgICA8cGF0aCBzdHlsZT0iZmlsbDpyZ2JhKDEyOCwxMjgsMTI4LC4zMykiIGQ9Ik04MzIgMjg4YzAgNTMuMDIwLTQyLjk4IDk2LTk2IDk2cy05Ni00Mi45OC05Ni05NiA0Mi45OC05NiA5Ni05NiA5NiA0Mi45OCA5NiA5NnoiLz4KICAgIDxwYXRoIHN0eWxlPSJmaWxsOnJnYmEoMTI4LDEyOCwxMjgsLjMzKSIgZD0iTTg5NiA4MzJoLTc2OHYtMTI4bDIyNC0zODQgMjU2IDMyMGg2NGwyMjQtMTkyeiIvPgogIDwvZz4KPC9zdmc+")}hy-push-state a{color:var(--body-color)}@supports not ((text-decoration-thickness: initial) and (text-underline-offset: initial)){hy-push-state a{text-decoration:none;border-bottom:2px solid}}@supports (text-decoration-thickness: initial) and (text-underline-offset: initial){hy-push-state a{text-decoration-style:solid;text-underline-offset:.35rem;text-decoration-thickness:2px}}hy-push-state a.no-hover{border-bottom:none;text-decoration-thickness:unset;text-underline-offset:unset}.content a:not(.btn):not(.no-hover){border-color:var(--accent-color-faded)}@supports (text-decoration-thickness: initial) and (text-underline-offset: initial){.content a:not(.btn):not(.no-hover){text-decoration-color:var(--accent-color-faded)}}.content .aspect-ratio{overflow:hidden}.content .aspect-ratio img{margin:0;width:100%;height:100%;background-color:var(--gray-bg)}hy-drawer{width:100%;position:relative;overflow:hidden;display:block;z-index:4}@media screen and (min-width: 64em){hy-drawer{position:fixed;width:21rem;top:0;left:0;bottom:0;margin-left:0}hy-drawer.cover{position:relative;width:100%}}@media screen and (min-width: 1664px){hy-drawer{width:calc(50% - 31rem)}}.sidebar{position:relative;display:flex;justify-content:center;align-items:center;color:rgba(255,255,255,0.75);text-align:center;min-height:100vh}.sidebar.invert{color:rgba(32,32,32,0.75)}.sidebar a{color:#fff;border-bottom-color:rgba(255,255,255,0.2);text-decoration-color:rgba(255,255,255,0.2)}.sidebar.invert a{color:#222;border-bottom-color:rgba(32,32,32,0.2);text-decoration-color:rgba(32,32,32,0.2)}.sidebar-bg{position:absolute;top:0;left:calc(50% - 50vw);width:100vw;height:100%;background:#202020 center / cover}.sidebar-bg::after{content:"";position:absolute;top:0;left:0;bottom:0;right:0;background:rgba(0,0,0,0.05)}.sidebar-bg.sidebar-overlay::after{background:linear-gradient(to bottom, rgba(32,32,32,0) 0%, rgba(32,32,32,0.5) 50%, rgba(32,32,32,0) 100%)}.sidebar-sticky{position:relative;z-index:3;max-width:21rem;padding:1.5rem;contain:content}.sidebar-about .avatar{margin-bottom:1.5rem}.sidebar-about>a.sidebar-title{text-decoration:none}.sidebar-about>a.sidebar-title>h2{margin:0;padding-bottom:.5rem}.sidebar-about>a.sidebar-title::after{content:'';display:block;border-bottom:2px solid;margin:0 auto .5rem;width:4rem;border-color:rgba(255,255,255,0.2);transition:border-color 250ms}.sidebar-about>a.sidebar-title:hover::after{border-color:#fff;transition:border-color 50ms}.sidebar.invert .sidebar-about>a.sidebar-title::after{border-color:rgba(32,32,32,0.2)}.sidebar.invert .sidebar-about>a.sidebar-title:hover::after{border-color:#222}.sidebar-nav>ul{list-style:none;padding-left:0}.sidebar-nav-item{display:inline-block;margin-bottom:.5rem}@media (min-width: 64em){#_main.no-drawer #_menu{display:none}#_main.no-drawer .nav-btn-bar>:nth-child(2){border:none}}.sidebar-social>ul{display:inline-block;list-style:none;padding-left:0;margin-bottom:0}.sidebar-social>ul>li{float:left}.sidebar-social>ul>li>a{display:inline-block;text-align:center;font-size:1.4rem;width:3rem;height:4rem;padding:.5rem 0;line-height:3rem;text-decoration:none;border-bottom-width:2px;border-bottom-style:solid}.sidebar-social>ul li+li{margin-top:0}.fixed-common,.fixed-top,.fixed-bottom{position:fixed;left:0;width:100%;z-index:2}.fixed-top{top:0}.fixed-bottom{bottom:0}.navbar>.content{position:relative;padding-top:0;padding-bottom:0;min-height:0;max-height:5rem}.nav-btn-bar{margin:0 -1rem;background-color:white;background-color:var(--body-bg);height:5rem;display:flex;align-items:center;position:relative}.nav-btn-bar>:first-child,.nav-btn-bar>:last-child{border:none}.nav-btn{background:none;border:none;text-decoration:none;display:flex;align-items:center;justify-content:center;width:3.25rem;height:5rem;color:var(--menu-text);border-right:1px solid var(--border-color);border-left:1px solid var(--border-color);margin-left:-1px}#markdown-toc{margin:2rem -1rem 2rem calc(-1rem + 1px);padding-left:2.5rem;padding-bottom:.5rem}#markdown-toc:before{left:1rem}@media screen and (min-width: 1664px){body:not(.no-toc) #markdown-toc{position:absolute;z-index:4;width:20.5rem;right:0;margin:auto;overflow:auto}}@media screen and (min-width: 1664px){body.no-break-layout:not(.no-toc) #markdown-toc{width:calc(50% - 31rem)}}.content{margin-left:auto;margin-right:auto;padding:8rem 1rem 12rem}@media screen{.content{padding-left:1.5rem;min-height:100vh}}@media screen and (min-width: 42em){.content{max-width:42rem}}@media screen and (min-width: 54em){.content{max-width:48rem}}@media screen and (min-width: 64em){.content{padding-left:1rem;margin-left:24rem;margin-right:3rem}}@media screen and (min-width: 86em){.content{padding-top:9rem;margin-left:25rem;margin-right:4rem;max-width:54rem}}@media screen and (min-width: 1664px){.content{margin:auto}}.large-only{display:none}@media screen and (min-width: 1664px){.large-only{display:block}}.avatar{width:7rem;height:7rem;border-radius:100%;overflow:hidden;display:inline-block}.avatar img{width:100%}.content .avatar{float:right;box-sizing:content-box;border:1rem solid var(--body-bg);transition:border-color 1s ease;margin-top:-1.5rem;margin-right:-1rem}hr.dingbat{display:none}.center-image{margin:auto;display:block}.note:before{content:"Note"}.page>header>.note-sm:before,.page>header>.note:before,.page>header>#markdown-toc:before{content:"Description"}#markdown-toc:before{content:"Table of Contents"}.layout-resume .note-sm:before,.layout-resume .note:before,.layout-resume #markdown-toc:before{content:"Summary"} .clearfix,main:not(.layout-resume) .columns::after{content:"";display:table;clear:both}.color-transition,main:not(.layout-resume) .project-card{transition:none}main:not(.layout-resume) .columns{margin-left:-1rem;display:flex;flex-wrap:wrap;contain:content;padding-top:1rem;margin-top:1rem;padding-right:1rem;margin-right:-1rem}main:not(.layout-resume) .column{float:left;padding-left:1rem;margin-bottom:2rem;width:100%;display:flex}@media screen and (min-width: 42em){main:not(.layout-resume) .columns{margin-left:-2rem;margin-right:-2rem}main:not(.layout-resume) .column-1-2{width:50%}}@media screen and (min-width: 1664px){main:not(.layout-resume) .columns-break{width:calc(50vw + 25rem)}main:not(.layout-resume) .columns-break>.column-1-2,main:not(.layout-resume) .columns-break>.column-1{width:27.5rem}}@media print{main:not(.layout-resume) .columns{display:block}main:not(.layout-resume) .column{display:block;width:50%}}main:not(.layout-resume) .project-card{width:100%;color:var(--gray-text);background-color:var(--gray-bg);padding-bottom:1rem;position:relative;overflow:hidden;box-shadow:0.125rem 0.125rem 1rem rgba(0,0,0,0.2);contain:content;border-radius:.5rem;page-break-inside:avoid;transition:transform 500ms ease;will-change:transform}main:not(.layout-resume) .project-card:hover{transform:translateY(-0.25rem);transition:transform 250ms ease}main:not(.layout-resume) .project-card>a.flip-project{display:block}main:not(.layout-resume) .project-card>a.flip-project .project-card-img{margin-bottom:0}main:not(.layout-resume) .project-card>a.flip-project .project-card-img img{display:block;border-top-left-radius:.5rem;border-top-right-radius:.5rem}main:not(.layout-resume) .project-card a{position:relative;z-index:1}main:not(.layout-resume) .project-card a.fill-card{position:absolute;top:0;left:0;right:0;bottom:0;z-index:0}main:not(.layout-resume) .project-card>.project-card-title,main:not(.layout-resume) .project-card>.project-card-text{text-align:center;padding:0 1rem}main:not(.layout-resume) .project-card>.project-card-title{display:block;font-size:1.08rem;margin-top:.75rem;margin-bottom:.25rem;color:inherit}main:not(.layout-resume) .project-card>.project-card-text{margin:.25rem 0}main:not(.layout-resume) .column-1>.project-card>.project-card-title{font-size:1.2rem}main:not(.layout-resume) .column-1>.project-card>.project-card-text{font-size:1rem}</style><link rel="preload" as="style" href="/pages/colindembovsky/assets/css/hydejack-9.1.4.css" id="_stylePreload"><link rel="preload" as="style" href="/pages/colindembovsky/assets/icomoon/style.css" id="_iconsPreload"><link rel="preload" as="style" href="https://fonts.googleapis.com/css?family=Roboto+Slab:700%7CNoto+Sans:400,400i,700,700i&display=swap" id="_fontsPreload"> <script> setRel('_stylePreload'); setRel('_iconsPreload'); /**/setRel('_fontsPreload');/**/ </script> <noscript><link rel="stylesheet" href="/pages/colindembovsky/assets/css/hydejack-9.1.4.css"><link rel="stylesheet" href="/pages/colindembovsky/assets/icomoon/style.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Slab:700%7CNoto+Sans:400,400i,700,700i&display=swap"> </noscript><style id="_pageStyle"> html{--accent-color: rgb(79, 129, 220);--accent-color-faded: rgba(79,129,220,0.5);--accent-color-highlight: rgba(79,129,220,0.1);--accent-color-darkened: #2f6ad6;--theme-color: rgb(5,19,24);--dark-mode-body-bg: #292e30;--dark-mode-border-color: #353c3e}</style><!--<![endif]--> <script async src="https://www.googletagmanager.com/gtag/js?id=G-FD31RTDXK2"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-FD31RTDXK2'); </script><body class="no-break-layout"> <script> window._sunrise = 6; window._sunset = 18; !function(e,s){var d="light-mode",o="dark-mode",a=(new Date).getHours();"matchMedia"in e&&e.matchMedia("(prefers-color-scheme)")||(o=(e=a<=e._sunrise||a>=e._sunset?o:d)==o?d:o,s.body.classList.add(e),s.body.classList.remove(o))}(window,document); </script> <hy-push-state id="_pushState" replace-selector="#_main" link-selector="a[href]:not([href^='/pages/colindembovsky/assets/']):not(.external):not(.no-push-state)" script-selector="script" duration="500" hashchange ><div id="_navbar" class="navbar fixed-top"><div class="content"> <span class="sr-only">Jump to:</span><div class="nav-btn-bar"> <a id="_menu" class="nav-btn no-hover" href="#_drawer--opened"> <span class="sr-only">Navigation</span> <span class="icon-menu"></span> </a><div class="nav-span"></div></div></div></div><hr class="sr-only" hidden /><main id="_main" class="content layout-post" role="main" ><nav id="breadcrumbs" class="screen-only"><ul><li><a href="/pages/colindembovsky/">home</a><li> <span>/</span> <span>letsencrypt-auto-renewal-for-azure-web-apps-for-linux</span></ul></nav><article id="post-letsencrypt-auto-renewal-for-azure-web-apps-for-linux" class="page post mb6" role="article"><header><h1 class="post-title flip-project-title"> LetsEncrypt Auto-Renewal For Azure Web Apps for Linux</h1><div class="post-date"> <span class="ellipsis mr1"> <time datetime="2020-04-24T22:34:56+00:00">24 Apr 2020</time> on <a href="/pages/colindembovsky/tag/azure/" class="flip-title">azure</a> </span></div><p class="note-sm" > In this post I show how I achieved automated LetsEncrypt cert registration and renewal for Azure Web Apps for Linux using nginx and CertBot.</header><ol id="markdown-toc"><li><a href="#tldr" id="markdown-toc-tldr">tl;dr</a><li><a href="#ghost" id="markdown-toc-ghost">Ghost</a><li><a href="#certbot" id="markdown-toc-certbot">CertBot</a><li><a href="#the-solution" id="markdown-toc-the-solution">The Solution</a><li><a href="#certbot-customization" id="markdown-toc-certbot-customization">CertBot Customization</a><li><a href="#wrapping-up" id="markdown-toc-wrapping-up">Wrapping Up</a></ol><p>This is my first post after converting my blog to Ghost. There are dozens of posts from all sorts of people about how they adopted/migrated to Ghost. I had some interesting challenges to get my site going, which I will post about. One of them was SSL security. <!--kg-card-begin: markdown--><p>My previous blog engine was a fork of <a href="https://github.com/madskristensen/MiniBlog">MiniBlog</a> by Mads Kristensen. I customized it because I was previously on Blogger (remember that?) and had to import from Blogger. I also added Azure Storage rather than using file system and a search function. I was running the .NET framework version (which is fairly old) and was using Windows Live Writer (or now Open Live Writer) to author. Being able to author in markdown was the primary driver for me getting to Ghost! <!--kg-card-end: markdown--><h2 id="tldr">tl;dr</h2><p>If you just want to jump straight to the code, head to the repo <a href="https://github.com/colindembovsky/webapp-linux-letsencrypt-auto-renew">here</a>. There’s a detailed readme with instructions. <!--kg-card-begin: markdown--><h2 id="ghost">Ghost</h2><!--kg-card-end: markdown--><p>There is a <a href="https://hub.docker.com/_/ghost">Ghost docker image</a> that is stupid simple to use to get Ghost up and running. I won’t bore you with how I converted my posts from my old blog, but extracting an import of all my old content was manageable. I was now ready to run this sucker live!<p>That’s when I hit my first big snag - I wanted to enforce SSL (of course). No problem - I can just install the <a href="https://github.com/sjkp/letsencrypt-siteextension">LetsEncrypt Azure Web App extension</a> and I’d be good to go, right? Wrong - <em>Web Apps for Linux can’t have extensions!!</em><p>No problem - I’ll just run an <a href="https://www.nginx.com/">nginx</a> side-car container reverse proxy using <a href="https://docs.microsoft.com/en-us/azure/app-service/containers/tutorial-multi-container-app">multi-containers</a> and let nginx handle the SSL termination. Except I could not get that to work.<p>I found this <a href="https://jessicadeen.com/how-to-manually-setup-a-lets-encrypt-ssl-cert-for-azure-web-app-with-linux/">great post</a> by Jessica Deen on how to use SSL on Azure Linux Web Apps (coincidentally she was doing this for her Ghost blog!). While this looked promising, I didn’t want to have to manually renew the cert every 90 days! <!--kg-card-begin: markdown--><h2 id="certbot">CertBot</h2><!--kg-card-end: markdown--><p>I scrathed around and found a Docker image for registering (and renewing) certs called <a href="https://hub.docker.com/r/certbot/certbot/">CertBot</a>. I tried running this with nginx like <a href="https://medium.com/@pentacent/nginx-and-lets-encrypt-with-docker-in-less-than-5-minutes-b4b8a60d3a71">this post</a>. It was exactly what I was trying to do - except that the cert magic happend outside the images and docker-compose!<p>Eventually it dawned on me - I could combine both approaches. To automate certificate registration using CertBot, CertBot issues a request to LetsEncrypt and listens for a HTTP request from LetsEncrypt (to the CDN you’re registering). If it receives the call, it knows you’re making the request from a domain you own and the cert is issued. So I’d need to route the challenge request to the certbot container. Of course all other calls needed to be routed to my app container.<p>After registration (or renewal) there’s a hook for executing a script. So I could use some of Jessica’s <code class="language-plaintext highlighter-rouge">az cli</code> code to register the cert to the web app! I could then just loop CertBot, checking for renewals. When a renewal is performed, the same hook could register the new cert for me - voila, automated cert renewal with LetsEncrypt!<h2 id="the-solution">The Solution</h2><p>Let’s start with the <code class="language-plaintext highlighter-rouge">yml</code> file that describes the containers I spin up in my multi-container app:<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
    <span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">3.3'</span>
    
    <span class="na">services</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="c1"># this name should be the value for APP_CONTAINER_NAME in the nginx config</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">myregistry/myapp:1.0.0</span> <span class="c1"># registry for your application image</span>
        <span class="na">ports</span><span class="pi">:</span> 
        <span class="pi">-</span> <span class="s2">"</span><span class="s">2368:2368"</span> <span class="c1"># port your app listens on (the EXPOSE port); the value for APP_EXPOSE_PORT in the nginx config</span>
        <span class="na">restart</span><span class="pi">:</span> <span class="s">always</span>
    
      <span class="na">nginx</span><span class="pi">:</span>
        <span class="na">depends_on</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">app</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">myregistry/my-nginx:latest</span> <span class="c1"># registry for your custom nginx with the nginx config</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s2">"</span><span class="s">0:80"</span> <span class="c1"># must be this mapping to route all traffic to the web app to nginx</span>
        <span class="na">restart</span><span class="pi">:</span> <span class="s">always</span>
    
      <span class="na">certbot</span><span class="pi">:</span>
        <span class="na">depends_on</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">nginx</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">myregistry/my-certbot:latest</span> <span class="c1"># registry for your custom certbot image</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s2">"</span><span class="s">80:80"</span> <span class="c1"># must be this mapping to respond to LetsEncrypt challenge</span>
        <span class="na">restart</span><span class="pi">:</span> <span class="s">always</span>
        <span class="na">volumes</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">${WEBAPP_STORAGE_HOME}/certbot/letsencrypt:/etc/letsencrypt</span> <span class="c1"># maps to persistent storage</span>


<span class="na">Notes</span><span class="pi">:</span>

<span class="pi">-</span> <span class="na">There are 3 containers</span><span class="pi">:</span> <span class="err">`</span><span class="s">app`, `nginx` and `certbot` (the names are important for the nginx config file)</span>
<span class="pi">-</span> <span class="s">The port mapping is important - nginx _must_ be on `0:80` so that it gets all traffic inbound from the web app. Certbot must be on `80:80` to correctly respond to the LetsEncrypt challenge. Finally, the app port should _not_ be 80 or 8080 - I could not get this to work if the app was using either of these ports.</span>
<span class="pi">-</span> <span class="s">The `certbot` image is mapping a volume for the `/etc/letsencrypt` folder - this is required to retain the cert if the container restarts; otherwise certbot will request a cert every time it starts, which isn't what we want.</span>

<span class="s">Let's now look at the `nginx.conf` file</span><span class="pi">:</span>

<span class="s">~~~nginx</span>

    <span class="s">user nginx;</span>
    <span class="s">worker_processes 1;</span>
    
    <span class="s">error_log /var/log/nginx/error.log warn;</span>
    <span class="s">pid /var/run/nginx.pid;</span>
    
    
    <span class="s">events {</span>
        <span class="s">worker_connections 1024;</span>
    <span class="s">}</span>
    
    <span class="s">http {</span>
        <span class="s">include /etc/nginx/mime.types;</span>
        <span class="s">default_type application/octet-stream;</span>
    
        <span class="s">log_format main '$remote_addr - $remote_user [$time_local] "$request" '</span>
                          <span class="s">'$status $body_bytes_sent "$http_referer" '</span>
                          <span class="s">'"$http_user_agent" "$http_x_forwarded_for"';</span>
    
        <span class="s">access_log /var/log/nginx/access.log main;</span>
        <span class="s">client_max_body_size 10M;</span>
    
        <span class="s">sendfile on;</span>
        <span class="s">#tcp_nopush on;</span>
    
        <span class="s">keepalive_timeout 65;</span>
    
        <span class="s">#gzip on;</span>
     
        <span class="s">server {</span>
            <span class="s">listen 80 default_server;</span>
            <span class="s">listen [::]:80 default_server;</span>
    
            <span class="s"># certbot challenge</span>
            <span class="s">location ~ /.well-known {</span>
                <span class="s">proxy_pass http://certbot;</span>
                <span class="s">proxy_redirect off;</span>
            <span class="s">}</span>
    
            <span class="s">location / {</span>
                <span class="s"># APP_EXPOSE_PORT is the port the app container exposes</span>    
                <span class="s">proxy_pass http://app:APP_EXPOSE_PORT;</span>  
                <span class="s">proxy_set_header Host $host;</span>
            <span class="s">}</span>
        <span class="s">}</span>
    <span class="s">}</span>

</code></pre></div></div><p>Notes:<ul><li>The server listens on port 80 (the SSL termination occurs at the Web App layer, so traffic coming in at this point is http)<li>The location <code class="language-plaintext highlighter-rouge">~ /.well-known</code> routes any route with <code class="language-plaintext highlighter-rouge">/.well-known</code> in the URL to certbot<li>Location <code class="language-plaintext highlighter-rouge">/</code> forwards all other requests to the app container - make sure you update this to match your app port. In my example compose file above, this would be 2368.</ul><p><strong>Note:</strong> I spent many hours debugging an infinte loop of redirects - I found that I had to ensure that none of the directives below were specified in the location rules. This is something to do with how Azure Web Apps handles incoming traffic.<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
    <span class="k">proxy_set_header</span> <span class="s">X-Forwarded-Proto</span> <span class="nv">$scheme</span><span class="p">;</span>
    <span class="k">proxy_set_header</span> <span class="s">X-Real-IP</span> <span class="nv">$remote_addr</span><span class="p">;</span>
    <span class="k">proxy_set_header</span> <span class="s">X-Forwarded-For</span> <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>

</code></pre></div></div><h2 id="certbot-customization">CertBot Customization</h2><p>To customize CertBot to handle certificate registration and renewal, I customized the <code class="language-plaintext highlighter-rouge">CMD</code> for the container to invoke this script:<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
    <span class="c">#!/bin/sh</span>
    
    <span class="nv">rsa_key_size</span><span class="o">=</span>4096
    <span class="k">if</span> <span class="o">[</span><span class="nt">-z</span> <span class="nv">$STAGING</span><span class="o">]</span> <span class="o">||</span> <span class="o">[</span><span class="nv">$STAGING</span> <span class="o">!=</span> <span class="s2">"0"</span><span class="o">]</span><span class="p">;</span> <span class="k">then </span><span class="nv">staging_arg</span><span class="o">=</span><span class="s2">"--staging"</span><span class="p">;</span> <span class="k">fi
    
    if</span> <span class="o">[</span><span class="nt">-z</span> <span class="nv">$EMAIL</span><span class="o">]</span> <span class="o">||</span> <span class="o">[</span><span class="nt">-z</span> <span class="nv">$CDN</span><span class="o">]</span><span class="p">;</span> <span class="k">then
      </span><span class="nb">echo</span> <span class="s2">"Please set email and CDN environment variables!"</span>
    <span class="k">else
        </span><span class="nv">wwwArg</span><span class="o">=</span><span class="s2">""</span>
        <span class="k">if</span> <span class="o">[</span><span class="nt">-z</span> <span class="nv">$WWW</span><span class="o">]</span> <span class="o">||</span> <span class="o">[</span><span class="nv">$WWW</span> <span class="o">!=</span> <span class="s2">"0"</span><span class="o">]</span><span class="p">;</span> <span class="k">then
          </span><span class="nb">echo</span> <span class="s2">"Adding www.</span><span class="nv">$CDN</span><span class="s2"> to registration"</span>
          <span class="nv">wwwArg</span><span class="o">=</span><span class="s2">"-d www.</span><span class="nv">$CDN</span><span class="s2">"</span> 
        <span class="k">fi
    
        if</span> <span class="o">[!</span> <span class="nt">-f</span> <span class="s2">"</span><span class="nv">$WORKING_PATH</span><span class="s2">/live/</span><span class="nv">$CDN</span><span class="s2">/fullchain.pem"</span><span class="o">]</span><span class="p">;</span> <span class="k">then
          </span><span class="nb">echo</span> <span class="s2">"Creating cert"</span>
          <span class="nb">echo</span> <span class="s2">"Staging arg: </span><span class="nv">$STAGING</span><span class="s2">"</span>
    
          certbot certonly <span class="nt">--standalone</span> <span class="se">\</span>
            <span class="nt">--preferred-challenges</span><span class="o">=</span>http <span class="se">\</span>
            <span class="nt">--email</span> <span class="nv">$EMAIL</span> <span class="se">\</span>
            <span class="nv">$staging_arg</span> <span class="se">\</span>
            <span class="nt">--agree-tos</span> <span class="se">\</span>
            <span class="nt">--no-eff-email</span> <span class="se">\</span>
            <span class="nt">--manual-public-ip-logging-ok</span> <span class="se">\</span>
            <span class="nt">--domain</span> <span class="nv">$CDN</span> <span class="nv">$wwwArg</span>
          
          <span class="c"># run the script to register the cert with web apps</span>
          deploy-cert-az-webapp.sh
        <span class="k">fi
    
        </span><span class="nb">timeout</span><span class="o">=</span><span class="s2">"12h"</span>
        <span class="k">if</span> <span class="o">[!</span> <span class="nt">-z</span> <span class="nv">$DEBUG</span><span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span><span class="nv">$DEBUG</span> <span class="o">==</span> <span class="s2">"TRUE"</span><span class="o">]</span><span class="p">;</span> <span class="k">then
          </span><span class="nb">timeout</span><span class="o">=</span><span class="s2">"30s"</span>
        <span class="k">fi</span>
    
        <span class="c"># loop infinitely and check for cert renewal every 12 hours</span>
        <span class="c"># if the cert does not need renewing, certbot does nothing</span>
        <span class="c"># after renewal, the deploy-cert-az-webapp.sh should fire to</span>
        <span class="c"># register the renewed cert</span>
        <span class="nb">trap exit </span>TERM<span class="p">;</span> <span class="k">while</span> :<span class="p">;</span> <span class="k">do </span>certbot renew <span class="nt">--post-hook</span> <span class="s2">"deploy-cert-az-webapp.sh"</span><span class="p">;</span> <span class="nb">sleep</span> <span class="nv">$timeout</span> &amp; <span class="nb">wait</span> <span class="nv">$!</span><span class="p">;</span> <span class="k">done</span><span class="p">;</span>
    <span class="k">fi</span>

</code></pre></div></div><p>Notes:<ul><li>The script runs of environment variables like <code class="language-plaintext highlighter-rouge">$CDN</code> etc.<li>Line 4: If staging (for test certificates) is set, <code class="language-plaintext highlighter-rouge">--staging</code> is added to the registration call<li>Line 10: If you want to register <code class="language-plaintext highlighter-rouge">$CDN</code> and <code class="language-plaintext highlighter-rouge">www.$CDN</code> then you set <code class="language-plaintext highlighter-rouge">WWW</code> to 1. In my case, my CDN is <code class="language-plaintext highlighter-rouge">colinsalmcorner.com</code> and I wanted <code class="language-plaintext highlighter-rouge">www.colinsalmcorner.com</code> to be registered too, so I set <code class="language-plaintext highlighter-rouge">WWW</code> to 1. Subdomains like <code class="language-plaintext highlighter-rouge">blog.colinsalmcorner.com</code> should obviously set <code class="language-plaintext highlighter-rouge">WWW</code> to 0<li>Line 15: Check if the cert exists, and make a registration request if it does not. This is why the persistent storage (the <code class="language-plaintext highlighter-rouge">${WEBAPP_STORAGE_HOME}</code> volume mapping) on the certbot image is so important.<li>Lines 19-26: Register a request for a cert from LetsEncrypt. At this point, certbot will listen for the challenge from LetsEncrypt to <code class="language-plaintext highlighter-rouge">http://$CDN/.well-known/challenge/{some_random_goop}</code>which means that the DNS should be pointing to the Azure Web App and the custom domain registered on the Web App.<li>Line 29: invoke the script to register the cert with the Web App<li>Line 41: Loop forever, calling <code class="language-plaintext highlighter-rouge">cerbot renew</code> every 12 hours. If the cert is not due for renewal, this ends as a no-op. If the cert(s) are renewed, the register script is invoked right after the renewal completes.</ul><p>Here’s the script to register the cert with Azure Web Apps:<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
    <span class="c">#!/bin/sh</span>
    
    <span class="nv">certPath</span><span class="o">=</span><span class="s2">"</span><span class="nv">$WORKING_PATH</span><span class="s2">/live/</span><span class="nv">$CDN</span><span class="s2">"</span>
    
    <span class="k">if</span> <span class="o">[!</span> <span class="nt">-f</span> <span class="s2">"</span><span class="nv">$WORKING_PATH</span><span class="s2">/live/</span><span class="nv">$CDN</span><span class="s2">/fullchain.pem"</span><span class="o">]</span><span class="p">;</span> <span class="k">then
      </span><span class="nb">echo</span> <span class="s2">"ERROR: </span><span class="nv">$WORKING_PATH</span><span class="s2">/live/</span><span class="nv">$CDN</span><span class="s2">/fullchain.pem does not exist"</span>
      <span class="nb">exit </span>1
    <span class="k">fi</span>
    
    <span class="c"># convert pem to pfx for azure web app</span>
    <span class="nb">echo</span> <span class="s2">"Converting pem to pfx"</span>
    openssl pkcs12 <span class="se">\</span>
        <span class="nt">-password</span> pass:<span class="nv">$PFX_PASSWORD</span> <span class="se">\</span>
        <span class="nt">-inkey</span> <span class="nv">$certPath</span>/privkey.pem <span class="se">\</span>
        <span class="nt">-in</span> <span class="nv">$certPath</span>/cert.pem <span class="se">\</span>
        <span class="nt">-export</span> <span class="nt">-out</span> <span class="nv">$certPath</span>/cert.pfx
    
    <span class="c"># upload and get the thumbprint</span>
    <span class="k">if</span> <span class="o">[!</span> <span class="nt">-z</span> <span class="nv">$DEBUG</span><span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span><span class="nv">$DEBUG</span> <span class="o">!=</span> <span class="s2">"TRUE"</span><span class="o">]</span><span class="p">;</span> <span class="k">then
        </span><span class="nb">echo</span> <span class="s2">"DEBUG:: Running pfx upload and bind cert commands here"</span>
        <span class="nb">echo</span> <span class="s2">"DEBUG:: WebApp: </span><span class="nv">$WEB_APP_NAME</span><span class="s2">"</span>
        <span class="nb">echo</span> <span class="s2">"DEBUG:: Resource </span><span class="nv">$RESOURCE_GROUP</span><span class="s2">"</span>
        <span class="nb">echo</span> <span class="s2">"Contents of </span><span class="nv">$certPath</span><span class="s2">"</span>
        <span class="nb">ls</span> <span class="nt">-la</span> <span class="nv">$certPath</span>
        
    <span class="k">else
        </span><span class="nb">echo</span> <span class="s2">"Running az login"</span>
        az login <span class="nt">--service-principal</span> <span class="nt">-u</span> <span class="nv">$AZ_CLIENT_ID</span> <span class="nt">-p</span> <span class="nv">$AZ_CLIENT_KEY</span> <span class="nt">--tenant</span> <span class="nv">$AZ_TENANT_ID</span>
    
        <span class="nb">echo</span> <span class="s2">"Upload </span><span class="nv">$certPath</span><span class="s2">/cert.pfx to </span><span class="nv">$WEB_APP_NAME</span><span class="s2"> in </span><span class="nv">$RESOURCE_GROUP</span><span class="s2"> and get thumbprint"</span>
        <span class="nv">thumbprint</span><span class="o">=</span><span class="si">$(</span>az webapp config ssl upload <span class="nt">--certificate-file</span> <span class="nv">$certPath</span>/cert.pfx <span class="se">\</span>
                    <span class="nt">--certificate-password</span> <span class="nv">$PFX_PASSWORD</span> <span class="se">\</span>
                    <span class="nt">--name</span> <span class="nv">$WEB_APP_NAME</span> <span class="nt">--resource-group</span> <span class="nv">$RESOURCE_GROUP</span> <span class="se">\</span>
                    <span class="nt">--query</span> thumbprint <span class="nt">--output</span> tsv<span class="si">)</span>
        
        <span class="c"># bind using the thumbprint</span>
        <span class="nb">echo</span> <span class="s2">"Bind cert"</span>
        az webapp config ssl <span class="nb">bind</span> <span class="se">\</span>
            <span class="nt">--certificate-thumbprint</span> <span class="nv">$thumbprint</span> <span class="se">\</span>
            <span class="nt">--ssl-type</span> SNI <span class="se">\</span>
            <span class="nt">--name</span> <span class="nv">$WEB_APP_NAME</span> <span class="nt">--resource-group</span> <span class="nv">$RESOURCE_GROUP</span>
    <span class="k">fi
    
    </span><span class="nb">echo</span> <span class="s2">"Done!"</span>

</code></pre></div></div><p>Notes:<ul><li>The script first converts the <code class="language-plaintext highlighter-rouge">pem</code> to a <code class="language-plaintext highlighter-rouge">pfx</code> using a password<li>After that it uses <code class="language-plaintext highlighter-rouge">az cli</code> to login, upload the cert and bind the custom domain to the newly uploaded cert</ul><h2 id="wrapping-up">Wrapping Up</h2><p>You can find all the steps and configuration settings you need to configure for this to work in the <a href="https://github.com/colindembovsky/webapp-linux-letsencrypt-auto-renew#steps">readme</a>. There’s also <a href="https://github.com/colindembovsky/webapp-linux-letsencrypt-auto-renew/blob/master/sample-web-app-creation.sh">this script</a> that shows how I spin up the site, configure the custom domain, upload the compose configuration, update the registry settings and then app settings and finally hit the site to start it. You should be able to get it going pretty quickly from here on!<p>Happy securing!</article><hr class="dingbat related mb6" /><aside class="comments related" role="complementary"><h2 class="hr-bottom">Comments</h2><div id="giscus"><div></div></div><script> function toggle_giscus() { const c = document.body.classList; const dark = c.contains("dark-mode") || "_sunset" in window && !c.contains("light-mode") && matchMedia("(prefers-color-scheme: dark)").matches; const theme = dark ? "dark" : "light"; const scriptEl = document.createElement("script"); scriptEl.src = "https://giscus.app/client.js"; scriptEl.setAttribute("data-repo", "colindembovsky/colindembovsky.github.io"); scriptEl.setAttribute("data-repo-id", "MDEwOlJlcG9zaXRvcnk0MDczMjI3MjU="); scriptEl.setAttribute("data-category", "Giscussions"); scriptEl.setAttribute("data-category-id", "DIC_kwDOGEdAZc4B_F18"); scriptEl.setAttribute("data-mapping", "pathname"); scriptEl.setAttribute("data-reactions-enabled", "1"); scriptEl.setAttribute("data-emit-metadata", "colindembovsky/colindembovsky.github.io"); scriptEl.setAttribute("data-theme", theme); scriptEl.setAttribute("crossorigin", "anonymous"); const container = document.getElementById("giscus"); const old = container.firstElementChild; container.removeChild(old); container.appendChild(scriptEl); } document.addEventListener("hydejack-dark-mode-toggle", function() { toggle_giscus(); }); toggle_giscus(); </script></aside><aside class="related mb4" role="complementary"><h2 class="hr-bottom">Random Posts</h2><ul class="related-posts"><li class="h4"> <a href="/pages/colindembovsky/powershell-dsc-remotely-configuring-a-node-to-rebootnodeifneeded/" class="flip-title"><span>PowerShell DSC: Remotely Configuring a Node to “RebootNodeIfNeeded”</span></a> <time class="faded fine" datetime="2014-06-26T16:35:19+00:00">26 Jun 2014</time><li class="h4"> <a href="/pages/colindembovsky/code-coverage-doesnt-work-with-fakes-on-hosted-build/" class="flip-title"><span>Code Coverage doesn’t work with Fakes on Hosted Build</span></a> <time class="faded fine" datetime="2012-07-13T19:01:00+00:00">13 Jul 2012</time><li class="h4"> <a href="/pages/colindembovsky/a-day-of-devops-release-management-software-quality-and-agile-project-requirements-management/" class="flip-title"><span>A Day of DevOps, Release Management, Software Quality and Agile Project Requirements Management</span></a> <time class="faded fine" datetime="2014-09-03T14:43:22+00:00">03 Sep 2014</time></ul></aside><footer class="content" role="contentinfo"><hr/><p><small class="copyright">© 2021. All rights reserved. </small><hr class="sr-only"/></footer></main><hy-drawer id="_drawer" class="" side="left" threshold="10" noscroll ><header id="_sidebar" class="sidebar" role="banner"><div class="sidebar-bg sidebar-overlay" style="background-color:rgb(5,19,24);background-image:url(/pages/colindembovsky/assets/img/sidebar-bg.jpg)"></div><div class="sidebar-sticky"><div class="sidebar-about"> <a class="no-hover" href="/pages/colindembovsky/" tabindex="-1"> <img src="/pages/colindembovsky/assets/img/logo.png" class="avatar" alt="Colin's ALM Corner" width="120" height="120" loading="lazy" /> </a> <a class="sidebar-title" href="/pages/colindembovsky/"><h2 class="h1">Colin's ALM Corner</h2></a><p class=""> DevOpsology &amp; GitHub. <br /> <em>Opinions my own</em>.</div><nav class="sidebar-nav heading" role="navigation"> <span class="sr-only">Navigation:</span><ul><li> <a id="_drawer--opened" href="/pages/colindembovsky/tags/" class="sidebar-nav-item " > Tags </a><li> <a href="/pages/colindembovsky/about/" class="sidebar-nav-item " > About </a></ul></nav><div class="sidebar-social"> <span class="sr-only">Social:</span><ul><li> <a href="https://twitter.com/colindembovsky" title="Twitter" class="no-mark-external"> <span class="icon-twitter"></span> <span class="sr-only">Twitter</span> </a><li> <a href="https://github.com/colindembovsky" title="GitHub" class="no-mark-external"> <span class="icon-github"></span> <span class="sr-only">GitHub</span> </a><li> <a href="https://colinsalmcorner.com/feed.xml" title="RSS" class="no-mark-external"> <span class="icon-rss2"></span> <span class="sr-only">RSS</span> </a></ul></div></div></header></hy-drawer><hr class="sr-only" hidden /> </hy-push-state> <!--[if gt IE 10]><!----> <script nomodule>!function(){var t,n=document.createElement("script");!("noModule"in n)&&"onbeforeload"in n&&(t=!1,document.addEventListener("beforeload",function(e){if(e.target===n)t=!0;else if(!e.target.hasAttribute("nomodule")||!t)return;e.preventDefault()},!0),n.type="module",n.src=".",document.head.appendChild(n),n.remove())}(); </script> <script src="/pages/colindembovsky/assets/js/hydejack-9.1.4.js" type="module"></script> <script src="/pages/colindembovsky/assets/js/LEGACY-hydejack-9.1.4.js" nomodule defer></script> <script type="module"> if ('serviceWorker' in navigator) { /**/ navigator.serviceWorker.getRegistration() .then(r => r.unregister()) .catch(() => {}); /**/ } </script> <!--<![endif]--><div hidden><h2 class="sr-only">Templates (for web app):</h2><clap-config> <clap-text at="1">Keep going!</clap-text> <clap-text at="2">Keep going ×2!</clap-text> <clap-text at="3">Give me more!</clap-text> <clap-text at="5">Thank you, thank you</clap-text> <clap-text at="7">Far too kind!</clap-text> <clap-text at="10">Never gonna give me up?</clap-text> <clap-text at="14">Never gonna let me down?</clap-text> <clap-text at="20">Turn around and desert me!</clap-text> <clap-text at="30">You're an addict!</clap-text> <clap-text at="40">Son of a clapper!</clap-text> <clap-text at="50">No way</clap-text> <clap-text at="60">Go back to work!</clap-text> <clap-text at="70">This is getting out of <em>hand</em></clap-text> <clap-text at="80">Unbelievable</clap-text> <clap-text at="90">PREPOSTEROUS</clap-text> <clap-text at="100">I N S A N I T Y</clap-text> <clap-text at="185"><span style="font-family:monospace">FEED ME A STRAY CAT</span></clap-text> </clap-config> <template id="_animation-template"><div class="animation-main fixed-top"><nav id="breadcrumbs" class="screen-only"><ul></ul></nav><div class="content"><div class="page"></div></div></div></template> <template id="_loading-template"><div class="loading nav-btn fr"> <span class="sr-only">Loading…</span> <span class="icon-cog"></span></div></template> <template id="_error-template"><div class="page"><h1 class="page-title">Error</h1><p class="lead"> Sorry, an error occurred while loading <a class="this-link" href=""></a>.</div></template> <template id="_permalink-template"> <a href="#" class="permalink"> <span class="sr-only">Permalink</span> <span class="content-hash"></span> </a> </template> <template id="_cookies-banner-template"><div id="_cookies-banner" class="navbar fixed-bottom CookiesOK"><div class="content"><div class="nav-btn-bar"> <small class="faded"> <span>This site uses cookies. <a href="/cookies-policy/">Cookies Policy</a>. </span> <button id="_cookies-ok" class="btn btn-primary btn-sm">Okay</button> </small></div></div></div></template> <template id="_dark-mode-template"> <button id="_dark-mode" class="nav-btn no-hover" > <span class="sr-only">Dark Mode</span> <span class="icon-brightness-contrast"></span> </button> </template> <template id="_search-template"> <button id="_search" class="nav-btn no-hover"> <label class="sr-only" for="_search-input">Search</label> <span class="icon-search"></span> </button><div id="_search-box"><div class="nav-btn"> <span class="icon-search"></span></div><input id="_search-input" type="search" class="form-control form-control-lg nav-btn" placeholder="Type something…" /> <button type="reset" class="nav-btn no-hover"> <span class="sr-only">Close</span> <span class="icon-cross"></span> </button></div><div id="_hits"></div></template></div></html>
