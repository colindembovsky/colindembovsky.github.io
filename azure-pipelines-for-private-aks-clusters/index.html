<!DOCTYPE html>
<html lang="en"><head><title>Azure Pipelines for Private AKS Clusters | Colin’s ALM Corner</title><meta name="generator" content="Jekyll v3.9.0" /><meta property="og:title" content="Azure Pipelines for Private AKS Clusters" /><meta name="author" content="Colin Dembovsky" /><meta property="og:locale" content="en" /><meta name="description" content="Creating private AKS clusters is a good step in hardening your Azure Kubernetes clusters. In this post I walk through the steps you’ll need to follow to enable deployment to private AKS clusters." /><meta property="og:description" content="Creating private AKS clusters is a good step in hardening your Azure Kubernetes clusters. In this post I walk through the steps you’ll need to follow to enable deployment to private AKS clusters." /><link rel="canonical" href="https://github.com/pages/colindembovsky/azure-pipelines-for-private-aks-clusters/" /><meta property="og:url" content="https://github.com/pages/colindembovsky/azure-pipelines-for-private-aks-clusters/" /><meta property="og:site_name" content="Colin’s ALM Corner" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-10-27T19:25:25+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Azure Pipelines for Private AKS Clusters" /><meta name="twitter:site" content="@colindembovsky" /><meta name="twitter:creator" content="@colindembovsky" /> <script type="application/ld+json"> {"description":"Creating private AKS clusters is a good step in hardening your Azure Kubernetes clusters. In this post I walk through the steps you’ll need to follow to enable deployment to private AKS clusters.","url":"https://github.com/pages/colindembovsky/azure-pipelines-for-private-aks-clusters/","@type":"BlogPosting","headline":"Azure Pipelines for Private AKS Clusters","dateModified":"2020-10-27T19:25:25+00:00","datePublished":"2020-10-27T19:25:25+00:00","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://github.com/pages/colindembovsky/assets/img/logo.png"},"name":"Colin Dembovsky"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://github.com/pages/colindembovsky/azure-pipelines-for-private-aks-clusters/"},"author":{"@type":"Person","name":"Colin Dembovsky"},"@context":"https://schema.org"}</script><meta name="keywords" content="devops,github,actions,build,ci,cd"><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Colin's ALM Corner"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="application-name" content="Colin's ALM Corner"><meta name="theme-color" content="rgb(5,19,24)"><meta name="generator" content="Hydejack v9.1.4" /><link rel="alternate" href="https://github.com/pages/colindembovsky/azure-pipelines-for-private-aks-clusters/" hreflang="en"><link type="application/atom+xml" rel="alternate" href="https://github.com/pages/colindembovsky/feed.xml" title="Colin's ALM Corner" /><link rel="shortcut icon" href="/pages/colindembovsky/assets/icons/favicon.ico"><link rel="apple-touch-icon" href="/pages/colindembovsky/assets/icons/icon-192x192.png"><link rel="manifest" href="/pages/colindembovsky/assets/site.webmanifest"><link rel="dns-prefetch" href="https://fonts.googleapis.com"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preload" href="/pages/colindembovsky/assets/img/swipe.svg" as="image" id="_hrefSwipeSVG"><link rel="dns-prefetch" href="/pages/colindembovsky/assets/js/search-worker-9.1.4.js" as="worker" id="_hrefSearch"> <script>!function(r,c){"use strict";function a(e,t,n,o){e.addEventListener?e.addEventListener(t,n,o):e.attachEvent?e.attachEvent("on"+t,n):e["on"+t]=n}r.loadJS=function(e,t){var n=c.createElement("script");n.src=e,t&&a(n,"load",t,{once:!0});t=c.scripts[0];return t.parentNode.insertBefore(n,t),n},r._loaded=!1,r.loadJSDeferred=function(e,t){var n=c.createElement("script");function o(){r._loaded=!0,t&&a(n,"load",t,{once:!0});var e=c.scripts[0];e.parentNode.insertBefore(n,e)}return n.src=e,r._loaded?o():a(r,"load",o,{once:!0}),n},r.setRel=r.setRelStylesheet=function(e){a(c.getElementById(e),"load",function(){this.rel="stylesheet"},{once:!0})}}(window,document); !function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this); !function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this); !function(w) { w._baseURL = '/pages/colindembovsky/'; w._publicPath = '/pages/colindembovsky/assets/js/'; w._noPushState = false; w._noDrawer = false; w._noNavbar = false; w._noToc = false; w._noSearch = false; w._advertise = false; w._search = { DATA_URL: '/pages/colindembovsky/assets/sitedata.json?no-cache', STORAGE_KEY: 'mini-search/pages/colindembovsky/', INDEX_KEY: 'index--2021-11-18T20:23:33+00:00', }; w._clapButton = false; }(window);</script> <script async src="/pages/colindembovsky/assets/bower_components/MathJax/es5/tex-mml-chtml.js" id="_MathJax"></script> <!--[if gt IE 8]><!----><style id="_styleInline"> .clearfix,.sidebar-social::after{content:"";display:table;clear:both}.color-transition,body,p,hr,.hr,.hr-after::after,.hr-bottom,.message,.note-sm,.note,#markdown-toc,.navbar,.nav-btn-bar,.nav-btn,.content .avatar{transition:none}#_dark-mode{font-size:1.25rem}@media screen{body.light-mode{--body-color: #333;--body-bg: #fff;--border-color: #ebebeb;--gray: #777;--gray-bg: rgba(0,0,0,0.025);--gray-text: #666;--menu-text: #bbb;--inv-body-color: #ccc;--inv-body-bg: var(--dark-mode-body-bg)}body.light-mode .content{-webkit-font-smoothing:initial;-moz-osx-font-smoothing:initial}body.dark-mode{--body-color: #ccc;--body-bg: var(--dark-mode-body-bg);--border-color: var(--dark-mode-border-color);--gray: rgba(255,255,255,.5);--gray-bg: rgba(255,255,255,.033);--gray-text: rgba(255,255,255,.625);--menu-text: rgba(255,255,255,.25);--inv-body-color: #333;--inv-body-bg: #fff}body.dark-mode .content{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}}@media screen and (prefers-color-scheme: dark){body{--body-color: #ccc;--body-bg: var(--dark-mode-body-bg);--border-color: var(--dark-mode-border-color);--gray: rgba(255,255,255,.5);--gray-bg: rgba(255,255,255,.033);--gray-text: rgba(255,255,255,.625);--menu-text: rgba(255,255,255,.25);--inv-body-color: #333;--inv-body-bg: #fff}body .content{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.tippy-content{-webkit-font-smoothing:initial;-moz-osx-font-smoothing:initial}}html{--font-family: Noto Sans,Helvetica,Arial,sans-serif;--font-family-heading: Roboto Slab,Helvetica,Arial,sans-serif;--code-font-family: Fira Code,Menlo,Monaco,Consolas,monospace;--body-color: #333;--body-bg: #fff;--border-color: #ebebeb;--gray: #777;--gray-bg: rgba(0,0,0,0.025);--gray-text: #666;--menu-text: #bbb;--inv-body-color: #ccc;--inv-body-bg: var(--dark-mode-body-bg);--root-font-size: 15px;--root-font-size-medium: 16px;--root-font-size-large: 17px;--root-font-size-print: 8pt;--root-line-height: 1.75;--font-weight: 400;--font-weight-bold: 700;--font-weight-heading: 700;--content-width-5: 54rem;--content-margin-5: 4rem;--sidebar-width: 21rem;--half-content: 31rem;--break-point-3: 64em;--break-point-5: 86em;--break-point-dynamic: 1664px}html .content{-webkit-font-smoothing:initial;-moz-osx-font-smoothing:initial}*{box-sizing:border-box}html,body{margin:0;padding:0}html{font-family:var(--font-family);font-size:var(--root-font-size);line-height:var(--root-line-height)}body{color:var(--body-color);background-color:var(--body-bg);font-weight:var(--font-weight);overflow-y:scroll}.content img,.img,.content video,.video{max-width:100%;height:auto}.lead{margin-left:-1rem;margin-right:-1rem;margin-bottom:1.5rem}img.lead,video.lead{display:block;max-width:calc(100% + 2rem);width:calc(100% + 2rem);height:auto}.heading,.f1,h1,.h1,.f2,h2,.h2,.f3,h3,.h3,.f4,h4,.h4,.post-date,.sidebar-nav-item,.f5,h5,.h5,.f6,h6,.h6{font-family:var(--font-family-heading);font-weight:var(--font-weight-heading)}.f1,h1,.h1{font-size:2rem;line-height:1.3}.f2,h2,.h2{font-size:1.5rem;line-height:1.4}.f3,h3,.h3{font-size:1.2em;line-height:1.5}.f4,h4,.h4,.post-date,.sidebar-nav-item{font-size:1.08rem;line-height:1.6}.f5,h5,.h5{font-size:1.04rem;line-height:1.7}.f6,h6,.h6{font-size:1rem}.content h1>a,.content .h1>a{text-decoration:none;border-bottom:none}@media screen and (max-width: 42em){.content h1,.content .h1{font-size:1.7rem;line-height:1.35}}@media screen and (min-width: 86em){.content h1,.content .h1{font-size:2.4rem;line-height:1.25}}@media screen and (min-width: 1664px){body:not(.no-large-headings) .content h1,body:not(.no-large-headings) .content .h1{width:calc(100% + 50vw - 32rem);font-size:3rem;line-height:1.2}}@media screen and (min-width: 124em){body:not(.no-large-headings) .content h1,body:not(.no-large-headings) .content .h1{font-size:4rem;line-height:1.1}}h1,h2,h3,.h1,.h2,.h3{margin:4rem 0 1rem}h4,h5,h6,.h4,.post-date,.h5,.h6{margin:3rem 0 .5rem}p{margin-top:0;margin-bottom:1rem}p.lead{font-size:1.2em;margin-top:1.5rem;margin-bottom:1.5rem;padding:0 1rem}ul,ol,dl{margin-top:0;margin-bottom:1rem}ul,ol{padding-left:1.25rem}hr,.hr{border:0;margin:1rem 0;border-top:1px solid var(--border-color)}.hr-after::after{content:"";display:block;margin:1rem 0;border-top:1px solid var(--border-color)}.hr-bottom{border-bottom:1px solid var(--border-color);padding-bottom:.75rem;margin-bottom:1rem}.page{margin-bottom:3em}.page li+li{margin-top:.25rem}.page>header{position:relative;margin-bottom:1.5rem}@media screen and (min-width: 1664px){body:not(.no-third-column) .page>header>.lead+.note-sm,body:not(.no-third-column) .page>header>.lead+.note,body:not(.no-third-column) .page>header>.lead+#markdown-toc,body:not(.no-third-column) .page>header>a.no-hover+.note-sm,body:not(.no-third-column) .page>header>a.no-hover+.note,body:not(.no-third-column) .page>header>a.no-hover+#markdown-toc{position:absolute;right:-25rem;width:21rem;bottom:0;margin-bottom:0}}.page-title,.post-title{margin-top:0}.post-date{display:flex;justify-content:space-between;margin-top:-.6rem;height:2rem;margin-bottom:.85rem;color:var(--gray)}.post-date>.ellipsis,#breadcrumbs.post-date>ul{cursor:pointer}.post-date [class^="icon-"]{display:inline-block;font-size:smaller;margin-right:.25rem}.related-posts{padding-left:0;list-style:none;margin-bottom:2rem}.related-posts>li,.related-posts>li+li{margin-top:1rem}.message,.note-sm,.note,#markdown-toc{margin-bottom:1rem;padding:1rem;color:var(--gray-text);background-color:var(--gray-bg);margin-left:-1rem;margin-right:-1rem}.note-sm,.note,#markdown-toc{background:transparent;color:var(--body-color);font-size:smaller;border-left:1px solid var(--border-color);padding:1.2rem 1rem 0 1rem;margin:1rem -1rem;position:relative}.note-sm:before,.note:before,#markdown-toc:before{font-size:0.667rem;font-weight:bold;font-style:normal;letter-spacing:.025rem;text-transform:uppercase;color:var(--menu-text);position:absolute;top:0}.note-sm[title]:before,[title].note:before,[title]#markdown-toc:before{content:attr(title) !important}.note{font-size:1rem}@media screen{body::before{content:'';width:.5rem;background:var(--gray-bg);position:fixed;left:0;top:0;bottom:0}}@media (min-width: 64em){body::before{width:21rem}}@media (min-width: 1664px){body::before{width:calc(50% - 31rem)}}@media screen and (min-width: 42em){html{font-size:var(--root-font-size-medium)}}@media screen and (min-width: 124em){html{font-size:var(--root-font-size-large)}}#breadcrumbs>ul{height:1rem;margin:-1.5rem 0 .5rem;padding:0;font-size:.667rem;color:var(--menu-text);text-transform:uppercase;width:100%;list-style:none}#breadcrumbs>ul>li{display:inline}#breadcrumbs>ul>li a{color:var(--gray);text-decoration:none;border-bottom:none}.fl{float:left}.fr{float:right}.mb4{margin-bottom:4rem}.mb6{margin-bottom:6rem}.mt0{margin-top:0}.mt1{margin-top:1rem}.mt2{margin-top:2rem}.mt3{margin-top:3rem}.mt4{margin-top:4rem}.pb0{padding-bottom:0}.ml1{margin-left:1rem}.mr1{margin-right:1rem}.sixteen-nine{position:relative}.sixteen-nine::before{display:block;content:"";width:100%;padding-top:56.25%}.sixteen-nine>*{position:absolute;top:0;left:0;right:0;bottom:0}.sixteen-ten{position:relative}.sixteen-ten::before{display:block;content:"";width:100%;padding-top:62.5%}.sixteen-ten>*{position:absolute;top:0;left:0;right:0;bottom:0}.four-three{position:relative}.four-three::before{display:block;content:"";width:100%;padding-top:75%}.four-three>*{position:absolute;top:0;left:0;right:0;bottom:0}.sr-only{display:none}.larger{font-size:larger}.smaller{font-size:smaller}.clearfix,.sidebar-social::after{content:"";display:table;clear:both}.ellipsis,#breadcrumbs>ul{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.border{border:1px solid var(--border-color)}@media (min-width: 42em){.border-radius,.lead,.page .aspect-ratio.sixteen-nine.lead{border-radius:.5rem}}.fallback-img{background-position:center;background-repeat:no-repeat;background-image:url("data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4KPHN2ZyB3aWR0aD0iMTYwIiBoZWlnaHQ9IjkwIiB2aWV3Qm94PSIwIDAgMTYwIDkwIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgogIDxnIHRyYW5zZm9ybT0ibWF0cml4KDAuMDQ4ODI4LCAwLCAwLCAwLjA0Nzk5MSwgNTQuOTk5OTczLCAyMC40MjgxNDgpIj4KICAgIDxwYXRoIHN0eWxlPSJmaWxsOnJnYmEoMTI4LDEyOCwxMjgsLjMzKSIgZD0iTTk1OS44ODQgMTI4YzAuMDQwIDAuMDM0IDAuMDgyIDAuMDc2IDAuMTE2IDAuMTE2djc2Ny43N2MtMC4wMzQgMC4wNDAtMC4wNzYgMC4wODItMC4xMTYgMC4xMTZoLTg5NS43N2MtMC4wNDAtMC4wMzQtMC4wODItMC4wNzYtMC4xMTQtMC4xMTZ2LTc2Ny43NzJjMC4wMzQtMC4wNDAgMC4wNzYtMC4wODIgMC4xMTQtMC4xMTRoODk1Ljc3ek05NjAgNjRoLTg5NmMtMzUuMiAwLTY0IDI4LjgtNjQgNjR2NzY4YzAgMzUuMiAyOC44IDY0IDY0IDY0aDg5NmMzNS4yIDAgNjQtMjguOCA2NC02NHYtNzY4YzAtMzUuMi0yOC44LTY0LTY0LTY0djB6Ii8+CiAgICA8cGF0aCBzdHlsZT0iZmlsbDpyZ2JhKDEyOCwxMjgsMTI4LC4zMykiIGQ9Ik04MzIgMjg4YzAgNTMuMDIwLTQyLjk4IDk2LTk2IDk2cy05Ni00Mi45OC05Ni05NiA0Mi45OC05NiA5Ni05NiA5NiA0Mi45OCA5NiA5NnoiLz4KICAgIDxwYXRoIHN0eWxlPSJmaWxsOnJnYmEoMTI4LDEyOCwxMjgsLjMzKSIgZD0iTTg5NiA4MzJoLTc2OHYtMTI4bDIyNC0zODQgMjU2IDMyMGg2NGwyMjQtMTkyeiIvPgogIDwvZz4KPC9zdmc+")}hy-push-state a{color:var(--body-color)}@supports not ((text-decoration-thickness: initial) and (text-underline-offset: initial)){hy-push-state a{text-decoration:none;border-bottom:2px solid}}@supports (text-decoration-thickness: initial) and (text-underline-offset: initial){hy-push-state a{text-decoration-style:solid;text-underline-offset:.35rem;text-decoration-thickness:2px}}hy-push-state a.no-hover{border-bottom:none;text-decoration-thickness:unset;text-underline-offset:unset}.content a:not(.btn):not(.no-hover){border-color:var(--accent-color-faded)}@supports (text-decoration-thickness: initial) and (text-underline-offset: initial){.content a:not(.btn):not(.no-hover){text-decoration-color:var(--accent-color-faded)}}.content .aspect-ratio{overflow:hidden}.content .aspect-ratio img{margin:0;width:100%;height:100%;background-color:var(--gray-bg)}hy-drawer{width:100%;position:relative;overflow:hidden;display:block;z-index:4}@media screen and (min-width: 64em){hy-drawer{position:fixed;width:21rem;top:0;left:0;bottom:0;margin-left:0}hy-drawer.cover{position:relative;width:100%}}@media screen and (min-width: 1664px){hy-drawer{width:calc(50% - 31rem)}}.sidebar{position:relative;display:flex;justify-content:center;align-items:center;color:rgba(255,255,255,0.75);text-align:center;min-height:100vh}.sidebar.invert{color:rgba(32,32,32,0.75)}.sidebar a{color:#fff;border-bottom-color:rgba(255,255,255,0.2);text-decoration-color:rgba(255,255,255,0.2)}.sidebar.invert a{color:#222;border-bottom-color:rgba(32,32,32,0.2);text-decoration-color:rgba(32,32,32,0.2)}.sidebar-bg{position:absolute;top:0;left:calc(50% - 50vw);width:100vw;height:100%;background:#202020 center / cover}.sidebar-bg::after{content:"";position:absolute;top:0;left:0;bottom:0;right:0;background:rgba(0,0,0,0.05)}.sidebar-bg.sidebar-overlay::after{background:linear-gradient(to bottom, rgba(32,32,32,0) 0%, rgba(32,32,32,0.5) 50%, rgba(32,32,32,0) 100%)}.sidebar-sticky{position:relative;z-index:3;max-width:21rem;padding:1.5rem;contain:content}.sidebar-about .avatar{margin-bottom:1.5rem}.sidebar-about>a.sidebar-title{text-decoration:none}.sidebar-about>a.sidebar-title>h2{margin:0;padding-bottom:.5rem}.sidebar-about>a.sidebar-title::after{content:'';display:block;border-bottom:2px solid;margin:0 auto .5rem;width:4rem;border-color:rgba(255,255,255,0.2);transition:border-color 250ms}.sidebar-about>a.sidebar-title:hover::after{border-color:#fff;transition:border-color 50ms}.sidebar.invert .sidebar-about>a.sidebar-title::after{border-color:rgba(32,32,32,0.2)}.sidebar.invert .sidebar-about>a.sidebar-title:hover::after{border-color:#222}.sidebar-nav>ul{list-style:none;padding-left:0}.sidebar-nav-item{display:inline-block;margin-bottom:.5rem}@media (min-width: 64em){#_main.no-drawer #_menu{display:none}#_main.no-drawer .nav-btn-bar>:nth-child(2){border:none}}.sidebar-social>ul{display:inline-block;list-style:none;padding-left:0;margin-bottom:0}.sidebar-social>ul>li{float:left}.sidebar-social>ul>li>a{display:inline-block;text-align:center;font-size:1.4rem;width:3rem;height:4rem;padding:.5rem 0;line-height:3rem;text-decoration:none;border-bottom-width:2px;border-bottom-style:solid}.sidebar-social>ul li+li{margin-top:0}.fixed-common,.fixed-top,.fixed-bottom{position:fixed;left:0;width:100%;z-index:2}.fixed-top{top:0}.fixed-bottom{bottom:0}.navbar>.content{position:relative;padding-top:0;padding-bottom:0;min-height:0;max-height:5rem}.nav-btn-bar{margin:0 -1rem;background-color:white;background-color:var(--body-bg);height:5rem;display:flex;align-items:center;position:relative}.nav-btn-bar>:first-child,.nav-btn-bar>:last-child{border:none}.nav-btn{background:none;border:none;text-decoration:none;display:flex;align-items:center;justify-content:center;width:3.25rem;height:5rem;color:var(--menu-text);border-right:1px solid var(--border-color);border-left:1px solid var(--border-color);margin-left:-1px}#markdown-toc{margin:2rem -1rem 2rem calc(-1rem + 1px);padding-left:2.5rem;padding-bottom:.5rem}#markdown-toc:before{left:1rem}@media screen and (min-width: 1664px){body:not(.no-toc) #markdown-toc{position:absolute;z-index:4;width:20.5rem;right:0;margin:auto;overflow:auto}}@media screen and (min-width: 1664px){body.no-break-layout:not(.no-toc) #markdown-toc{width:calc(50% - 31rem)}}.content{margin-left:auto;margin-right:auto;padding:8rem 1rem 12rem}@media screen{.content{padding-left:1.5rem;min-height:100vh}}@media screen and (min-width: 42em){.content{max-width:42rem}}@media screen and (min-width: 54em){.content{max-width:48rem}}@media screen and (min-width: 64em){.content{padding-left:1rem;margin-left:24rem;margin-right:3rem}}@media screen and (min-width: 86em){.content{padding-top:9rem;margin-left:25rem;margin-right:4rem;max-width:54rem}}@media screen and (min-width: 1664px){.content{margin:auto}}.large-only{display:none}@media screen and (min-width: 1664px){.large-only{display:block}}.avatar{width:7rem;height:7rem;border-radius:100%;overflow:hidden;display:inline-block}.avatar img{width:100%}.content .avatar{float:right;box-sizing:content-box;border:1rem solid var(--body-bg);transition:border-color 1s ease;margin-top:-1.5rem;margin-right:-1rem}hr.dingbat{display:none}.center-image{margin:auto;display:block}.note:before{content:"Note"}.page>header>.note-sm:before,.page>header>.note:before,.page>header>#markdown-toc:before{content:"Description"}#markdown-toc:before{content:"Table of Contents"}.layout-resume .note-sm:before,.layout-resume .note:before,.layout-resume #markdown-toc:before{content:"Summary"} .clearfix,main:not(.layout-resume) .columns::after{content:"";display:table;clear:both}.color-transition,main:not(.layout-resume) .project-card{transition:none}main:not(.layout-resume) .columns{margin-left:-1rem;display:flex;flex-wrap:wrap;contain:content;padding-top:1rem;margin-top:1rem;padding-right:1rem;margin-right:-1rem}main:not(.layout-resume) .column{float:left;padding-left:1rem;margin-bottom:2rem;width:100%;display:flex}@media screen and (min-width: 42em){main:not(.layout-resume) .columns{margin-left:-2rem;margin-right:-2rem}main:not(.layout-resume) .column-1-2{width:50%}}@media screen and (min-width: 1664px){main:not(.layout-resume) .columns-break{width:calc(50vw + 25rem)}main:not(.layout-resume) .columns-break>.column-1-2,main:not(.layout-resume) .columns-break>.column-1{width:27.5rem}}@media print{main:not(.layout-resume) .columns{display:block}main:not(.layout-resume) .column{display:block;width:50%}}main:not(.layout-resume) .project-card{width:100%;color:var(--gray-text);background-color:var(--gray-bg);padding-bottom:1rem;position:relative;overflow:hidden;box-shadow:0.125rem 0.125rem 1rem rgba(0,0,0,0.2);contain:content;border-radius:.5rem;page-break-inside:avoid;transition:transform 500ms ease;will-change:transform}main:not(.layout-resume) .project-card:hover{transform:translateY(-0.25rem);transition:transform 250ms ease}main:not(.layout-resume) .project-card>a.flip-project{display:block}main:not(.layout-resume) .project-card>a.flip-project .project-card-img{margin-bottom:0}main:not(.layout-resume) .project-card>a.flip-project .project-card-img img{display:block;border-top-left-radius:.5rem;border-top-right-radius:.5rem}main:not(.layout-resume) .project-card a{position:relative;z-index:1}main:not(.layout-resume) .project-card a.fill-card{position:absolute;top:0;left:0;right:0;bottom:0;z-index:0}main:not(.layout-resume) .project-card>.project-card-title,main:not(.layout-resume) .project-card>.project-card-text{text-align:center;padding:0 1rem}main:not(.layout-resume) .project-card>.project-card-title{display:block;font-size:1.08rem;margin-top:.75rem;margin-bottom:.25rem;color:inherit}main:not(.layout-resume) .project-card>.project-card-text{margin:.25rem 0}main:not(.layout-resume) .column-1>.project-card>.project-card-title{font-size:1.2rem}main:not(.layout-resume) .column-1>.project-card>.project-card-text{font-size:1rem}</style><link rel="preload" as="style" href="/pages/colindembovsky/assets/css/hydejack-9.1.4.css" id="_stylePreload"><link rel="preload" as="style" href="/pages/colindembovsky/assets/icomoon/style.css" id="_iconsPreload"><link rel="preload" as="style" href="https://fonts.googleapis.com/css?family=Roboto+Slab:700%7CNoto+Sans:400,400i,700,700i&display=swap" id="_fontsPreload"> <script> setRel('_stylePreload'); setRel('_iconsPreload'); /**/setRel('_fontsPreload');/**/ </script> <noscript><link rel="stylesheet" href="/pages/colindembovsky/assets/css/hydejack-9.1.4.css"><link rel="stylesheet" href="/pages/colindembovsky/assets/icomoon/style.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Slab:700%7CNoto+Sans:400,400i,700,700i&display=swap"> </noscript><style id="_pageStyle"> html{--accent-color: rgb(79, 129, 220);--accent-color-faded: rgba(79,129,220,0.5);--accent-color-highlight: rgba(79,129,220,0.1);--accent-color-darkened: #2f6ad6;--theme-color: rgb(5,19,24);--dark-mode-body-bg: #292e30;--dark-mode-border-color: #353c3e}</style><!--<![endif]--> <script async src="https://www.googletagmanager.com/gtag/js?id=G-FD31RTDXK2"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-FD31RTDXK2'); </script><body class="no-break-layout"> <script> window._sunrise = 6; window._sunset = 18; !function(e,s){var d="light-mode",o="dark-mode",a=(new Date).getHours();"matchMedia"in e&&e.matchMedia("(prefers-color-scheme)")||(o=(e=a<=e._sunrise||a>=e._sunset?o:d)==o?d:o,s.body.classList.add(e),s.body.classList.remove(o))}(window,document); </script> <hy-push-state id="_pushState" replace-selector="#_main" link-selector="a[href]:not([href^='/pages/colindembovsky/assets/']):not(.external):not(.no-push-state)" script-selector="script" duration="500" hashchange ><div id="_navbar" class="navbar fixed-top"><div class="content"> <span class="sr-only">Jump to:</span><div class="nav-btn-bar"> <a id="_menu" class="nav-btn no-hover" href="#_drawer--opened"> <span class="sr-only">Navigation</span> <span class="icon-menu"></span> </a><div class="nav-span"></div></div></div></div><hr class="sr-only" hidden /><main id="_main" class="content layout-post" role="main" ><nav id="breadcrumbs" class="screen-only"><ul><li><a href="/pages/colindembovsky/">home</a><li> <span>/</span> <span>azure-pipelines-for-private-aks-clusters</span></ul></nav><article id="post-azure-pipelines-for-private-aks-clusters" class="page post mb6" role="article"><header><h1 class="post-title flip-project-title"> Azure Pipelines for Private AKS Clusters</h1><div class="post-date"> <span class="ellipsis mr1"> <time datetime="2020-10-27T19:25:25+00:00">27 Oct 2020</time> on <a href="/pages/colindembovsky/tag/build/" class="flip-title">build</a> </span></div><p class="note-sm" > Creating private AKS clusters is a good step in hardening your Azure Kubernetes clusters. In this post I walk through the steps you’ll need to follow to enable deployment to private AKS clusters.</header><ol id="markdown-toc"><li><a href="#private-agents" id="markdown-toc-private-agents">Private Agents</a><li><a href="#deploying-to-private-aks" id="markdown-toc-deploying-to-private-aks">Deploying to Private AKS</a><ol><li><a href="#create-a-generic-k8s-endpoint" id="markdown-toc-create-a-generic-k8s-endpoint">Create a Generic k8s Endpoint</a></ol><li><a href="#the-pipeline" id="markdown-toc-the-pipeline">The Pipeline</a><li><a href="#conclusion" id="markdown-toc-conclusion">Conclusion</a></ol><p><a href="https://docs.microsoft.com/en-us/azure/aks/">Azure Kubernetes Service</a> (AKS) Clusters are amazing - all the power of Kubernetes (K8s) without the hassle of a full tin-based installation. However, by default the management plane, or k8s API, is public. If you want to harden your cluster, one sensible step would be to prevent public access to the management API by making your cluster <em><a href="https://docs.microsoft.com/en-us/azure/aks/private-clusters">private</a></em>.<blockquote><p>Note: There are many other steps you should take to truly harden your cluster, so making your cluster private alone does not guarantee a secure cluster!</blockquote><p>However, this comes at a price. If you do this, then you can only access the API from a VNet that has a private link to the AKS cluster. That means that you cannot deploy to the cluster from an Azure Pipelines hosted agent (since the agent is coming in to the cluster from the internet).<p>Furthermore, you probably want to make your Azure Container Registry (ACR) <a href="https://docs.microsoft.com/en-us/azure/container-registry/container-registry-private-link">private</a> too. Once again this step comes with additional overhead: you can only push/pull to/from this ACR from the VNet, so hosted agents won’t work.<h2 id="private-agents">Private Agents</h2><p>Fortunately, we can provision private agents for deployments. The procedure is as follows:<ol><li>Create a VM on a VNet that has the private link to the AKS cluster so that the VM can reach the private endpoint for the cluster API.<li>Create an agent pool inside of Azure DevOps (AzDO).<li>Download the AzDO pipelines agent and register it to the agent pool.<li>Target the agent pool in your pipelines.</ol><p>You can (of course) do this manually, but if you’re using Terraform, then you can use the following code to spin up a VM and execute a custom script that will register the agent:<div class="language-terraform highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
    <span class="k">resource</span> <span class="s2">"azurerm_linux_virtual_machine"</span> <span class="s2">"devopsvm"</span> <span class="p">{</span>
      <span class="nx">name</span> <span class="p">=</span> <span class="kd">var</span><span class="p">.</span><span class="nx">devops_vm_name</span>
      <span class="nx">resource_group_name</span> <span class="p">=</span> <span class="nx">azurerm_resource_group</span><span class="p">.</span><span class="nx">azdorg</span><span class="p">.</span><span class="nx">name</span>
      <span class="nx">location</span> <span class="p">=</span> <span class="nx">azurerm_resource_group</span><span class="p">.</span><span class="nx">azdorg</span><span class="p">.</span><span class="nx">location</span>
      <span class="nx">network_interface_ids</span> <span class="p">=</span> <span class="p">[</span><span class="nx">azurerm_network_interface</span><span class="p">.</span><span class="nx">azdovmnic</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span>
      <span class="nx">size</span> <span class="p">=</span> <span class="s2">"Standard_DS1_v2"</span>
    
      <span class="nx">os_disk</span> <span class="p">{</span>
        <span class="nx">name</span> <span class="p">=</span> <span class="s2">"</span><span class="k">${</span><span class="kd">var</span><span class="p">.</span><span class="nx">devops_vm_name</span><span class="k">}</span><span class="s2">_osdisk"</span>
        <span class="nx">caching</span> <span class="p">=</span> <span class="s2">"ReadWrite"</span>
        <span class="nx">storage_account_type</span> <span class="p">=</span> <span class="s2">"Standard_LRS"</span>
      <span class="p">}</span>
    
      <span class="nx">source_image_reference</span> <span class="p">{</span>
        <span class="nx">publisher</span> <span class="p">=</span> <span class="s2">"Canonical"</span>
        <span class="nx">offer</span> <span class="p">=</span> <span class="s2">"UbuntuServer"</span>
        <span class="nx">sku</span> <span class="p">=</span> <span class="s2">"18.04-LTS"</span>
        <span class="nx">version</span> <span class="p">=</span> <span class="s2">"latest"</span>
      <span class="p">}</span>
    
      <span class="nx">computer_name</span> <span class="p">=</span> <span class="kd">var</span><span class="p">.</span><span class="nx">devops_vm_name</span>
      <span class="nx">admin_username</span> <span class="p">=</span> <span class="kd">var</span><span class="p">.</span><span class="nx">agent_user</span>
      <span class="nx">disable_password_authentication</span> <span class="p">=</span> <span class="kc">true</span>
    
      <span class="nx">admin_ssh_key</span> <span class="p">{</span>
        <span class="nx">username</span> <span class="p">=</span> <span class="kd">var</span><span class="p">.</span><span class="nx">agent_user</span>
        <span class="nx">public_key</span> <span class="p">=</span> <span class="nx">tls_private_key</span><span class="p">.</span><span class="nx">azdossh</span><span class="p">.</span><span class="nx">public_key_openssh</span>
      <span class="p">}</span>
    
      <span class="nx">tags</span> <span class="p">=</span> <span class="kd">var</span><span class="p">.</span><span class="nx">tags</span>
    <span class="p">}</span>

</code></pre></div></div><blockquote><p>Note: I’m not showing all the resources here, just the main VM resource. This is spinning up an Ubuntu 18.04 VM and attaching it to the VNet that has my AKS cluster private link.</blockquote><p>Once you have the VM defined, you need to add a custom extension:<div class="language-terraform highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
    <span class="k">resource</span> <span class="s2">"azurerm_virtual_machine_extension"</span> <span class="s2">"installtools"</span> <span class="p">{</span>
        <span class="nx">name</span> <span class="p">=</span> <span class="s2">"customconfig"</span>
        <span class="nx">virtual_machine_id</span> <span class="p">=</span> <span class="nx">azurerm_linux_virtual_machine</span><span class="p">.</span><span class="nx">devopsvm</span><span class="p">.</span><span class="nx">id</span>
        <span class="nx">publisher</span> <span class="p">=</span> <span class="s2">"Microsoft.Azure.Extensions"</span>
        <span class="nx">type</span> <span class="p">=</span> <span class="s2">"CustomScript"</span>
        <span class="nx">type_handler_version</span> <span class="p">=</span> <span class="s2">"2.0"</span>
        <span class="nx">protected_settings</span> <span class="p">=</span> <span class="o">&lt;&lt;</span><span class="no">SETTINGS</span><span class="sh">
        {
          "script" : "${base64encode(templatefile("${path.module}/install_tools.sh", {
            AGENT_USER = var.agent_user
            AGENT_POOL = "${var.agent_pool_prefix}-${var.environment}"
            AGENT_TOKEN = var.agent_token
            AZDO_URL = var.azdo_url
          }))}"
        }
</span><span class="no">        SETTINGS
</span>        <span class="nx">depends_on</span> <span class="p">=</span> <span class="p">[</span><span class="nx">azurerm_linux_virtual_machine</span><span class="p">.</span><span class="nx">devopsvm</span><span class="p">]</span>
    <span class="p">}</span>

</code></pre></div></div><p>The trick here is to invoke a script (<code class="language-plaintext highlighter-rouge">install_tools.sh</code>) with the args that it requires, namely the agent user name and token, the agent pool and the AzDO account URL.<blockquote><p>Note: The token is a Personal Access Token (PAT) that has permissions to administer the agent pool.</blockquote><p>Let’s have a look at the <code class="language-plaintext highlighter-rouge">install_tools.sh</code> script:<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
    <span class="c">#!/bin/bash</span>
    <span class="nv">agentuser</span><span class="o">=</span><span class="k">${</span><span class="nv">AGENT_USER</span><span class="k">}</span>
    <span class="nv">pool</span><span class="o">=</span><span class="k">${</span><span class="nv">AGENT_POOL</span><span class="k">}</span>
    <span class="nv">pat</span><span class="o">=</span><span class="k">${</span><span class="nv">AGENT_TOKEN</span><span class="k">}</span>
    <span class="nv">azdourl</span><span class="o">=</span><span class="k">${</span><span class="nv">AZDO_URL</span><span class="k">}</span>
    
    <span class="c"># install az cli</span>
    curl <span class="nt">-sL</span> https://aka.ms/InstallAzureCLIDeb | <span class="nb">sudo </span>bash
    
    <span class="c"># install docker</span>
    <span class="nb">sudo </span>apt <span class="nb">install</span> <span class="nt">-y</span> apt-transport-https ca-certificates curl software-properties-common
    curl <span class="nt">-fsSL</span> https://download.docker.com/linux/ubuntu/gpg | <span class="nb">sudo </span>apt-key add -
    <span class="nb">sudo </span>add-apt-repository <span class="s2">"deb [arch=amd64] https://download.docker.com/linux/ubuntu bionic stable"</span>
    <span class="nb">sudo </span>apt update
    <span class="nb">sudo </span>apt <span class="nb">install</span> <span class="nt">-y</span> docker-ce
    <span class="nb">sudo </span>usermod <span class="nt">-aG</span> docker <span class="nv">$agentuser</span>
    
    <span class="c"># install kubectl</span>
    curl <span class="nt">-s</span> https://packages.cloud.google.com/apt/doc/apt-key.gpg | <span class="nb">sudo </span>apt-key add
    <span class="nb">sudo </span>apt-add-repository <span class="s2">"deb http://apt.kubernetes.io/ kubernetes-xenial main"</span>
    <span class="nb">sudo </span>apt update
    <span class="nb">sudo </span>apt-get <span class="nb">install</span> <span class="nt">-y</span> kubectl
    
    <span class="c"># install helm</span>
    curl <span class="nt">-o</span> helm.tar.gz https://get.helm.sh/helm-v3.3.4-linux-amd64.tar.gz
    <span class="nb">tar </span>zxvf helm.tar.gz
    <span class="nb">sudo mv </span>linux-amd64/helm /usr/local/bin/helm
    <span class="nb">rm</span> <span class="nt">-rf</span> linux-amd64
    <span class="nb">rm</span> <span class="nt">-f</span> helm.tar.gz
    
    <span class="c"># download azdo agent</span>
    <span class="nb">mkdir</span> <span class="nt">-p</span> /opt/azdo <span class="o">&amp;&amp;</span> <span class="nb">cd</span> /opt/azdo
    <span class="nb">cd</span> /opt/azdo
    curl <span class="nt">-o</span> azdoagent.tar.gz https://vstsagentpackage.azureedge.net/agent/2.175.2/vsts-agent-linux-x64-2.175.2.tar.gz
    <span class="nb">tar </span>xzvf azdoagent.tar.gz
    <span class="nb">rm</span> <span class="nt">-f</span> azdoagent.tar.gz
    
    <span class="c"># configure as azdouser</span>
    <span class="nb">chown</span> <span class="nt">-R</span> <span class="nv">$agentuser</span> /opt/azdo
    <span class="nb">chmod</span> <span class="nt">-R</span> 755 /opt/azdo
    runuser <span class="nt">-l</span> <span class="nv">$agentuser</span> <span class="nt">-c</span> <span class="s2">"/opt/azdo/config.sh --unattended --url </span><span class="nv">$azdourl</span><span class="s2"> --auth pat --token </span><span class="nv">$pat</span><span class="s2"> --pool </span><span class="nv">$pool</span><span class="s2"> --acceptTeeEula"</span>
    
    <span class="c"># install and start the service</span>
    ./svc.sh <span class="nb">install</span>
    ./svc.sh start

</code></pre></div></div><p>This script will:<ol><li>Set the variables - the tokens like <code class="language-plaintext highlighter-rouge">${AGENT_USER}</code> are injected when the Terraform <code class="language-plaintext highlighter-rouge">templatefile</code> function is invoked in the custom extension above<li>Install tools such as <code class="language-plaintext highlighter-rouge">az cli</code>, <code class="language-plaintext highlighter-rouge">docker</code>, <code class="language-plaintext highlighter-rouge">kubectl</code> and <code class="language-plaintext highlighter-rouge">helm</code><li>Download and untar the AzDO private agent<li>Run a silent config command to register the agent to the agent pool - I do this using <code class="language-plaintext highlighter-rouge">runuser</code> since this command cannot be run as root (which is the context when Terraform/Azure executes the custom script extension)<li>Install and start the agent service</ol><blockquote><p>Note: if you’re using ARM templates to deploy your VM, then you can still use the <code class="language-plaintext highlighter-rouge">install_tools.sh</code> script using the ARM custom script extension. You’ll have to change how the parameters are handled though.</blockquote><p>To use this agent in a YML pipeline, just set the <code class="language-plaintext highlighter-rouge">pool</code> property to the name of the pool you registered the agent to:<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
    <span class="na">jobs</span><span class="pi">:</span>  
    <span class="pi">-</span> <span class="na">job</span><span class="pi">:</span> <span class="s">Build</span>
      <span class="na">displayName</span><span class="pi">:</span> <span class="s">Build</span>
      <span class="na">pool</span><span class="pi">:</span> <span class="s">my-private-pool</span>
      <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">script</span><span class="pi">:</span> <span class="s">echo Hello from private agent!</span>

</code></pre></div></div><p>Now you can push/pull to/from your private ACR - as long as the build runs on the private agent, just use the <code class="language-plaintext highlighter-rouge">docker</code> <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/build/docker?view=azure-devops#build-and-push">tasks</a>as per normal.<h2 id="deploying-to-private-aks">Deploying to Private AKS</h2><p>Now that we have a private agent, we can deploy to the AKS cluster. However, there are a couple further steps required, especially if we want <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/release/approvals/approvals?view=azure-devops">approvals</a>(which you do!).<p>For public AKS cluster, you can create a <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/process/environments?view=azure-devops">Pipeline Environment</a> in AzDO and add a <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/process/environments-kubernetes?view=azure-devops">Kubernetes resource</a>. Under the hood AzDO will query the namespaces of the target cluster so that you can select a namespace for the environment, as well as for querying workloads (services, deployments and pods) within the cluster. However, if you try this for a private cluster, you’ll get an error:<figure class="kg-card kg-image-card kg-card-hascaption"><img src="/assets/images/2020/10/271718_image.png" class="kg-image" alt="" loading="lazy" /><figcaption>Error when creating an AzDO environment to a private AKS cluster</figcaption></figure><p>You can see the URL to the cluster API has <code class="language-plaintext highlighter-rouge">.privatelink</code> in it - so this makes sense. AzDO is unable to connect to the AKS API.<p>To work around this, we need to:<ol><li>Create a <code class="language-plaintext highlighter-rouge">generic</code> environment for approvals<li>Create a Kubernetes service connection for connecting to the cluster using <code class="language-plaintext highlighter-rouge">kubeconfig</code></ol><p>To create the environment, navigate to Pipelines-&gt;Environments and add a new environment. Simply select <code class="language-plaintext highlighter-rouge">None</code> for the resource type:<figure class="kg-card kg-image-card kg-card-hascaption"><img src="/assets/images/2020/10/271721_image.png" class="kg-image" alt="" loading="lazy" /><figcaption>Creating a <code>generic</code> AzDO environment</figcaption></figure><p>Now you can define <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/process/approvals?view=azure-devops&amp;tabs=check-pass#approvals">approvals</a> and/or gates (checks) on the environment as you would for any other environment.<h3 id="create-a-generic-k8s-endpoint">Create a Generic k8s Endpoint</h3><p>Next we have to create a k8s <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/library/service-endpoints?view=azure-devops&amp;tabs=yaml">service endpoint</a>. The service endpoint allows you to abstract authentication from your pipelines - as long as the person that initiates the pipeline has access to use the endpoint (you can configure endpoint security) then they just specify the endpoint name - the authentication is handled under the hood.<p>If you try to create a service connection to a <em>public</em> AKS cluster, you can use the dialog and it will confirm connectivity and show namespaces etc. - but we can’t in this case for the same reason as the environment above - the API is private!<p>That means that we have to fall back on creating a <code class="language-plaintext highlighter-rouge">generic</code> k8s endpoint using a <code class="language-plaintext highlighter-rouge">kubeconfig</code>. When we use this connection, AzDO will download the <code class="language-plaintext highlighter-rouge">kubeconfig</code> and issue <code class="language-plaintext highlighter-rouge">kubectl config use-context</code> for the specified context, so that we’re ready to issue subsequent commands.<p>To extract your cluster’s <code class="language-plaintext highlighter-rouge">kubeconfig</code> you’ll need to connect to a VM in the VNet. You can then use <code class="language-plaintext highlighter-rouge">az cli</code> to login and then get the credentials for the AKS cluster:<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
    <span class="c"># login to azure</span>
    az login
    
    <span class="c"># login to the AKS cluster</span>
    az aks get-credentials <span class="nt">-n</span> &lt;cluster_name&gt; <span class="nt">-g</span> &lt;cluster_resource_group_name&gt;

</code></pre></div></div><p>At this point, you can just copy the <code class="language-plaintext highlighter-rouge">~/.kube/config</code> file.<p>Now navigate to your Azure DevOps account and Team Project. Click on the gear icon to go to <em>project</em> (not account) settings. Click on <code class="language-plaintext highlighter-rouge">Service connections</code> and then click the <code class="language-plaintext highlighter-rouge">New Connection</code> button.<p>Select <code class="language-plaintext highlighter-rouge">Kubernetes</code> from the connection type and click <code class="language-plaintext highlighter-rouge">Next</code>:<figure class="kg-card kg-image-card kg-card-hascaption"><img src="/assets/images/2020/10/271742_image.png" class="kg-image" alt="" loading="lazy" /><figcaption>Creating a <code>KubeConfig</code> Service Connection</figcaption></figure><p>Fill out the form as follows:<ol><li>Change the type to <code class="language-plaintext highlighter-rouge">Kubeconfig</code><li>Paste your <code class="language-plaintext highlighter-rouge">kubeconfig</code> file into the <code class="language-plaintext highlighter-rouge">KubeConfig</code> field<li>Select the correct <code class="language-plaintext highlighter-rouge">context</code> from the dropdown (values will be filled in from the parsed <code class="language-plaintext highlighter-rouge">kubeconfig</code> file<li>Enter a <code class="language-plaintext highlighter-rouge">name</code> and (optional) <code class="language-plaintext highlighter-rouge">description</code><li>Clicking <code class="language-plaintext highlighter-rouge">Verify</code> will fail (because the API is private!) so you have to select <code class="language-plaintext highlighter-rouge">Save without verification</code> from the button menu to save the connection.</ol><blockquote><p>Note: I initially did a <code class="language-plaintext highlighter-rouge">cat</code> of the <code class="language-plaintext highlighter-rouge">kubeconfig</code> and pasted it - this didn’t work since the copy command inserted newlines in the certs inside the file. I had to clean the value so that it was valid <code class="language-plaintext highlighter-rouge">kubeconfig</code> yml.</blockquote><p>We now have a <code class="language-plaintext highlighter-rouge">generic</code> environment for approvals and a <code class="language-plaintext highlighter-rouge">kubeconfig</code> service connection for authentication to the cluster!<h2 id="the-pipeline">The Pipeline</h2><p>We can now make use of the environment and service connection in our pipelines. Here is a snippet showing that:<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
    <span class="na">stages</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">stage</span><span class="pi">:</span> <span class="s">dev</span>
      <span class="na">displayName</span><span class="pi">:</span> <span class="s">DEV</span>
      <span class="na">jobs</span><span class="pi">:</span>  
      <span class="pi">-</span> <span class="na">deployment</span><span class="pi">:</span> <span class="s">deploy</span>
        <span class="na">displayName</span><span class="pi">:</span> <span class="s">Deploy</span>
        <span class="na">pool</span><span class="pi">:</span> <span class="s">my-private-pool</span>
        <span class="na">environment</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Private</span><span class="nv"> </span><span class="s">AKS</span><span class="nv"> </span><span class="s">Dev'</span>
        <span class="na">strategy</span><span class="pi">:</span>
          <span class="na">runOnce</span><span class="pi">:</span>
            <span class="na">deploy</span><span class="pi">:</span>
              <span class="na">steps</span><span class="pi">:</span>
              <span class="pi">-</span> <span class="na">checkout</span><span class="pi">:</span> <span class="s">self</span>
              <span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">HelmDeploy@0</span>
                <span class="na">displayName</span><span class="pi">:</span> <span class="s">Helm Deploy app</span>
                <span class="na">inputs</span><span class="pi">:</span>
                  <span class="na">connectionType</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Kubernetes</span><span class="nv"> </span><span class="s">Service</span><span class="nv"> </span><span class="s">Connection'</span>
                  <span class="na">kubernetesServiceConnection</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Private</span><span class="nv"> </span><span class="s">AKS</span><span class="nv"> </span><span class="s">Connection</span><span class="nv"> </span><span class="s">Dev'</span>
                  <span class="na">namespace</span><span class="pi">:</span> <span class="s1">'</span><span class="s">dev'</span>
                  <span class="na">command</span><span class="pi">:</span> <span class="s">upgrade</span>
                  <span class="na">chartType</span><span class="pi">:</span> <span class="s">FilePath</span>
                  <span class="na">chartPath</span><span class="pi">:</span> <span class="s1">'</span><span class="s">/path/to/chart'</span>
                  <span class="na">releaseName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">release-name'</span>
                  <span class="na">valueFile</span><span class="pi">:</span> <span class="s1">'</span><span class="s">/path/to/value/file'</span>
                  <span class="na">arguments</span><span class="pi">:</span> <span class="s1">'</span><span class="s">--create-namespace'</span>

</code></pre></div></div><p>On line 7, we’re specifying the private agent pool so that this pipeline stage runs on the private agent. On line 8 we specify the environment we created earlier - if there are any approvals and/or gates configured for this environment, the stage would only proceed once the approvals and gates have passed. On line 17 we specify that the <code class="language-plaintext highlighter-rouge">helm</code> task should authenticate via a <code class="language-plaintext highlighter-rouge">Kubernetes Service Connection</code> and we specify the connection name in line 18.<p>Of course if you were using the <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/deploy/kubernetes-manifest?view=azure-devops">Kubernetes manifest task</a>, the same principles would apply.<h2 id="conclusion">Conclusion</h2><p>Creating a private AKS cluster makes sense when hardening your cluster. However, it does make deployment challenging. However, by creating a private agent, a <code class="language-plaintext highlighter-rouge">generic</code> environment and a <code class="language-plaintext highlighter-rouge">kubeconfig</code> service connection, you can still deploy to the cluster securely. Be aware that you are not going to be able to see the workloads (services, deployments, pods etc.) in AzDO like you can with a public AKS Environment. Hopefully you have <a href="https://docs.microsoft.com/en-us/azure/azure-monitor/insights/container-insights-overview">Container Insights</a> configured anyway, so this shouldn’t be a huge concern.<p>Happy private kube’ing!</article><hr class="dingbat related mb6" /><aside class="comments related" role="complementary"><h2 class="hr-bottom">Comments</h2><div id="giscus"><div></div></div><script> function toggle_giscus() { const c = document.body.classList; const dark = c.contains("dark-mode") || "_sunset" in window && !c.contains("light-mode") && matchMedia("(prefers-color-scheme: dark)").matches; const theme = dark ? "dark" : "light"; const scriptEl = document.createElement("script"); scriptEl.src = "https://giscus.app/client.js"; scriptEl.setAttribute("data-repo", "colindembovsky/colindembovsky.github.io"); scriptEl.setAttribute("data-repo-id", "MDEwOlJlcG9zaXRvcnk0MDczMjI3MjU="); scriptEl.setAttribute("data-category", "Giscussions"); scriptEl.setAttribute("data-category-id", "DIC_kwDOGEdAZc4B_F18"); scriptEl.setAttribute("data-mapping", "pathname"); scriptEl.setAttribute("data-reactions-enabled", "1"); scriptEl.setAttribute("data-emit-metadata", "colindembovsky/colindembovsky.github.io"); scriptEl.setAttribute("data-theme", theme); scriptEl.setAttribute("crossorigin", "anonymous"); const container = document.getElementById("giscus"); const old = container.firstElementChild; container.removeChild(old); container.appendChild(scriptEl); } document.addEventListener("hydejack-dark-mode-toggle", function() { toggle_giscus(); }); toggle_giscus(); </script></aside><aside class="other-projects related mb0" role="complementary"><h2>Related Posts</h2><div class="columns"><div class="column column-1-2"><article class="project-card"> <a href="/pages/colindembovsky/actions-authenticate-to-azure-without-a-secret/" class="no-hover no-print-link flip-project" tabindex="-1"><div class="project-card-img aspect-ratio sixteen-nine flip-project-img"> <img src="/pages/colindembovsky/assets/images/2021/11/oidc/Data_security_27.jpg" alt="GitHub Actions: Authenticate to Azure Without a Secret using OIDC" width="864" height="486" loading="lazy"/></div></a><h3 class="project-card-title flip-project-title"> <a href="/pages/colindembovsky/actions-authenticate-to-azure-without-a-secret/" class="flip-title">GitHub Actions: Authenticate to Azure Without a Secret using OIDC</a></h3><p class="project-card-text fine" property="disambiguatingDescription"> Authenticating to Azure in GitHub Actions requires a secret for a Service Principal. However, at Universe, GitHub released a new OIDC-based authentication mechanism that eliminates the need for secrets in secure deployments. <a class="fill-card no-hover" href="/pages/colindembovsky/actions-authenticate-to-azure-without-a-secret/" tabindex="-1"><span class="sr-only">Continue reading GitHub Actions: Authenticate to Azure Without a Secret using OIDC</span></a></article></div><div class="column column-1-2"><article class="project-card"> <a href="/pages/colindembovsky/enforcing-reusable-workflows-for-standardization/" class="no-hover no-print-link flip-project" tabindex="-1"><div class="project-card-img aspect-ratio sixteen-nine flip-project-img"> <img src="/pages/colindembovsky/assets/images/2021/11/compliance-reusable/hacker.jpg" alt="Enforcing Reusable Workflows for Standardization" width="864" height="486" loading="lazy"/></div></a><h3 class="project-card-title flip-project-title"> <a href="/pages/colindembovsky/enforcing-reusable-workflows-for-standardization/" class="flip-title">Enforcing Reusable Workflows for Standardization</a></h3><p class="project-card-text fine" property="disambiguatingDescription"> Reusable workflows are great, but how do you ensure that teams are using your reusable workflows? In this post I show how you can structure repos, teams and environments to ensure standardization for your workflows. <a class="fill-card no-hover" href="/pages/colindembovsky/enforcing-reusable-workflows-for-standardization/" tabindex="-1"><span class="sr-only">Continue reading Enforcing Reusable Workflows for Standardization</span></a></article></div></div></aside><aside class="related mb4" role="complementary"><h2 class="hr-bottom">Random Posts</h2><ul class="related-posts"><li class="h4"> <a href="/pages/colindembovsky/using-data-generation-plans-to-create-repeatable-data-for-code-unit-tests/" class="flip-title"><span>Using Data Generation Plans to create repeatable data for code unit tests</span></a> <time class="faded fine" datetime="2011-02-13T03:25:00+00:00">13 Feb 2011</time><li class="h4"> <a href="/pages/colindembovsky/colins-alm-corner-new-theme-and-live-tiles/" class="flip-title"><span>Colin’s ALM Corner – New Theme and Live Tiles</span></a> <time class="faded fine" datetime="2014-04-30T22:29:34+00:00">30 Apr 2014</time><li class="h4"> <a href="/pages/colindembovsky/fix-you-open-tfcvtemplate12xaml-and-dont-see-any-parameters/" class="flip-title"><span>Fix: You Open TfcvTemplate.12.xaml and Don’t See Any Parameters</span></a> <time class="faded fine" datetime="2013-09-14T00:23:00+00:00">14 Sep 2013</time></ul></aside><footer class="content" role="contentinfo"><hr/><p><small class="copyright">© 2021. All rights reserved. </small><hr class="sr-only"/></footer></main><hy-drawer id="_drawer" class="" side="left" threshold="10" noscroll ><header id="_sidebar" class="sidebar" role="banner"><div class="sidebar-bg sidebar-overlay" style="background-color:rgb(5,19,24);background-image:url(/pages/colindembovsky/assets/img/sidebar-bg.jpg)"></div><div class="sidebar-sticky"><div class="sidebar-about"> <a class="no-hover" href="/pages/colindembovsky/" tabindex="-1"> <img src="/pages/colindembovsky/assets/img/logo.png" class="avatar" alt="Colin's ALM Corner" width="120" height="120" loading="lazy" /> </a> <a class="sidebar-title" href="/pages/colindembovsky/"><h2 class="h1">Colin's ALM Corner</h2></a><p class=""> DevOpsology &amp; GitHub. <br /> <em>Opinions my own</em>.</div><nav class="sidebar-nav heading" role="navigation"> <span class="sr-only">Navigation:</span><ul><li> <a id="_drawer--opened" href="/pages/colindembovsky/tags/" class="sidebar-nav-item " > Tags </a><li> <a href="/pages/colindembovsky/about/" class="sidebar-nav-item " > About </a></ul></nav><div class="sidebar-social"> <span class="sr-only">Social:</span><ul><li> <a href="https://twitter.com/colindembovsky" title="Twitter" class="no-mark-external"> <span class="icon-twitter"></span> <span class="sr-only">Twitter</span> </a><li> <a href="https://github.com/colindembovsky" title="GitHub" class="no-mark-external"> <span class="icon-github"></span> <span class="sr-only">GitHub</span> </a><li> <a href="https://colinsalmcorner.com/feed.xml" title="RSS" class="no-mark-external"> <span class="icon-rss2"></span> <span class="sr-only">RSS</span> </a></ul></div></div></header></hy-drawer><hr class="sr-only" hidden /> </hy-push-state> <!--[if gt IE 10]><!----> <script nomodule>!function(){var t,n=document.createElement("script");!("noModule"in n)&&"onbeforeload"in n&&(t=!1,document.addEventListener("beforeload",function(e){if(e.target===n)t=!0;else if(!e.target.hasAttribute("nomodule")||!t)return;e.preventDefault()},!0),n.type="module",n.src=".",document.head.appendChild(n),n.remove())}(); </script> <script src="/pages/colindembovsky/assets/js/hydejack-9.1.4.js" type="module"></script> <script src="/pages/colindembovsky/assets/js/LEGACY-hydejack-9.1.4.js" nomodule defer></script> <script type="module"> if ('serviceWorker' in navigator) { /**/ navigator.serviceWorker.getRegistration() .then(r => r.unregister()) .catch(() => {}); /**/ } </script> <!--<![endif]--><div hidden><h2 class="sr-only">Templates (for web app):</h2><clap-config> <clap-text at="1">Keep going!</clap-text> <clap-text at="2">Keep going ×2!</clap-text> <clap-text at="3">Give me more!</clap-text> <clap-text at="5">Thank you, thank you</clap-text> <clap-text at="7">Far too kind!</clap-text> <clap-text at="10">Never gonna give me up?</clap-text> <clap-text at="14">Never gonna let me down?</clap-text> <clap-text at="20">Turn around and desert me!</clap-text> <clap-text at="30">You're an addict!</clap-text> <clap-text at="40">Son of a clapper!</clap-text> <clap-text at="50">No way</clap-text> <clap-text at="60">Go back to work!</clap-text> <clap-text at="70">This is getting out of <em>hand</em></clap-text> <clap-text at="80">Unbelievable</clap-text> <clap-text at="90">PREPOSTEROUS</clap-text> <clap-text at="100">I N S A N I T Y</clap-text> <clap-text at="185"><span style="font-family:monospace">FEED ME A STRAY CAT</span></clap-text> </clap-config> <template id="_animation-template"><div class="animation-main fixed-top"><nav id="breadcrumbs" class="screen-only"><ul></ul></nav><div class="content"><div class="page"></div></div></div></template> <template id="_loading-template"><div class="loading nav-btn fr"> <span class="sr-only">Loading…</span> <span class="icon-cog"></span></div></template> <template id="_error-template"><div class="page"><h1 class="page-title">Error</h1><p class="lead"> Sorry, an error occurred while loading <a class="this-link" href=""></a>.</div></template> <template id="_permalink-template"> <a href="#" class="permalink"> <span class="sr-only">Permalink</span> <span class="content-hash"></span> </a> </template> <template id="_cookies-banner-template"><div id="_cookies-banner" class="navbar fixed-bottom CookiesOK"><div class="content"><div class="nav-btn-bar"> <small class="faded"> <span>This site uses cookies. <a href="/cookies-policy/">Cookies Policy</a>. </span> <button id="_cookies-ok" class="btn btn-primary btn-sm">Okay</button> </small></div></div></div></template> <template id="_dark-mode-template"> <button id="_dark-mode" class="nav-btn no-hover" > <span class="sr-only">Dark Mode</span> <span class="icon-brightness-contrast"></span> </button> </template> <template id="_search-template"> <button id="_search" class="nav-btn no-hover"> <label class="sr-only" for="_search-input">Search</label> <span class="icon-search"></span> </button><div id="_search-box"><div class="nav-btn"> <span class="icon-search"></span></div><input id="_search-input" type="search" class="form-control form-control-lg nav-btn" placeholder="Type something…" /> <button type="reset" class="nav-btn no-hover"> <span class="sr-only">Close</span> <span class="icon-cross"></span> </button></div><div id="_hits"></div></template></div></html>
