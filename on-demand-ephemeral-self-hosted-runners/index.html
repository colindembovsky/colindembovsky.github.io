<!DOCTYPE html>
<html lang="en"><head><title>On Demand Ephemeral Self-Hosted Runners | Colin’s ALM Corner</title><meta name="generator" content="Jekyll v3.9.0" /><meta property="og:title" content="On Demand Ephemeral Self-Hosted Runners" /><meta name="author" content="Colin Dembovsky" /><meta property="og:locale" content="en" /><meta name="description" content="Do you need to deploy to private VNets using GitHub Actions, but don’t want to have to keep self-hosted runners running all the time? In this post I show you how you can use Ephemeral Runners to create on-demand self-hosted runners." /><meta property="og:description" content="Do you need to deploy to private VNets using GitHub Actions, but don’t want to have to keep self-hosted runners running all the time? In this post I show you how you can use Ephemeral Runners to create on-demand self-hosted runners." /><link rel="canonical" href="https://github.com/pages/colindembovsky/on-demand-ephemeral-self-hosted-runners/" /><meta property="og:url" content="https://github.com/pages/colindembovsky/on-demand-ephemeral-self-hosted-runners/" /><meta property="og:site_name" content="Colin’s ALM Corner" /><meta property="og:image" content="https://github.com/pages/colindembovsky/assets/images/2021/10/self-hosted-runners/boom.jpeg" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-10-26T01:22:01+00:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://github.com/pages/colindembovsky/assets/images/2021/10/self-hosted-runners/boom.jpeg" /><meta property="twitter:title" content="On Demand Ephemeral Self-Hosted Runners" /><meta name="twitter:site" content="@colindembovsky" /><meta name="twitter:creator" content="@colindembovsky" /> <script type="application/ld+json"> {"description":"Do you need to deploy to private VNets using GitHub Actions, but don’t want to have to keep self-hosted runners running all the time? In this post I show you how you can use Ephemeral Runners to create on-demand self-hosted runners.","url":"https://github.com/pages/colindembovsky/on-demand-ephemeral-self-hosted-runners/","@type":"BlogPosting","headline":"On Demand Ephemeral Self-Hosted Runners","dateModified":"2021-10-26T01:22:01+00:00","datePublished":"2021-10-26T01:22:01+00:00","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://github.com/pages/colindembovsky/assets/img/logo.png"},"name":"Colin Dembovsky"},"image":"https://github.com/pages/colindembovsky/assets/images/2021/10/self-hosted-runners/boom.jpeg","mainEntityOfPage":{"@type":"WebPage","@id":"https://github.com/pages/colindembovsky/on-demand-ephemeral-self-hosted-runners/"},"author":{"@type":"Person","name":"Colin Dembovsky"},"@context":"https://schema.org"}</script><meta name="keywords" content="devops,github,actions,build,ci,cd"><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Colin's ALM Corner"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="application-name" content="Colin's ALM Corner"><meta name="theme-color" content="rgb(5,19,24)"><meta name="generator" content="Hydejack v9.1.4" /><link rel="alternate" href="https://github.com/pages/colindembovsky/on-demand-ephemeral-self-hosted-runners/" hreflang="en"><link type="application/atom+xml" rel="alternate" href="https://github.com/pages/colindembovsky/feed.xml" title="Colin's ALM Corner" /><link rel="shortcut icon" href="/pages/colindembovsky/assets/icons/favicon.ico"><link rel="apple-touch-icon" href="/pages/colindembovsky/assets/icons/icon-192x192.png"><link rel="manifest" href="/pages/colindembovsky/assets/site.webmanifest"><link rel="dns-prefetch" href="https://fonts.googleapis.com"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preload" href="/pages/colindembovsky/assets/img/swipe.svg" as="image" id="_hrefSwipeSVG"><link rel="dns-prefetch" href="/pages/colindembovsky/assets/js/search-worker-9.1.4.js" as="worker" id="_hrefSearch"> <script>!function(r,c){"use strict";function a(e,t,n,o){e.addEventListener?e.addEventListener(t,n,o):e.attachEvent?e.attachEvent("on"+t,n):e["on"+t]=n}r.loadJS=function(e,t){var n=c.createElement("script");n.src=e,t&&a(n,"load",t,{once:!0});t=c.scripts[0];return t.parentNode.insertBefore(n,t),n},r._loaded=!1,r.loadJSDeferred=function(e,t){var n=c.createElement("script");function o(){r._loaded=!0,t&&a(n,"load",t,{once:!0});var e=c.scripts[0];e.parentNode.insertBefore(n,e)}return n.src=e,r._loaded?o():a(r,"load",o,{once:!0}),n},r.setRel=r.setRelStylesheet=function(e){a(c.getElementById(e),"load",function(){this.rel="stylesheet"},{once:!0})}}(window,document); !function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this); !function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this); !function(w) { w._baseURL = '/pages/colindembovsky/'; w._publicPath = '/pages/colindembovsky/assets/js/'; w._noPushState = false; w._noDrawer = false; w._noNavbar = false; w._noToc = false; w._noSearch = false; w._advertise = false; w._search = { DATA_URL: '/pages/colindembovsky/assets/sitedata.json?no-cache', STORAGE_KEY: 'mini-search/pages/colindembovsky/', INDEX_KEY: 'index--2021-11-18T20:23:33+00:00', }; w._clapButton = false; }(window);</script> <script async src="/pages/colindembovsky/assets/bower_components/MathJax/es5/tex-mml-chtml.js" id="_MathJax"></script> <!--[if gt IE 8]><!----><style id="_styleInline"> .clearfix,.sidebar-social::after{content:"";display:table;clear:both}.color-transition,body,p,hr,.hr,.hr-after::after,.hr-bottom,.message,.note-sm,.note,#markdown-toc,.navbar,.nav-btn-bar,.nav-btn,.content .avatar{transition:none}#_dark-mode{font-size:1.25rem}@media screen{body.light-mode{--body-color: #333;--body-bg: #fff;--border-color: #ebebeb;--gray: #777;--gray-bg: rgba(0,0,0,0.025);--gray-text: #666;--menu-text: #bbb;--inv-body-color: #ccc;--inv-body-bg: var(--dark-mode-body-bg)}body.light-mode .content{-webkit-font-smoothing:initial;-moz-osx-font-smoothing:initial}body.dark-mode{--body-color: #ccc;--body-bg: var(--dark-mode-body-bg);--border-color: var(--dark-mode-border-color);--gray: rgba(255,255,255,.5);--gray-bg: rgba(255,255,255,.033);--gray-text: rgba(255,255,255,.625);--menu-text: rgba(255,255,255,.25);--inv-body-color: #333;--inv-body-bg: #fff}body.dark-mode .content{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}}@media screen and (prefers-color-scheme: dark){body{--body-color: #ccc;--body-bg: var(--dark-mode-body-bg);--border-color: var(--dark-mode-border-color);--gray: rgba(255,255,255,.5);--gray-bg: rgba(255,255,255,.033);--gray-text: rgba(255,255,255,.625);--menu-text: rgba(255,255,255,.25);--inv-body-color: #333;--inv-body-bg: #fff}body .content{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.tippy-content{-webkit-font-smoothing:initial;-moz-osx-font-smoothing:initial}}html{--font-family: Noto Sans,Helvetica,Arial,sans-serif;--font-family-heading: Roboto Slab,Helvetica,Arial,sans-serif;--code-font-family: Fira Code,Menlo,Monaco,Consolas,monospace;--body-color: #333;--body-bg: #fff;--border-color: #ebebeb;--gray: #777;--gray-bg: rgba(0,0,0,0.025);--gray-text: #666;--menu-text: #bbb;--inv-body-color: #ccc;--inv-body-bg: var(--dark-mode-body-bg);--root-font-size: 15px;--root-font-size-medium: 16px;--root-font-size-large: 17px;--root-font-size-print: 8pt;--root-line-height: 1.75;--font-weight: 400;--font-weight-bold: 700;--font-weight-heading: 700;--content-width-5: 54rem;--content-margin-5: 4rem;--sidebar-width: 21rem;--half-content: 31rem;--break-point-3: 64em;--break-point-5: 86em;--break-point-dynamic: 1664px}html .content{-webkit-font-smoothing:initial;-moz-osx-font-smoothing:initial}*{box-sizing:border-box}html,body{margin:0;padding:0}html{font-family:var(--font-family);font-size:var(--root-font-size);line-height:var(--root-line-height)}body{color:var(--body-color);background-color:var(--body-bg);font-weight:var(--font-weight);overflow-y:scroll}.content img,.img,.content video,.video{max-width:100%;height:auto}.lead{margin-left:-1rem;margin-right:-1rem;margin-bottom:1.5rem}img.lead,video.lead{display:block;max-width:calc(100% + 2rem);width:calc(100% + 2rem);height:auto}.heading,.f1,h1,.h1,.f2,h2,.h2,.f3,h3,.h3,.f4,h4,.h4,.post-date,.sidebar-nav-item,.f5,h5,.h5,.f6,h6,.h6{font-family:var(--font-family-heading);font-weight:var(--font-weight-heading)}.f1,h1,.h1{font-size:2rem;line-height:1.3}.f2,h2,.h2{font-size:1.5rem;line-height:1.4}.f3,h3,.h3{font-size:1.2em;line-height:1.5}.f4,h4,.h4,.post-date,.sidebar-nav-item{font-size:1.08rem;line-height:1.6}.f5,h5,.h5{font-size:1.04rem;line-height:1.7}.f6,h6,.h6{font-size:1rem}.content h1>a,.content .h1>a{text-decoration:none;border-bottom:none}@media screen and (max-width: 42em){.content h1,.content .h1{font-size:1.7rem;line-height:1.35}}@media screen and (min-width: 86em){.content h1,.content .h1{font-size:2.4rem;line-height:1.25}}@media screen and (min-width: 1664px){body:not(.no-large-headings) .content h1,body:not(.no-large-headings) .content .h1{width:calc(100% + 50vw - 32rem);font-size:3rem;line-height:1.2}}@media screen and (min-width: 124em){body:not(.no-large-headings) .content h1,body:not(.no-large-headings) .content .h1{font-size:4rem;line-height:1.1}}h1,h2,h3,.h1,.h2,.h3{margin:4rem 0 1rem}h4,h5,h6,.h4,.post-date,.h5,.h6{margin:3rem 0 .5rem}p{margin-top:0;margin-bottom:1rem}p.lead{font-size:1.2em;margin-top:1.5rem;margin-bottom:1.5rem;padding:0 1rem}ul,ol,dl{margin-top:0;margin-bottom:1rem}ul,ol{padding-left:1.25rem}hr,.hr{border:0;margin:1rem 0;border-top:1px solid var(--border-color)}.hr-after::after{content:"";display:block;margin:1rem 0;border-top:1px solid var(--border-color)}.hr-bottom{border-bottom:1px solid var(--border-color);padding-bottom:.75rem;margin-bottom:1rem}.page{margin-bottom:3em}.page li+li{margin-top:.25rem}.page>header{position:relative;margin-bottom:1.5rem}@media screen and (min-width: 1664px){body:not(.no-third-column) .page>header>.lead+.note-sm,body:not(.no-third-column) .page>header>.lead+.note,body:not(.no-third-column) .page>header>.lead+#markdown-toc,body:not(.no-third-column) .page>header>a.no-hover+.note-sm,body:not(.no-third-column) .page>header>a.no-hover+.note,body:not(.no-third-column) .page>header>a.no-hover+#markdown-toc{position:absolute;right:-25rem;width:21rem;bottom:0;margin-bottom:0}}.page-title,.post-title{margin-top:0}.post-date{display:flex;justify-content:space-between;margin-top:-.6rem;height:2rem;margin-bottom:.85rem;color:var(--gray)}.post-date>.ellipsis,#breadcrumbs.post-date>ul{cursor:pointer}.post-date [class^="icon-"]{display:inline-block;font-size:smaller;margin-right:.25rem}.related-posts{padding-left:0;list-style:none;margin-bottom:2rem}.related-posts>li,.related-posts>li+li{margin-top:1rem}.message,.note-sm,.note,#markdown-toc{margin-bottom:1rem;padding:1rem;color:var(--gray-text);background-color:var(--gray-bg);margin-left:-1rem;margin-right:-1rem}.note-sm,.note,#markdown-toc{background:transparent;color:var(--body-color);font-size:smaller;border-left:1px solid var(--border-color);padding:1.2rem 1rem 0 1rem;margin:1rem -1rem;position:relative}.note-sm:before,.note:before,#markdown-toc:before{font-size:0.667rem;font-weight:bold;font-style:normal;letter-spacing:.025rem;text-transform:uppercase;color:var(--menu-text);position:absolute;top:0}.note-sm[title]:before,[title].note:before,[title]#markdown-toc:before{content:attr(title) !important}.note{font-size:1rem}@media screen{body::before{content:'';width:.5rem;background:var(--gray-bg);position:fixed;left:0;top:0;bottom:0}}@media (min-width: 64em){body::before{width:21rem}}@media (min-width: 1664px){body::before{width:calc(50% - 31rem)}}@media screen and (min-width: 42em){html{font-size:var(--root-font-size-medium)}}@media screen and (min-width: 124em){html{font-size:var(--root-font-size-large)}}#breadcrumbs>ul{height:1rem;margin:-1.5rem 0 .5rem;padding:0;font-size:.667rem;color:var(--menu-text);text-transform:uppercase;width:100%;list-style:none}#breadcrumbs>ul>li{display:inline}#breadcrumbs>ul>li a{color:var(--gray);text-decoration:none;border-bottom:none}.fl{float:left}.fr{float:right}.mb4{margin-bottom:4rem}.mb6{margin-bottom:6rem}.mt0{margin-top:0}.mt1{margin-top:1rem}.mt2{margin-top:2rem}.mt3{margin-top:3rem}.mt4{margin-top:4rem}.pb0{padding-bottom:0}.ml1{margin-left:1rem}.mr1{margin-right:1rem}.sixteen-nine{position:relative}.sixteen-nine::before{display:block;content:"";width:100%;padding-top:56.25%}.sixteen-nine>*{position:absolute;top:0;left:0;right:0;bottom:0}.sixteen-ten{position:relative}.sixteen-ten::before{display:block;content:"";width:100%;padding-top:62.5%}.sixteen-ten>*{position:absolute;top:0;left:0;right:0;bottom:0}.four-three{position:relative}.four-three::before{display:block;content:"";width:100%;padding-top:75%}.four-three>*{position:absolute;top:0;left:0;right:0;bottom:0}.sr-only{display:none}.larger{font-size:larger}.smaller{font-size:smaller}.clearfix,.sidebar-social::after{content:"";display:table;clear:both}.ellipsis,#breadcrumbs>ul{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.border{border:1px solid var(--border-color)}@media (min-width: 42em){.border-radius,.lead,.page .aspect-ratio.sixteen-nine.lead{border-radius:.5rem}}.fallback-img{background-position:center;background-repeat:no-repeat;background-image:url("data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4KPHN2ZyB3aWR0aD0iMTYwIiBoZWlnaHQ9IjkwIiB2aWV3Qm94PSIwIDAgMTYwIDkwIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgogIDxnIHRyYW5zZm9ybT0ibWF0cml4KDAuMDQ4ODI4LCAwLCAwLCAwLjA0Nzk5MSwgNTQuOTk5OTczLCAyMC40MjgxNDgpIj4KICAgIDxwYXRoIHN0eWxlPSJmaWxsOnJnYmEoMTI4LDEyOCwxMjgsLjMzKSIgZD0iTTk1OS44ODQgMTI4YzAuMDQwIDAuMDM0IDAuMDgyIDAuMDc2IDAuMTE2IDAuMTE2djc2Ny43N2MtMC4wMzQgMC4wNDAtMC4wNzYgMC4wODItMC4xMTYgMC4xMTZoLTg5NS43N2MtMC4wNDAtMC4wMzQtMC4wODItMC4wNzYtMC4xMTQtMC4xMTZ2LTc2Ny43NzJjMC4wMzQtMC4wNDAgMC4wNzYtMC4wODIgMC4xMTQtMC4xMTRoODk1Ljc3ek05NjAgNjRoLTg5NmMtMzUuMiAwLTY0IDI4LjgtNjQgNjR2NzY4YzAgMzUuMiAyOC44IDY0IDY0IDY0aDg5NmMzNS4yIDAgNjQtMjguOCA2NC02NHYtNzY4YzAtMzUuMi0yOC44LTY0LTY0LTY0djB6Ii8+CiAgICA8cGF0aCBzdHlsZT0iZmlsbDpyZ2JhKDEyOCwxMjgsMTI4LC4zMykiIGQ9Ik04MzIgMjg4YzAgNTMuMDIwLTQyLjk4IDk2LTk2IDk2cy05Ni00Mi45OC05Ni05NiA0Mi45OC05NiA5Ni05NiA5NiA0Mi45OCA5NiA5NnoiLz4KICAgIDxwYXRoIHN0eWxlPSJmaWxsOnJnYmEoMTI4LDEyOCwxMjgsLjMzKSIgZD0iTTg5NiA4MzJoLTc2OHYtMTI4bDIyNC0zODQgMjU2IDMyMGg2NGwyMjQtMTkyeiIvPgogIDwvZz4KPC9zdmc+")}hy-push-state a{color:var(--body-color)}@supports not ((text-decoration-thickness: initial) and (text-underline-offset: initial)){hy-push-state a{text-decoration:none;border-bottom:2px solid}}@supports (text-decoration-thickness: initial) and (text-underline-offset: initial){hy-push-state a{text-decoration-style:solid;text-underline-offset:.35rem;text-decoration-thickness:2px}}hy-push-state a.no-hover{border-bottom:none;text-decoration-thickness:unset;text-underline-offset:unset}.content a:not(.btn):not(.no-hover){border-color:var(--accent-color-faded)}@supports (text-decoration-thickness: initial) and (text-underline-offset: initial){.content a:not(.btn):not(.no-hover){text-decoration-color:var(--accent-color-faded)}}.content .aspect-ratio{overflow:hidden}.content .aspect-ratio img{margin:0;width:100%;height:100%;background-color:var(--gray-bg)}hy-drawer{width:100%;position:relative;overflow:hidden;display:block;z-index:4}@media screen and (min-width: 64em){hy-drawer{position:fixed;width:21rem;top:0;left:0;bottom:0;margin-left:0}hy-drawer.cover{position:relative;width:100%}}@media screen and (min-width: 1664px){hy-drawer{width:calc(50% - 31rem)}}.sidebar{position:relative;display:flex;justify-content:center;align-items:center;color:rgba(255,255,255,0.75);text-align:center;min-height:100vh}.sidebar.invert{color:rgba(32,32,32,0.75)}.sidebar a{color:#fff;border-bottom-color:rgba(255,255,255,0.2);text-decoration-color:rgba(255,255,255,0.2)}.sidebar.invert a{color:#222;border-bottom-color:rgba(32,32,32,0.2);text-decoration-color:rgba(32,32,32,0.2)}.sidebar-bg{position:absolute;top:0;left:calc(50% - 50vw);width:100vw;height:100%;background:#202020 center / cover}.sidebar-bg::after{content:"";position:absolute;top:0;left:0;bottom:0;right:0;background:rgba(0,0,0,0.05)}.sidebar-bg.sidebar-overlay::after{background:linear-gradient(to bottom, rgba(32,32,32,0) 0%, rgba(32,32,32,0.5) 50%, rgba(32,32,32,0) 100%)}.sidebar-sticky{position:relative;z-index:3;max-width:21rem;padding:1.5rem;contain:content}.sidebar-about .avatar{margin-bottom:1.5rem}.sidebar-about>a.sidebar-title{text-decoration:none}.sidebar-about>a.sidebar-title>h2{margin:0;padding-bottom:.5rem}.sidebar-about>a.sidebar-title::after{content:'';display:block;border-bottom:2px solid;margin:0 auto .5rem;width:4rem;border-color:rgba(255,255,255,0.2);transition:border-color 250ms}.sidebar-about>a.sidebar-title:hover::after{border-color:#fff;transition:border-color 50ms}.sidebar.invert .sidebar-about>a.sidebar-title::after{border-color:rgba(32,32,32,0.2)}.sidebar.invert .sidebar-about>a.sidebar-title:hover::after{border-color:#222}.sidebar-nav>ul{list-style:none;padding-left:0}.sidebar-nav-item{display:inline-block;margin-bottom:.5rem}@media (min-width: 64em){#_main.no-drawer #_menu{display:none}#_main.no-drawer .nav-btn-bar>:nth-child(2){border:none}}.sidebar-social>ul{display:inline-block;list-style:none;padding-left:0;margin-bottom:0}.sidebar-social>ul>li{float:left}.sidebar-social>ul>li>a{display:inline-block;text-align:center;font-size:1.4rem;width:3rem;height:4rem;padding:.5rem 0;line-height:3rem;text-decoration:none;border-bottom-width:2px;border-bottom-style:solid}.sidebar-social>ul li+li{margin-top:0}.fixed-common,.fixed-top,.fixed-bottom{position:fixed;left:0;width:100%;z-index:2}.fixed-top{top:0}.fixed-bottom{bottom:0}.navbar>.content{position:relative;padding-top:0;padding-bottom:0;min-height:0;max-height:5rem}.nav-btn-bar{margin:0 -1rem;background-color:white;background-color:var(--body-bg);height:5rem;display:flex;align-items:center;position:relative}.nav-btn-bar>:first-child,.nav-btn-bar>:last-child{border:none}.nav-btn{background:none;border:none;text-decoration:none;display:flex;align-items:center;justify-content:center;width:3.25rem;height:5rem;color:var(--menu-text);border-right:1px solid var(--border-color);border-left:1px solid var(--border-color);margin-left:-1px}#markdown-toc{margin:2rem -1rem 2rem calc(-1rem + 1px);padding-left:2.5rem;padding-bottom:.5rem}#markdown-toc:before{left:1rem}@media screen and (min-width: 1664px){body:not(.no-toc) #markdown-toc{position:absolute;z-index:4;width:20.5rem;right:0;margin:auto;overflow:auto}}@media screen and (min-width: 1664px){body.no-break-layout:not(.no-toc) #markdown-toc{width:calc(50% - 31rem)}}.content{margin-left:auto;margin-right:auto;padding:8rem 1rem 12rem}@media screen{.content{padding-left:1.5rem;min-height:100vh}}@media screen and (min-width: 42em){.content{max-width:42rem}}@media screen and (min-width: 54em){.content{max-width:48rem}}@media screen and (min-width: 64em){.content{padding-left:1rem;margin-left:24rem;margin-right:3rem}}@media screen and (min-width: 86em){.content{padding-top:9rem;margin-left:25rem;margin-right:4rem;max-width:54rem}}@media screen and (min-width: 1664px){.content{margin:auto}}.large-only{display:none}@media screen and (min-width: 1664px){.large-only{display:block}}.avatar{width:7rem;height:7rem;border-radius:100%;overflow:hidden;display:inline-block}.avatar img{width:100%}.content .avatar{float:right;box-sizing:content-box;border:1rem solid var(--body-bg);transition:border-color 1s ease;margin-top:-1.5rem;margin-right:-1rem}hr.dingbat{display:none}.center-image{margin:auto;display:block}.note:before{content:"Note"}.page>header>.note-sm:before,.page>header>.note:before,.page>header>#markdown-toc:before{content:"Description"}#markdown-toc:before{content:"Table of Contents"}.layout-resume .note-sm:before,.layout-resume .note:before,.layout-resume #markdown-toc:before{content:"Summary"} .clearfix,main:not(.layout-resume) .columns::after{content:"";display:table;clear:both}.color-transition,main:not(.layout-resume) .project-card{transition:none}main:not(.layout-resume) .columns{margin-left:-1rem;display:flex;flex-wrap:wrap;contain:content;padding-top:1rem;margin-top:1rem;padding-right:1rem;margin-right:-1rem}main:not(.layout-resume) .column{float:left;padding-left:1rem;margin-bottom:2rem;width:100%;display:flex}@media screen and (min-width: 42em){main:not(.layout-resume) .columns{margin-left:-2rem;margin-right:-2rem}main:not(.layout-resume) .column-1-2{width:50%}}@media screen and (min-width: 1664px){main:not(.layout-resume) .columns-break{width:calc(50vw + 25rem)}main:not(.layout-resume) .columns-break>.column-1-2,main:not(.layout-resume) .columns-break>.column-1{width:27.5rem}}@media print{main:not(.layout-resume) .columns{display:block}main:not(.layout-resume) .column{display:block;width:50%}}main:not(.layout-resume) .project-card{width:100%;color:var(--gray-text);background-color:var(--gray-bg);padding-bottom:1rem;position:relative;overflow:hidden;box-shadow:0.125rem 0.125rem 1rem rgba(0,0,0,0.2);contain:content;border-radius:.5rem;page-break-inside:avoid;transition:transform 500ms ease;will-change:transform}main:not(.layout-resume) .project-card:hover{transform:translateY(-0.25rem);transition:transform 250ms ease}main:not(.layout-resume) .project-card>a.flip-project{display:block}main:not(.layout-resume) .project-card>a.flip-project .project-card-img{margin-bottom:0}main:not(.layout-resume) .project-card>a.flip-project .project-card-img img{display:block;border-top-left-radius:.5rem;border-top-right-radius:.5rem}main:not(.layout-resume) .project-card a{position:relative;z-index:1}main:not(.layout-resume) .project-card a.fill-card{position:absolute;top:0;left:0;right:0;bottom:0;z-index:0}main:not(.layout-resume) .project-card>.project-card-title,main:not(.layout-resume) .project-card>.project-card-text{text-align:center;padding:0 1rem}main:not(.layout-resume) .project-card>.project-card-title{display:block;font-size:1.08rem;margin-top:.75rem;margin-bottom:.25rem;color:inherit}main:not(.layout-resume) .project-card>.project-card-text{margin:.25rem 0}main:not(.layout-resume) .column-1>.project-card>.project-card-title{font-size:1.2rem}main:not(.layout-resume) .column-1>.project-card>.project-card-text{font-size:1rem}</style><link rel="preload" as="style" href="/pages/colindembovsky/assets/css/hydejack-9.1.4.css" id="_stylePreload"><link rel="preload" as="style" href="/pages/colindembovsky/assets/icomoon/style.css" id="_iconsPreload"><link rel="preload" as="style" href="https://fonts.googleapis.com/css?family=Roboto+Slab:700%7CNoto+Sans:400,400i,700,700i&display=swap" id="_fontsPreload"> <script> setRel('_stylePreload'); setRel('_iconsPreload'); /**/setRel('_fontsPreload');/**/ </script> <noscript><link rel="stylesheet" href="/pages/colindembovsky/assets/css/hydejack-9.1.4.css"><link rel="stylesheet" href="/pages/colindembovsky/assets/icomoon/style.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Slab:700%7CNoto+Sans:400,400i,700,700i&display=swap"> </noscript><style id="_pageStyle"> html{--accent-color: rgb(79, 129, 220);--accent-color-faded: rgba(79,129,220,0.5);--accent-color-highlight: rgba(79,129,220,0.1);--accent-color-darkened: #2f6ad6;--theme-color: rgb(5,19,24);--dark-mode-body-bg: #292e30;--dark-mode-border-color: #353c3e}</style><!--<![endif]--> <script async src="https://www.googletagmanager.com/gtag/js?id=G-FD31RTDXK2"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-FD31RTDXK2'); </script><body class="no-break-layout"> <script> window._sunrise = 6; window._sunset = 18; !function(e,s){var d="light-mode",o="dark-mode",a=(new Date).getHours();"matchMedia"in e&&e.matchMedia("(prefers-color-scheme)")||(o=(e=a<=e._sunrise||a>=e._sunset?o:d)==o?d:o,s.body.classList.add(e),s.body.classList.remove(o))}(window,document); </script> <hy-push-state id="_pushState" replace-selector="#_main" link-selector="a[href]:not([href^='/pages/colindembovsky/assets/']):not(.external):not(.no-push-state)" script-selector="script" duration="500" hashchange ><div id="_navbar" class="navbar fixed-top"><div class="content"> <span class="sr-only">Jump to:</span><div class="nav-btn-bar"> <a id="_menu" class="nav-btn no-hover" href="#_drawer--opened"> <span class="sr-only">Navigation</span> <span class="icon-menu"></span> </a><div class="nav-span"></div></div></div></div><hr class="sr-only" hidden /><main id="_main" class="content layout-post" role="main" ><nav id="breadcrumbs" class="screen-only"><ul><li><a href="/pages/colindembovsky/">home</a><li> <span>/</span> <span>on-demand-ephemeral-self-hosted-runners</span></ul></nav><article id="post-on-demand-ephemeral-self-hosted-runners" class="page post mb6" role="article"><header><h1 class="post-title flip-project-title"> On Demand Ephemeral Self-Hosted Runners</h1><div class="post-date"> <span class="ellipsis mr1"> <time datetime="2021-10-26T01:22:01+00:00">26 Oct 2021</time> on <a href="/pages/colindembovsky/tag/actions/" class="flip-title">actions</a>, <a href="/pages/colindembovsky/tag/build/" class="flip-title">build</a> </span></div><div class="img-wrapper lead aspect-ratio sixteen-nine flip-project-img"> <img src="/pages/colindembovsky/assets/images/2021/10/self-hosted-runners/boom.jpeg" alt="On Demand Ephemeral Self-Hosted Runners" width="864" height="486" loading="lazy" /></div><p class="note-sm" > Do you need to deploy to private VNets using GitHub Actions, but don’t want to have to keep self-hosted runners running all the time? In this post I show you how you can use Ephemeral Runners to create on-demand self-hosted runners.</header><ol id="markdown-toc"><li><a href="#self-hosted-runners" id="markdown-toc-self-hosted-runners">Self-Hosted Runners</a><li><a href="#using-webhooks" id="markdown-toc-using-webhooks">Using WebHooks</a><li><a href="#on-demand-self-hosted-runners" id="markdown-toc-on-demand-self-hosted-runners">On-Demand Self-Hosted Runners</a><ol><li><a href="#prerequisites" id="markdown-toc-prerequisites">Prerequisites</a><li><a href="#reusable-workflows" id="markdown-toc-reusable-workflows">Reusable Workflows</a><ol><li><a href="#deploy-ephemeral-runner" id="markdown-toc-deploy-ephemeral-runner">Deploy Ephemeral Runner</a><li><a href="#delete-aci" id="markdown-toc-delete-aci">Delete ACI</a></ol><li><a href="#the-main-workflow" id="markdown-toc-the-main-workflow">The Main Workflow</a><ol><li><a href="#secrets" id="markdown-toc-secrets">Secrets</a></ol><li><a href="#analyzing-the-runs" id="markdown-toc-analyzing-the-runs">Analyzing the Runs</a></ol><li><a href="#conclusion" id="markdown-toc-conclusion">Conclusion</a></ol><h1 id="self-hosted-runners">Self-Hosted Runners</h1><p>GitHub <a href="https://docs.github.com/en/actions/using-github-hosted-runners/about-github-hosted-runners">hosted runners</a> are great if you need to run workflows that don’t require special tools or access to protected resources. If you have specific tool requirements, you can install tools as steps within a workflow. However, if custom tool installs take too long, or you have other build/deploy requirements (like license files for 3rd party libraries), you may want to create custom images (containers or VMs) that you can run <a href="https://docs.github.com/en/actions/hosting-your-own-runners/about-self-hosted-runners">self-hosted runners</a> on. Obviously you’ll need self-hosted runners to deploy to private networks.<p>But self-hosted runners mean overhead - you have to maintain them as well as pay for the compute. One technique you could use is to <a href="https://docs.github.com/en/actions/hosting-your-own-runners/autoscaling-with-self-hosted-runners">autoscale your self-hosted runners</a>. However, this requires that you have AKS or use the Terraform/AWS method. What if you want something a little more light-weight?<h1 id="using-webhooks">Using WebHooks</h1><p>When a workflow is queued, GitHub publishes an event <code class="language-plaintext highlighter-rouge">workflow_job</code> (docs <a href="https://docs.github.com/en/developers/webhooks-and-events/webhooks/webhook-events-and-payloads#workflow_job">here</a>). Initially when thinking about this scenario, I explored creating a workflow that would trigger off this event and spin up a self-hosted runner.<p>Unfortunately, most, but not <em>all</em> GitHub events trigger workflows. You can create a webhook to listen for <code class="language-plaintext highlighter-rouge">workflow_job</code> and then call a REST API - but then you’d have to host something capable of processing the <code class="language-plaintext highlighter-rouge">POST</code> from the webhook, which could then turn around and <code class="language-plaintext highlighter-rouge">POST</code> to the <code class="language-plaintext highlighter-rouge">repository_webhook</code> event of a workflow. Sounds like more overhead to manage!<p>Instead of doing this, I realized that I could create a reusable workflow to spin up (and another to tear down) a self-hosted runner. In this manner, I’d be spinning up a self-hosted runner <em>on demand</em> and tearing it down afterwards to save overhead and compute.<h1 id="on-demand-self-hosted-runners">On-Demand Self-Hosted Runners</h1><p>In this post, I’ll walk you through this scenario. The idea is as follows:<ol><li>When a workflow runs, execute a job on a hosted runner that spins up a self-hosted runner using Azure Container Instances (ACI) connected to a specific VNet, registering the runner as <a href="https://docs.github.com/en/actions/hosting-your-own-runners/autoscaling-with-self-hosted-runners#using-ephemeral-runners-for-autoscaling">ephemeral</a><li>Execute the “real” work, targeting the self-hosted runner that was just created<li>When the job completes, the runner unregisters from the repo (since it was created as an ephemeral runner)<li>Execute a clean-up job that deletes the ACI</ol><p>In this manner, you get the experience of a hosted runner, but the “real” work is performed on a self-hosted runner that is spun up on-demand in your private VNet. You sacrifice a little bit of time (it takes some time to spin up the ACI) but in return you decrease overhead, since the ACI only lives just long enough to execute the work - there’s nothing to manage after the job completes.<blockquote><p>Note: You also have to maintain the container image, but if you’re not frequently messing with the tools, this is usually not a lot of overhead.</blockquote><blockquote><p>Note: The GitHub PAT required by the self-hosted runner is <strong>VISIBLE on the config of the ACI in the Azure Portal or <code class="language-plaintext highlighter-rouge">az cli</code></strong>. Ensure that you set up appropriate RBAC to prevent leaking this credential!</blockquote><p>Code for this post can be found in <a href="https://github.com/colindembovsky/scaling-self-hosted-aci">this repo</a>.<h2 id="prerequisites">Prerequisites</h2><p>In order for this to work, you’ll need a container image that, when started, will register an ephemeral runner. That image should then be customized to install any further custom build or deploy tools that you may need. You can see this <a href="https://github.com/colindembovsky/github-actions-runner-container">example repo</a> that builds a container image that registers a self-hosted runner when the container is started. That repo includes a workflow that will build the <code class="language-plaintext highlighter-rouge">Dockerfile</code> and publish the image to GitHub Container Registry (GHCR).<p>Secondly, you need to create a resource group for housing the ACI instances and to create an SPN that has permissions to create resources in the resource group.<p>Finally, you need to get the ID of the subnet that you want to connect your runner to. If you’re deploying to private VNets, this is an essential step.<blockquote><p>Note: You could customize the code so that the subnet is not required - this will just spin an ACI that is not connected to any specific VNet. You’d then have a self-hosted runner running on your custom image, but it won’t be connected to any private VNets.</blockquote><h2 id="reusable-workflows">Reusable Workflows</h2><p>There are two <a href="https://docs.github.com/en/actions/learn-github-actions/reusing-workflows">reusable workflows</a> in this scenario: one to spin up an ACI that connects a self-hosted runner to the invoking workflow’s repository. The second deletes the ACI. We don’t have to worry about unregistering the runner, since we’ll spin the runner using the <code class="language-plaintext highlighter-rouge">--ephemeral</code> switch, which automatically unregisters the runner after it has completed a single job.<p>Both workflows execute using hosted runners. The hosted runners simply spin up (and tear down) the ephemeral self-hosted runner: but it is the self-hosted runner that is doing the “real” work.<h3 id="deploy-ephemeral-runner">Deploy Ephemeral Runner</h3><p>The code for the deployment workflow is as follows:<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1"># file: 'deploy-ephemeral-runner.yml'</span>
<span class="na">name</span><span class="pi">:</span> <span class="s">Deploy Ephemeral Runner</span>

<span class="na">on</span><span class="pi">:</span>
  <span class="na">workflow_call</span><span class="pi">:</span>
    <span class="na">inputs</span><span class="pi">:</span>
      <span class="na">rg_name</span><span class="pi">:</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">string</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s">Name of RG to deploy to</span>
        <span class="na">default</span><span class="pi">:</span> <span class="s">cd-ephemeral</span>
      <span class="na">location</span><span class="pi">:</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">string</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s">Location for ACI</span>
        <span class="na">default</span><span class="pi">:</span> <span class="s">southcentralus</span>
      <span class="na">subnet_id</span><span class="pi">:</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">string</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s">Subnet to create ACI on</span>
        <span class="na">default</span><span class="pi">:</span> <span class="s">/subscriptions/f12d732d-4a47-4edc-a11b-d6dc6909ddbe/resourceGroups/cd-ephemeral/providers/Microsoft.Network/virtualNetworks/private-vnet/subnets/default</span>
      <span class="na">aci_prefix</span><span class="pi">:</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">string</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s">Prefix for ACI name</span>
        <span class="na">default</span><span class="pi">:</span> <span class="s">cd-shrunner-aci</span>
      <span class="na">runner_image</span><span class="pi">:</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">string</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s">Image of runner container</span>
        <span class="na">default</span><span class="pi">:</span> <span class="s">ghcr.io/colindembovsky/ubuntu-actions-runner:6d7a59dfa95ec094a5fa8292bad01158c374e3ad</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">string</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s">Comma-separated list of labels to apply to the runner</span>
        <span class="na">required</span><span class="pi">:</span> <span class="no">true</span>
        
    <span class="na">secrets</span><span class="pi">:</span>
      <span class="na">azure_creds</span><span class="pi">:</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s">Azure credentials</span>
        <span class="na">required</span><span class="pi">:</span> <span class="no">true</span>
      <span class="na">repo_pat</span><span class="pi">:</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s">PAT with `repo` permissions</span>
        <span class="na">required</span><span class="pi">:</span> <span class="no">true</span>

<span class="na">jobs</span><span class="pi">:</span>
  <span class="na">deploy_runner</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">Deploy Ephemeral Runner</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">steps</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Login to Azure</span>
      <span class="na">uses</span><span class="pi">:</span> <span class="s">azure/login@v1</span>
      <span class="na">with</span><span class="pi">:</span>
        <span class="na">creds</span><span class="pi">:</span> <span class="s">${{ secrets.azure_creds }}</span>
    
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Create runner</span>
      <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
        <span class="s">az container create \</span>
          <span class="s">-g ${{ inputs.rg_name }} -n ${{ inputs.aci_prefix }}-${{ github.run_id }} \</span>
          <span class="s">--image ${{ inputs.runner_image }} --restart-policy Never \</span>
          <span class="s">--subnet ${{ inputs.subnet_id }} \</span>
          <span class="s">--environment-variables \</span>
            <span class="s">RUNNER_REPOSITORY_URL=https://github.com/${{ github.repository }} \</span>
            <span class="s">GITHUB_TOKEN=${{ secrets.repo_pat }} \</span>
            <span class="s">RUNNER_OPTIONS="--ephemeral" \</span>
            <span class="s">RUNNER_LABELS=${{ inputs.labels }} \</span>
            <span class="s">RUNNER_NAME=${{ inputs.aci_prefix }}-${{ github.run_id }}</span>

</code></pre></div></div><p class="figcaption">Workflow to deploy an ephemeral self-hosted runner to ACI.<p>Notes:<ol><li>We specify the <code class="language-plaintext highlighter-rouge">workflow_call</code> trigger in the <code class="language-plaintext highlighter-rouge">on</code> section to indicate that this is a reusable workflow.<li>We include an <code class="language-plaintext highlighter-rouge">inputs</code> for specifying the <code class="language-plaintext highlighter-rouge">rg_name</code> (resource group name), <code class="language-plaintext highlighter-rouge">location</code>, <code class="language-plaintext highlighter-rouge">subnet_id</code>, <code class="language-plaintext highlighter-rouge">aci_prefix</code> and <code class="language-plaintext highlighter-rouge">runner_image</code>. Most inputs are self-explanatory - we’ll append the <code class="language-plaintext highlighter-rouge">run_id</code> to the <code class="language-plaintext highlighter-rouge">aci_prefix</code> to ensure a unique ACI per workflow run.<li>We need to pass in two <code class="language-plaintext highlighter-rouge">secrets</code>: <code class="language-plaintext highlighter-rouge">azure_creds</code> (to authenticate to Azure) as well as <code class="language-plaintext highlighter-rouge">repo_pat</code> which is a GitHub Personal Access Token (PAT) that has <code class="language-plaintext highlighter-rouge">repo</code> priveledges. We need this to register the runner to the repo.<li>The first step authenticates to Azure.<li>The second step uses <code class="language-plaintext highlighter-rouge">az container create</code> to create the ACI using the inputs provided. A few callouts: we set the <code class="language-plaintext highlighter-rouge">--restart-policy</code> to <code class="language-plaintext highlighter-rouge">Never</code> since we don’t want the container to restart when the runner unregisters after completing a job. We attache the ACI to the specified subnet via the <code class="language-plaintext highlighter-rouge">subnet</code> argument. Finally, we pass in <code class="language-plaintext highlighter-rouge">--ephemeral</code> to mark the runner as ephemeral.</ol><h3 id="delete-aci">Delete ACI</h3><p>To delete the ACI after the runner has unregistered, we can use this reusable workflow:<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1"># file: 'delete-aci.yml'</span>
<span class="na">name</span><span class="pi">:</span> <span class="s">Delete ACI</span>

<span class="na">on</span><span class="pi">:</span>
  <span class="na">workflow_call</span><span class="pi">:</span>
    <span class="na">inputs</span><span class="pi">:</span>
      <span class="na">rg_name</span><span class="pi">:</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">string</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s">Name of RG to deploy to</span>
        <span class="na">default</span><span class="pi">:</span> <span class="s">cd-ephemeral</span>
      <span class="na">aci_prefix</span><span class="pi">:</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">string</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s">Prefix for ACI name</span>
        <span class="na">default</span><span class="pi">:</span> <span class="s">cd-shrunner-aci</span>
        
    <span class="na">secrets</span><span class="pi">:</span>
      <span class="na">azure_creds</span><span class="pi">:</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s">Azure credentials</span>
        <span class="na">required</span><span class="pi">:</span> <span class="no">true</span>

<span class="na">jobs</span><span class="pi">:</span>
  <span class="na">delete_aci</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">Delete ACI</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">steps</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">azure/login@v1</span>
      <span class="na">with</span><span class="pi">:</span>
        <span class="na">creds</span><span class="pi">:</span> <span class="s">${{ secrets.azure_creds }}</span>
    
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Delete ACI</span>
      <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
        <span class="s">az container delete -g ${{ inputs.rg_name }} -n ${{ inputs.aci_prefix }}-${{ github.run_id }} --yes</span>

</code></pre></div></div><p class="figcaption">Workflow to delete the ACI.<p>Notes:<ol><li>We pass in the <code class="language-plaintext highlighter-rouge">rg_name</code> and <code class="language-plaintext highlighter-rouge">aci_prefix</code> just like we did for the <code class="language-plaintext highlighter-rouge">Deploy ACI</code> workflow.<li>We pass in the <code class="language-plaintext highlighter-rouge">azure_creds</code> to authenticate to Azure.<li>After logging in to Azure, we invoke <code class="language-plaintext highlighter-rouge">az container delete</code> with <code class="language-plaintext highlighter-rouge">--yes</code> to delete the ACI completely.</ol><blockquote><p>Note: Just a reminder: at this stage, the runner has unregistered itself and the container is no longer running. We’re just cleaning up the ACI to ensure we are not billed for compute.</blockquote><h2 id="the-main-workflow">The Main Workflow</h2><p>Now that we have automation to spin up the ACI and tear it down, we can incorporate these jobs into our “main” workflow:<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1"># file: 'work.yml'</span>
<span class="na">name</span><span class="pi">:</span> <span class="s">Do Some Work</span>

<span class="na">on</span><span class="pi">:</span>
  <span class="na">workflow_dispatch</span><span class="pi">:</span>

<span class="na">jobs</span><span class="pi">:</span>
  <span class="c1"># deploy a runner for the job</span>
  <span class="na">deploy_runner</span><span class="pi">:</span>
    <span class="na">uses</span><span class="pi">:</span> <span class="s">colindembovsky/scaling-self-hosted-aci/.github/workflows/deploy-ephemeral-runner.yml@main</span>
    <span class="na">with</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span> <span class="s">uniqueString</span>
    <span class="na">secrets</span><span class="pi">:</span>
      <span class="na">azure_creds</span><span class="pi">:</span> <span class="s">${{ secrets.AZURE_CREDENTIALS }}</span>
      <span class="na">repo_pat</span><span class="pi">:</span> <span class="s">${{ secrets.REPO_PAT }}</span>
  
  <span class="c1"># do the real work</span>
  <span class="na">build</span><span class="pi">:</span>
    <span class="na">needs</span><span class="pi">:</span> <span class="s">deploy_runner</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="pi">[</span> <span class="nv">self-hosted</span><span class="pi">,</span> <span class="nv">uniqueString</span> <span class="pi">]</span>

    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v2</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Simulate some work</span>
        <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">sleep 10</span>

  <span class="na">delete_aci</span><span class="pi">:</span>
    <span class="na">needs</span><span class="pi">:</span> <span class="s">build</span>
    <span class="na">if</span><span class="pi">:</span> <span class="s">${{ always() }}</span>
    <span class="na">uses</span><span class="pi">:</span> <span class="s">colindembovsky/scaling-self-hosted-aci/.github/workflows/delete-aci.yml@main</span>
    <span class="na">secrets</span><span class="pi">:</span>
      <span class="na">azure_creds</span><span class="pi">:</span> <span class="s">${{ secrets.AZURE_CREDENTIALS }}</span>

</code></pre></div></div><p class="figcaption">The main workflow.<p>Notes:<ol><li>We invoke the deploy runner workflow which spins up a self-hosted runner in an ACI connected to our private VNet. To make sure that our job targets the correct runner, we add a <code class="language-plaintext highlighter-rouge">labels</code> value of <code class="language-plaintext highlighter-rouge">uniqueString</code>.<li>In the <code class="language-plaintext highlighter-rouge">build</code> job, we target any runner that has labels <code class="language-plaintext highlighter-rouge">self-hosted</code> and <code class="language-plaintext highlighter-rouge">uniqueString</code> (there should only be the one).<li>Steps executed here run on the self-hosted runner, that is connected to our private VNet, so it should be able to access resource on this VNet and any peered VNets.<li>The <code class="language-plaintext highlighter-rouge">delete_aci</code> job invokes the reusable workflow to clean up the ACI after the job complets. We add <code class="language-plaintext highlighter-rouge">if: $</code> to ensure that the job executes even if the <code class="language-plaintext highlighter-rouge">build</code> job fails.<li>We use <code class="language-plaintext highlighter-rouge">needs</code> to specify the ordering: first create the ACI hosting the runner, then execute the <code class="language-plaintext highlighter-rouge">build</code> and then only delete the ACI.</ol><h3 id="secrets">Secrets</h3><p>In order for this to work, you’ll need to configure <a href="https://github.com/marketplace/actions/azure-login">Azure Credentials</a> to the SPN that can create resources in the resource group and that has permissions to add interfaces to the subnet. You’ll also need to generate a GitHub PAT that has <code class="language-plaintext highlighter-rouge">repo</code> priveledges.<h2 id="analyzing-the-runs">Analyzing the Runs</h2><p>If you run the above workflow, you’ll have a small window of time where you can see the self-hosted runner (navigate to <strong>Settings-&gt;Actions-&gt;Runners</strong> on the repo):<p><img src="/assets/images/2021/10/self-hosted-runners/runner-registered.png" alt="Self-hosted runner registered after the ACI spins up" class="center-image" /><p class="figcaption">Self-hosted runner registered after the ACI spins up.<p>When the job completes, the runner unregisters itself and is no longer listed. Similarly, if you look at your Azure subscription, you’ll see the ACI spin up. If you click <strong>Containers</strong> and check the logs for the container, you’ll see the runner register and wait for jobs:<p><img src="/assets/images/2021/10/self-hosted-runners/runner-aci-ready.png" alt="Logs in ACI after spinning up" class="center-image" /><p class="figcaption">Logs in ACI after spinning up.<p>Once the job completes, the runner automatically unregisters. Again, looking at the logs you’ll see this operation:<p><img src="/assets/images/2021/10/self-hosted-runners/runner-unregistered.png" alt="Logs after completing the job" class="center-image" /><p class="figcaption">Logs after completing the job.<p>The ACI is then removed to complete the workflow.<p><img src="/assets/images/2021/10/self-hosted-runners/workflow-completed.png" alt="Completed workflow" class="center-image" /><p class="figcaption">The completed workflow. The “work” was to <code class="language-plaintext highlighter-rouge">sleep 120</code>.<p>Looking at the jobs, I recorded spinning the ACI took about 90 - 180 seconds. Tear down took approximately 30 seconds. All in all, we’re adding about 2 minutes total time to the job, but we don’t have any infrastructure to manage once the jobs complete. Not too bad to get an “on-demand” self-hosted agent!<h1 id="conclusion">Conclusion</h1><p>Hosted runners provide a very low overhead mechanism for running Actions. However, there are times when you need custom images or when you’re targeting private VNets, and in those situations you need to run a self-hosted agent. But this requires that you manage a container runtime (like Kubernetes) or manage VMs. However, if you are looking to deploy to private VNets or run jobs on custom images without having to manage long-lived runners, then using ACI to host ephemeral runners is a viable “on-demand” solution.<p>Happy building!</article><hr class="dingbat related mb6" /><aside class="comments related" role="complementary"><h2 class="hr-bottom">Comments</h2><div id="giscus"><div></div></div><script> function toggle_giscus() { const c = document.body.classList; const dark = c.contains("dark-mode") || "_sunset" in window && !c.contains("light-mode") && matchMedia("(prefers-color-scheme: dark)").matches; const theme = dark ? "dark" : "light"; const scriptEl = document.createElement("script"); scriptEl.src = "https://giscus.app/client.js"; scriptEl.setAttribute("data-repo", "colindembovsky/colindembovsky.github.io"); scriptEl.setAttribute("data-repo-id", "MDEwOlJlcG9zaXRvcnk0MDczMjI3MjU="); scriptEl.setAttribute("data-category", "Giscussions"); scriptEl.setAttribute("data-category-id", "DIC_kwDOGEdAZc4B_F18"); scriptEl.setAttribute("data-mapping", "pathname"); scriptEl.setAttribute("data-reactions-enabled", "1"); scriptEl.setAttribute("data-emit-metadata", "colindembovsky/colindembovsky.github.io"); scriptEl.setAttribute("data-theme", theme); scriptEl.setAttribute("crossorigin", "anonymous"); const container = document.getElementById("giscus"); const old = container.firstElementChild; container.removeChild(old); container.appendChild(scriptEl); } document.addEventListener("hydejack-dark-mode-toggle", function() { toggle_giscus(); }); toggle_giscus(); </script></aside><aside class="other-projects related mb0" role="complementary"><h2>Related Posts</h2><div class="columns"><div class="column column-1-2"><article class="project-card"> <a href="/pages/colindembovsky/musings-on-reusable-workflows/" class="no-hover no-print-link flip-project" tabindex="-1"><div class="project-card-img aspect-ratio sixteen-nine flip-project-img"> <img src="/pages/colindembovsky/assets/images/2021/10/reuse.jpeg" alt="Musings on GitHub Actions Reusable Workflows" width="864" height="486" loading="lazy"/></div></a><h3 class="project-card-title flip-project-title"> <a href="/pages/colindembovsky/musings-on-reusable-workflows/" class="flip-title">Musings on GitHub Actions Reusable Workflows</a></h3><p class="project-card-text fine" property="disambiguatingDescription"> Newly released Reusable Workflows allows you to reuse workflows in your GitHub workflows. While this still has some limitations, it’s still better than copy/paste! <a class="fill-card no-hover" href="/pages/colindembovsky/musings-on-reusable-workflows/" tabindex="-1"><span class="sr-only">Continue reading Musings on GitHub Actions Reusable Workflows</span></a></article></div><div class="column column-1-2"><article class="project-card"> <a href="/pages/colindembovsky/azdo-create-work-item-action/" class="no-hover no-print-link flip-project" tabindex="-1"><div class="project-card-img aspect-ratio sixteen-nine flip-project-img"> <img src="/pages/colindembovsky/assets/images/posts/azdo.png" alt="Create Azure DevOps Work Item Action" width="864" height="486" loading="lazy"/></div></a><h3 class="project-card-title flip-project-title"> <a href="/pages/colindembovsky/azdo-create-work-item-action/" class="flip-title">Create Azure DevOps Work Item Action</a></h3><p class="project-card-text fine" property="disambiguatingDescription"> If you’re managing backlogs in Azure Boards but using GitHub Actions for CI/CD, you may have scenarios where you want to create Work Items from an Action. <a class="fill-card no-hover" href="/pages/colindembovsky/azdo-create-work-item-action/" tabindex="-1"><span class="sr-only">Continue reading Create Azure DevOps Work Item Action</span></a></article></div></div></aside><aside class="related mb4" role="complementary"><h2 class="hr-bottom">Random Posts</h2><ul class="related-posts"><li class="h4"> <a href="/pages/colindembovsky/terraform-all-the-things-with-vsts/" class="flip-title"><span>Terraform all the Things with VSTS</span></a> <time class="faded fine" datetime="2018-08-08T01:08:54+00:00">08 Aug 2018</time><li class="h4"> <a href="/pages/colindembovsky/custom-build-task-include-merged-changesets-and-work-items-in-build-report/" class="flip-title"><span>Custom Build Task: Include Merged Changesets (and Work Items) in Build Report</span></a> <time class="faded fine" datetime="2013-02-04T08:00:00+00:00">04 Feb 2013</time><li class="h4"> <a href="/pages/colindembovsky/jspm-npm-gulp-and-webdeploy-in-a-teambuild/" class="flip-title"><span>JSPM, NPM, Gulp and WebDeploy in a TeamBuild</span></a> <time class="faded fine" datetime="2015-03-17T17:00:27+00:00">17 Mar 2015</time></ul></aside><footer class="content" role="contentinfo"><hr/><p><small class="copyright">© 2021. All rights reserved. </small><hr class="sr-only"/></footer></main><hy-drawer id="_drawer" class="" side="left" threshold="10" noscroll ><header id="_sidebar" class="sidebar" role="banner"><div class="sidebar-bg sidebar-overlay" style="background-color:rgb(5,19,24);background-image:url(/pages/colindembovsky/assets/img/sidebar-bg.jpg)"></div><div class="sidebar-sticky"><div class="sidebar-about"> <a class="no-hover" href="/pages/colindembovsky/" tabindex="-1"> <img src="/pages/colindembovsky/assets/img/logo.png" class="avatar" alt="Colin's ALM Corner" width="120" height="120" loading="lazy" /> </a> <a class="sidebar-title" href="/pages/colindembovsky/"><h2 class="h1">Colin's ALM Corner</h2></a><p class=""> DevOpsology &amp; GitHub. <br /> <em>Opinions my own</em>.</div><nav class="sidebar-nav heading" role="navigation"> <span class="sr-only">Navigation:</span><ul><li> <a id="_drawer--opened" href="/pages/colindembovsky/tags/" class="sidebar-nav-item " > Tags </a><li> <a href="/pages/colindembovsky/about/" class="sidebar-nav-item " > About </a></ul></nav><div class="sidebar-social"> <span class="sr-only">Social:</span><ul><li> <a href="https://twitter.com/colindembovsky" title="Twitter" class="no-mark-external"> <span class="icon-twitter"></span> <span class="sr-only">Twitter</span> </a><li> <a href="https://github.com/colindembovsky" title="GitHub" class="no-mark-external"> <span class="icon-github"></span> <span class="sr-only">GitHub</span> </a><li> <a href="https://colinsalmcorner.com/feed.xml" title="RSS" class="no-mark-external"> <span class="icon-rss2"></span> <span class="sr-only">RSS</span> </a></ul></div></div></header></hy-drawer><hr class="sr-only" hidden /> </hy-push-state> <!--[if gt IE 10]><!----> <script nomodule>!function(){var t,n=document.createElement("script");!("noModule"in n)&&"onbeforeload"in n&&(t=!1,document.addEventListener("beforeload",function(e){if(e.target===n)t=!0;else if(!e.target.hasAttribute("nomodule")||!t)return;e.preventDefault()},!0),n.type="module",n.src=".",document.head.appendChild(n),n.remove())}(); </script> <script src="/pages/colindembovsky/assets/js/hydejack-9.1.4.js" type="module"></script> <script src="/pages/colindembovsky/assets/js/LEGACY-hydejack-9.1.4.js" nomodule defer></script> <script type="module"> if ('serviceWorker' in navigator) { /**/ navigator.serviceWorker.getRegistration() .then(r => r.unregister()) .catch(() => {}); /**/ } </script> <!--<![endif]--><div hidden><h2 class="sr-only">Templates (for web app):</h2><clap-config> <clap-text at="1">Keep going!</clap-text> <clap-text at="2">Keep going ×2!</clap-text> <clap-text at="3">Give me more!</clap-text> <clap-text at="5">Thank you, thank you</clap-text> <clap-text at="7">Far too kind!</clap-text> <clap-text at="10">Never gonna give me up?</clap-text> <clap-text at="14">Never gonna let me down?</clap-text> <clap-text at="20">Turn around and desert me!</clap-text> <clap-text at="30">You're an addict!</clap-text> <clap-text at="40">Son of a clapper!</clap-text> <clap-text at="50">No way</clap-text> <clap-text at="60">Go back to work!</clap-text> <clap-text at="70">This is getting out of <em>hand</em></clap-text> <clap-text at="80">Unbelievable</clap-text> <clap-text at="90">PREPOSTEROUS</clap-text> <clap-text at="100">I N S A N I T Y</clap-text> <clap-text at="185"><span style="font-family:monospace">FEED ME A STRAY CAT</span></clap-text> </clap-config> <template id="_animation-template"><div class="animation-main fixed-top"><nav id="breadcrumbs" class="screen-only"><ul></ul></nav><div class="content"><div class="page"></div></div></div></template> <template id="_loading-template"><div class="loading nav-btn fr"> <span class="sr-only">Loading…</span> <span class="icon-cog"></span></div></template> <template id="_error-template"><div class="page"><h1 class="page-title">Error</h1><p class="lead"> Sorry, an error occurred while loading <a class="this-link" href=""></a>.</div></template> <template id="_permalink-template"> <a href="#" class="permalink"> <span class="sr-only">Permalink</span> <span class="content-hash"></span> </a> </template> <template id="_cookies-banner-template"><div id="_cookies-banner" class="navbar fixed-bottom CookiesOK"><div class="content"><div class="nav-btn-bar"> <small class="faded"> <span>This site uses cookies. <a href="/cookies-policy/">Cookies Policy</a>. </span> <button id="_cookies-ok" class="btn btn-primary btn-sm">Okay</button> </small></div></div></div></template> <template id="_dark-mode-template"> <button id="_dark-mode" class="nav-btn no-hover" > <span class="sr-only">Dark Mode</span> <span class="icon-brightness-contrast"></span> </button> </template> <template id="_search-template"> <button id="_search" class="nav-btn no-hover"> <label class="sr-only" for="_search-input">Search</label> <span class="icon-search"></span> </button><div id="_search-box"><div class="nav-btn"> <span class="icon-search"></span></div><input id="_search-input" type="search" class="form-control form-control-lg nav-btn" placeholder="Type something…" /> <button type="reset" class="nav-btn no-hover"> <span class="sr-only">Close</span> <span class="icon-cross"></span> </button></div><div id="_hits"></div></template></div></html>
