<!DOCTYPE html>
<html lang="en"><head><title>Tips and Tricks for Complex IaaS Deployments Using VSTS Deployment Groups | Colin’s ALM Corner</title><meta name="generator" content="Jekyll v3.9.0" /><meta property="og:title" content="Tips and Tricks for Complex IaaS Deployments Using VSTS Deployment Groups" /><meta name="author" content="Colin Dembovsky" /><meta property="og:locale" content="en" /><meta name="description" content="Recently I was working with a customer that was struggling with test environments. Their environments are complex and take many weeks to provision and configure - so they are generally kept around even though some of them are not frequently used. Besides a laborious, error-prone manual install and configuration process that usually takes over 10 business days, the team has to maintain all the clones of this environment. This means that at least two senior team members are required just to maintain existing dev and test environments as well as create new ones." /><meta property="og:description" content="Recently I was working with a customer that was struggling with test environments. Their environments are complex and take many weeks to provision and configure - so they are generally kept around even though some of them are not frequently used. Besides a laborious, error-prone manual install and configuration process that usually takes over 10 business days, the team has to maintain all the clones of this environment. This means that at least two senior team members are required just to maintain existing dev and test environments as well as create new ones." /><link rel="canonical" href="https://github.com/pages/colindembovsky/tips-and-tricks-for-complex-iaas-deployments-using-vsts-deployment-groups/" /><meta property="og:url" content="https://github.com/pages/colindembovsky/tips-and-tricks-for-complex-iaas-deployments-using-vsts-deployment-groups/" /><meta property="og:site_name" content="Colin’s ALM Corner" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2017-12-31T13:55:50+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Tips and Tricks for Complex IaaS Deployments Using VSTS Deployment Groups" /><meta name="twitter:site" content="@colindembovsky" /><meta name="twitter:creator" content="@colindembovsky" /> <script type="application/ld+json"> {"description":"Recently I was working with a customer that was struggling with test environments. Their environments are complex and take many weeks to provision and configure - so they are generally kept around even though some of them are not frequently used. Besides a laborious, error-prone manual install and configuration process that usually takes over 10 business days, the team has to maintain all the clones of this environment. This means that at least two senior team members are required just to maintain existing dev and test environments as well as create new ones.","url":"https://github.com/pages/colindembovsky/tips-and-tricks-for-complex-iaas-deployments-using-vsts-deployment-groups/","@type":"BlogPosting","headline":"Tips and Tricks for Complex IaaS Deployments Using VSTS Deployment Groups","dateModified":"2017-12-31T13:55:50+00:00","datePublished":"2017-12-31T13:55:50+00:00","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://github.com/pages/colindembovsky/assets/img/logo.png"},"name":"Colin Dembovsky"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://github.com/pages/colindembovsky/tips-and-tricks-for-complex-iaas-deployments-using-vsts-deployment-groups/"},"author":{"@type":"Person","name":"Colin Dembovsky"},"@context":"https://schema.org"}</script><meta name="keywords" content="devops,github,actions,build,ci,cd"><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Colin's ALM Corner"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="application-name" content="Colin's ALM Corner"><meta name="theme-color" content="rgb(5,19,24)"><meta name="generator" content="Hydejack v9.1.4" /><link rel="alternate" href="https://github.com/pages/colindembovsky/tips-and-tricks-for-complex-iaas-deployments-using-vsts-deployment-groups/" hreflang="en"><link type="application/atom+xml" rel="alternate" href="https://github.com/pages/colindembovsky/feed.xml" title="Colin's ALM Corner" /><link rel="shortcut icon" href="/pages/colindembovsky/assets/icons/favicon.ico"><link rel="apple-touch-icon" href="/pages/colindembovsky/assets/icons/icon-192x192.png"><link rel="manifest" href="/pages/colindembovsky/assets/site.webmanifest"><link rel="dns-prefetch" href="https://fonts.googleapis.com"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preload" href="/pages/colindembovsky/assets/img/swipe.svg" as="image" id="_hrefSwipeSVG"><link rel="dns-prefetch" href="/pages/colindembovsky/assets/js/search-worker-9.1.4.js" as="worker" id="_hrefSearch"> <script>!function(r,c){"use strict";function a(e,t,n,o){e.addEventListener?e.addEventListener(t,n,o):e.attachEvent?e.attachEvent("on"+t,n):e["on"+t]=n}r.loadJS=function(e,t){var n=c.createElement("script");n.src=e,t&&a(n,"load",t,{once:!0});t=c.scripts[0];return t.parentNode.insertBefore(n,t),n},r._loaded=!1,r.loadJSDeferred=function(e,t){var n=c.createElement("script");function o(){r._loaded=!0,t&&a(n,"load",t,{once:!0});var e=c.scripts[0];e.parentNode.insertBefore(n,e)}return n.src=e,r._loaded?o():a(r,"load",o,{once:!0}),n},r.setRel=r.setRelStylesheet=function(e){a(c.getElementById(e),"load",function(){this.rel="stylesheet"},{once:!0})}}(window,document); !function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this); !function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this); !function(w) { w._baseURL = '/pages/colindembovsky/'; w._publicPath = '/pages/colindembovsky/assets/js/'; w._noPushState = false; w._noDrawer = false; w._noNavbar = false; w._noToc = false; w._noSearch = false; w._advertise = false; w._search = { DATA_URL: '/pages/colindembovsky/assets/sitedata.json?no-cache', STORAGE_KEY: 'mini-search/pages/colindembovsky/', INDEX_KEY: 'index--2021-11-18T20:23:33+00:00', }; w._clapButton = false; }(window);</script> <script async src="/pages/colindembovsky/assets/bower_components/MathJax/es5/tex-mml-chtml.js" id="_MathJax"></script> <!--[if gt IE 8]><!----><style id="_styleInline"> .clearfix,.sidebar-social::after{content:"";display:table;clear:both}.color-transition,body,p,hr,.hr,.hr-after::after,.hr-bottom,.message,.note-sm,.note,#markdown-toc,.navbar,.nav-btn-bar,.nav-btn,.content .avatar{transition:none}#_dark-mode{font-size:1.25rem}@media screen{body.light-mode{--body-color: #333;--body-bg: #fff;--border-color: #ebebeb;--gray: #777;--gray-bg: rgba(0,0,0,0.025);--gray-text: #666;--menu-text: #bbb;--inv-body-color: #ccc;--inv-body-bg: var(--dark-mode-body-bg)}body.light-mode .content{-webkit-font-smoothing:initial;-moz-osx-font-smoothing:initial}body.dark-mode{--body-color: #ccc;--body-bg: var(--dark-mode-body-bg);--border-color: var(--dark-mode-border-color);--gray: rgba(255,255,255,.5);--gray-bg: rgba(255,255,255,.033);--gray-text: rgba(255,255,255,.625);--menu-text: rgba(255,255,255,.25);--inv-body-color: #333;--inv-body-bg: #fff}body.dark-mode .content{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}}@media screen and (prefers-color-scheme: dark){body{--body-color: #ccc;--body-bg: var(--dark-mode-body-bg);--border-color: var(--dark-mode-border-color);--gray: rgba(255,255,255,.5);--gray-bg: rgba(255,255,255,.033);--gray-text: rgba(255,255,255,.625);--menu-text: rgba(255,255,255,.25);--inv-body-color: #333;--inv-body-bg: #fff}body .content{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.tippy-content{-webkit-font-smoothing:initial;-moz-osx-font-smoothing:initial}}html{--font-family: Noto Sans,Helvetica,Arial,sans-serif;--font-family-heading: Roboto Slab,Helvetica,Arial,sans-serif;--code-font-family: Fira Code,Menlo,Monaco,Consolas,monospace;--body-color: #333;--body-bg: #fff;--border-color: #ebebeb;--gray: #777;--gray-bg: rgba(0,0,0,0.025);--gray-text: #666;--menu-text: #bbb;--inv-body-color: #ccc;--inv-body-bg: var(--dark-mode-body-bg);--root-font-size: 15px;--root-font-size-medium: 16px;--root-font-size-large: 17px;--root-font-size-print: 8pt;--root-line-height: 1.75;--font-weight: 400;--font-weight-bold: 700;--font-weight-heading: 700;--content-width-5: 54rem;--content-margin-5: 4rem;--sidebar-width: 21rem;--half-content: 31rem;--break-point-3: 64em;--break-point-5: 86em;--break-point-dynamic: 1664px}html .content{-webkit-font-smoothing:initial;-moz-osx-font-smoothing:initial}*{box-sizing:border-box}html,body{margin:0;padding:0}html{font-family:var(--font-family);font-size:var(--root-font-size);line-height:var(--root-line-height)}body{color:var(--body-color);background-color:var(--body-bg);font-weight:var(--font-weight);overflow-y:scroll}.content img,.img,.content video,.video{max-width:100%;height:auto}.lead{margin-left:-1rem;margin-right:-1rem;margin-bottom:1.5rem}img.lead,video.lead{display:block;max-width:calc(100% + 2rem);width:calc(100% + 2rem);height:auto}.heading,.f1,h1,.h1,.f2,h2,.h2,.f3,h3,.h3,.f4,h4,.h4,.post-date,.sidebar-nav-item,.f5,h5,.h5,.f6,h6,.h6{font-family:var(--font-family-heading);font-weight:var(--font-weight-heading)}.f1,h1,.h1{font-size:2rem;line-height:1.3}.f2,h2,.h2{font-size:1.5rem;line-height:1.4}.f3,h3,.h3{font-size:1.2em;line-height:1.5}.f4,h4,.h4,.post-date,.sidebar-nav-item{font-size:1.08rem;line-height:1.6}.f5,h5,.h5{font-size:1.04rem;line-height:1.7}.f6,h6,.h6{font-size:1rem}.content h1>a,.content .h1>a{text-decoration:none;border-bottom:none}@media screen and (max-width: 42em){.content h1,.content .h1{font-size:1.7rem;line-height:1.35}}@media screen and (min-width: 86em){.content h1,.content .h1{font-size:2.4rem;line-height:1.25}}@media screen and (min-width: 1664px){body:not(.no-large-headings) .content h1,body:not(.no-large-headings) .content .h1{width:calc(100% + 50vw - 32rem);font-size:3rem;line-height:1.2}}@media screen and (min-width: 124em){body:not(.no-large-headings) .content h1,body:not(.no-large-headings) .content .h1{font-size:4rem;line-height:1.1}}h1,h2,h3,.h1,.h2,.h3{margin:4rem 0 1rem}h4,h5,h6,.h4,.post-date,.h5,.h6{margin:3rem 0 .5rem}p{margin-top:0;margin-bottom:1rem}p.lead{font-size:1.2em;margin-top:1.5rem;margin-bottom:1.5rem;padding:0 1rem}ul,ol,dl{margin-top:0;margin-bottom:1rem}ul,ol{padding-left:1.25rem}hr,.hr{border:0;margin:1rem 0;border-top:1px solid var(--border-color)}.hr-after::after{content:"";display:block;margin:1rem 0;border-top:1px solid var(--border-color)}.hr-bottom{border-bottom:1px solid var(--border-color);padding-bottom:.75rem;margin-bottom:1rem}.page{margin-bottom:3em}.page li+li{margin-top:.25rem}.page>header{position:relative;margin-bottom:1.5rem}@media screen and (min-width: 1664px){body:not(.no-third-column) .page>header>.lead+.note-sm,body:not(.no-third-column) .page>header>.lead+.note,body:not(.no-third-column) .page>header>.lead+#markdown-toc,body:not(.no-third-column) .page>header>a.no-hover+.note-sm,body:not(.no-third-column) .page>header>a.no-hover+.note,body:not(.no-third-column) .page>header>a.no-hover+#markdown-toc{position:absolute;right:-25rem;width:21rem;bottom:0;margin-bottom:0}}.page-title,.post-title{margin-top:0}.post-date{display:flex;justify-content:space-between;margin-top:-.6rem;height:2rem;margin-bottom:.85rem;color:var(--gray)}.post-date>.ellipsis,#breadcrumbs.post-date>ul{cursor:pointer}.post-date [class^="icon-"]{display:inline-block;font-size:smaller;margin-right:.25rem}.related-posts{padding-left:0;list-style:none;margin-bottom:2rem}.related-posts>li,.related-posts>li+li{margin-top:1rem}.message,.note-sm,.note,#markdown-toc{margin-bottom:1rem;padding:1rem;color:var(--gray-text);background-color:var(--gray-bg);margin-left:-1rem;margin-right:-1rem}.note-sm,.note,#markdown-toc{background:transparent;color:var(--body-color);font-size:smaller;border-left:1px solid var(--border-color);padding:1.2rem 1rem 0 1rem;margin:1rem -1rem;position:relative}.note-sm:before,.note:before,#markdown-toc:before{font-size:0.667rem;font-weight:bold;font-style:normal;letter-spacing:.025rem;text-transform:uppercase;color:var(--menu-text);position:absolute;top:0}.note-sm[title]:before,[title].note:before,[title]#markdown-toc:before{content:attr(title) !important}.note{font-size:1rem}@media screen{body::before{content:'';width:.5rem;background:var(--gray-bg);position:fixed;left:0;top:0;bottom:0}}@media (min-width: 64em){body::before{width:21rem}}@media (min-width: 1664px){body::before{width:calc(50% - 31rem)}}@media screen and (min-width: 42em){html{font-size:var(--root-font-size-medium)}}@media screen and (min-width: 124em){html{font-size:var(--root-font-size-large)}}#breadcrumbs>ul{height:1rem;margin:-1.5rem 0 .5rem;padding:0;font-size:.667rem;color:var(--menu-text);text-transform:uppercase;width:100%;list-style:none}#breadcrumbs>ul>li{display:inline}#breadcrumbs>ul>li a{color:var(--gray);text-decoration:none;border-bottom:none}.fl{float:left}.fr{float:right}.mb4{margin-bottom:4rem}.mb6{margin-bottom:6rem}.mt0{margin-top:0}.mt1{margin-top:1rem}.mt2{margin-top:2rem}.mt3{margin-top:3rem}.mt4{margin-top:4rem}.pb0{padding-bottom:0}.ml1{margin-left:1rem}.mr1{margin-right:1rem}.sixteen-nine{position:relative}.sixteen-nine::before{display:block;content:"";width:100%;padding-top:56.25%}.sixteen-nine>*{position:absolute;top:0;left:0;right:0;bottom:0}.sixteen-ten{position:relative}.sixteen-ten::before{display:block;content:"";width:100%;padding-top:62.5%}.sixteen-ten>*{position:absolute;top:0;left:0;right:0;bottom:0}.four-three{position:relative}.four-three::before{display:block;content:"";width:100%;padding-top:75%}.four-three>*{position:absolute;top:0;left:0;right:0;bottom:0}.sr-only{display:none}.larger{font-size:larger}.smaller{font-size:smaller}.clearfix,.sidebar-social::after{content:"";display:table;clear:both}.ellipsis,#breadcrumbs>ul{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.border{border:1px solid var(--border-color)}@media (min-width: 42em){.border-radius,.lead,.page .aspect-ratio.sixteen-nine.lead{border-radius:.5rem}}.fallback-img{background-position:center;background-repeat:no-repeat;background-image:url("data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4KPHN2ZyB3aWR0aD0iMTYwIiBoZWlnaHQ9IjkwIiB2aWV3Qm94PSIwIDAgMTYwIDkwIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgogIDxnIHRyYW5zZm9ybT0ibWF0cml4KDAuMDQ4ODI4LCAwLCAwLCAwLjA0Nzk5MSwgNTQuOTk5OTczLCAyMC40MjgxNDgpIj4KICAgIDxwYXRoIHN0eWxlPSJmaWxsOnJnYmEoMTI4LDEyOCwxMjgsLjMzKSIgZD0iTTk1OS44ODQgMTI4YzAuMDQwIDAuMDM0IDAuMDgyIDAuMDc2IDAuMTE2IDAuMTE2djc2Ny43N2MtMC4wMzQgMC4wNDAtMC4wNzYgMC4wODItMC4xMTYgMC4xMTZoLTg5NS43N2MtMC4wNDAtMC4wMzQtMC4wODItMC4wNzYtMC4xMTQtMC4xMTZ2LTc2Ny43NzJjMC4wMzQtMC4wNDAgMC4wNzYtMC4wODIgMC4xMTQtMC4xMTRoODk1Ljc3ek05NjAgNjRoLTg5NmMtMzUuMiAwLTY0IDI4LjgtNjQgNjR2NzY4YzAgMzUuMiAyOC44IDY0IDY0IDY0aDg5NmMzNS4yIDAgNjQtMjguOCA2NC02NHYtNzY4YzAtMzUuMi0yOC44LTY0LTY0LTY0djB6Ii8+CiAgICA8cGF0aCBzdHlsZT0iZmlsbDpyZ2JhKDEyOCwxMjgsMTI4LC4zMykiIGQ9Ik04MzIgMjg4YzAgNTMuMDIwLTQyLjk4IDk2LTk2IDk2cy05Ni00Mi45OC05Ni05NiA0Mi45OC05NiA5Ni05NiA5NiA0Mi45OCA5NiA5NnoiLz4KICAgIDxwYXRoIHN0eWxlPSJmaWxsOnJnYmEoMTI4LDEyOCwxMjgsLjMzKSIgZD0iTTg5NiA4MzJoLTc2OHYtMTI4bDIyNC0zODQgMjU2IDMyMGg2NGwyMjQtMTkyeiIvPgogIDwvZz4KPC9zdmc+")}hy-push-state a{color:var(--body-color)}@supports not ((text-decoration-thickness: initial) and (text-underline-offset: initial)){hy-push-state a{text-decoration:none;border-bottom:2px solid}}@supports (text-decoration-thickness: initial) and (text-underline-offset: initial){hy-push-state a{text-decoration-style:solid;text-underline-offset:.35rem;text-decoration-thickness:2px}}hy-push-state a.no-hover{border-bottom:none;text-decoration-thickness:unset;text-underline-offset:unset}.content a:not(.btn):not(.no-hover){border-color:var(--accent-color-faded)}@supports (text-decoration-thickness: initial) and (text-underline-offset: initial){.content a:not(.btn):not(.no-hover){text-decoration-color:var(--accent-color-faded)}}.content .aspect-ratio{overflow:hidden}.content .aspect-ratio img{margin:0;width:100%;height:100%;background-color:var(--gray-bg)}hy-drawer{width:100%;position:relative;overflow:hidden;display:block;z-index:4}@media screen and (min-width: 64em){hy-drawer{position:fixed;width:21rem;top:0;left:0;bottom:0;margin-left:0}hy-drawer.cover{position:relative;width:100%}}@media screen and (min-width: 1664px){hy-drawer{width:calc(50% - 31rem)}}.sidebar{position:relative;display:flex;justify-content:center;align-items:center;color:rgba(255,255,255,0.75);text-align:center;min-height:100vh}.sidebar.invert{color:rgba(32,32,32,0.75)}.sidebar a{color:#fff;border-bottom-color:rgba(255,255,255,0.2);text-decoration-color:rgba(255,255,255,0.2)}.sidebar.invert a{color:#222;border-bottom-color:rgba(32,32,32,0.2);text-decoration-color:rgba(32,32,32,0.2)}.sidebar-bg{position:absolute;top:0;left:calc(50% - 50vw);width:100vw;height:100%;background:#202020 center / cover}.sidebar-bg::after{content:"";position:absolute;top:0;left:0;bottom:0;right:0;background:rgba(0,0,0,0.05)}.sidebar-bg.sidebar-overlay::after{background:linear-gradient(to bottom, rgba(32,32,32,0) 0%, rgba(32,32,32,0.5) 50%, rgba(32,32,32,0) 100%)}.sidebar-sticky{position:relative;z-index:3;max-width:21rem;padding:1.5rem;contain:content}.sidebar-about .avatar{margin-bottom:1.5rem}.sidebar-about>a.sidebar-title{text-decoration:none}.sidebar-about>a.sidebar-title>h2{margin:0;padding-bottom:.5rem}.sidebar-about>a.sidebar-title::after{content:'';display:block;border-bottom:2px solid;margin:0 auto .5rem;width:4rem;border-color:rgba(255,255,255,0.2);transition:border-color 250ms}.sidebar-about>a.sidebar-title:hover::after{border-color:#fff;transition:border-color 50ms}.sidebar.invert .sidebar-about>a.sidebar-title::after{border-color:rgba(32,32,32,0.2)}.sidebar.invert .sidebar-about>a.sidebar-title:hover::after{border-color:#222}.sidebar-nav>ul{list-style:none;padding-left:0}.sidebar-nav-item{display:inline-block;margin-bottom:.5rem}@media (min-width: 64em){#_main.no-drawer #_menu{display:none}#_main.no-drawer .nav-btn-bar>:nth-child(2){border:none}}.sidebar-social>ul{display:inline-block;list-style:none;padding-left:0;margin-bottom:0}.sidebar-social>ul>li{float:left}.sidebar-social>ul>li>a{display:inline-block;text-align:center;font-size:1.4rem;width:3rem;height:4rem;padding:.5rem 0;line-height:3rem;text-decoration:none;border-bottom-width:2px;border-bottom-style:solid}.sidebar-social>ul li+li{margin-top:0}.fixed-common,.fixed-top,.fixed-bottom{position:fixed;left:0;width:100%;z-index:2}.fixed-top{top:0}.fixed-bottom{bottom:0}.navbar>.content{position:relative;padding-top:0;padding-bottom:0;min-height:0;max-height:5rem}.nav-btn-bar{margin:0 -1rem;background-color:white;background-color:var(--body-bg);height:5rem;display:flex;align-items:center;position:relative}.nav-btn-bar>:first-child,.nav-btn-bar>:last-child{border:none}.nav-btn{background:none;border:none;text-decoration:none;display:flex;align-items:center;justify-content:center;width:3.25rem;height:5rem;color:var(--menu-text);border-right:1px solid var(--border-color);border-left:1px solid var(--border-color);margin-left:-1px}#markdown-toc{margin:2rem -1rem 2rem calc(-1rem + 1px);padding-left:2.5rem;padding-bottom:.5rem}#markdown-toc:before{left:1rem}@media screen and (min-width: 1664px){body:not(.no-toc) #markdown-toc{position:absolute;z-index:4;width:20.5rem;right:0;margin:auto;overflow:auto}}@media screen and (min-width: 1664px){body.no-break-layout:not(.no-toc) #markdown-toc{width:calc(50% - 31rem)}}.content{margin-left:auto;margin-right:auto;padding:8rem 1rem 12rem}@media screen{.content{padding-left:1.5rem;min-height:100vh}}@media screen and (min-width: 42em){.content{max-width:42rem}}@media screen and (min-width: 54em){.content{max-width:48rem}}@media screen and (min-width: 64em){.content{padding-left:1rem;margin-left:24rem;margin-right:3rem}}@media screen and (min-width: 86em){.content{padding-top:9rem;margin-left:25rem;margin-right:4rem;max-width:54rem}}@media screen and (min-width: 1664px){.content{margin:auto}}.large-only{display:none}@media screen and (min-width: 1664px){.large-only{display:block}}.avatar{width:7rem;height:7rem;border-radius:100%;overflow:hidden;display:inline-block}.avatar img{width:100%}.content .avatar{float:right;box-sizing:content-box;border:1rem solid var(--body-bg);transition:border-color 1s ease;margin-top:-1.5rem;margin-right:-1rem}hr.dingbat{display:none}.center-image{margin:auto;display:block}.note:before{content:"Note"}.page>header>.note-sm:before,.page>header>.note:before,.page>header>#markdown-toc:before{content:"Description"}#markdown-toc:before{content:"Table of Contents"}.layout-resume .note-sm:before,.layout-resume .note:before,.layout-resume #markdown-toc:before{content:"Summary"} .clearfix,main:not(.layout-resume) .columns::after{content:"";display:table;clear:both}.color-transition,main:not(.layout-resume) .project-card{transition:none}main:not(.layout-resume) .columns{margin-left:-1rem;display:flex;flex-wrap:wrap;contain:content;padding-top:1rem;margin-top:1rem;padding-right:1rem;margin-right:-1rem}main:not(.layout-resume) .column{float:left;padding-left:1rem;margin-bottom:2rem;width:100%;display:flex}@media screen and (min-width: 42em){main:not(.layout-resume) .columns{margin-left:-2rem;margin-right:-2rem}main:not(.layout-resume) .column-1-2{width:50%}}@media screen and (min-width: 1664px){main:not(.layout-resume) .columns-break{width:calc(50vw + 25rem)}main:not(.layout-resume) .columns-break>.column-1-2,main:not(.layout-resume) .columns-break>.column-1{width:27.5rem}}@media print{main:not(.layout-resume) .columns{display:block}main:not(.layout-resume) .column{display:block;width:50%}}main:not(.layout-resume) .project-card{width:100%;color:var(--gray-text);background-color:var(--gray-bg);padding-bottom:1rem;position:relative;overflow:hidden;box-shadow:0.125rem 0.125rem 1rem rgba(0,0,0,0.2);contain:content;border-radius:.5rem;page-break-inside:avoid;transition:transform 500ms ease;will-change:transform}main:not(.layout-resume) .project-card:hover{transform:translateY(-0.25rem);transition:transform 250ms ease}main:not(.layout-resume) .project-card>a.flip-project{display:block}main:not(.layout-resume) .project-card>a.flip-project .project-card-img{margin-bottom:0}main:not(.layout-resume) .project-card>a.flip-project .project-card-img img{display:block;border-top-left-radius:.5rem;border-top-right-radius:.5rem}main:not(.layout-resume) .project-card a{position:relative;z-index:1}main:not(.layout-resume) .project-card a.fill-card{position:absolute;top:0;left:0;right:0;bottom:0;z-index:0}main:not(.layout-resume) .project-card>.project-card-title,main:not(.layout-resume) .project-card>.project-card-text{text-align:center;padding:0 1rem}main:not(.layout-resume) .project-card>.project-card-title{display:block;font-size:1.08rem;margin-top:.75rem;margin-bottom:.25rem;color:inherit}main:not(.layout-resume) .project-card>.project-card-text{margin:.25rem 0}main:not(.layout-resume) .column-1>.project-card>.project-card-title{font-size:1.2rem}main:not(.layout-resume) .column-1>.project-card>.project-card-text{font-size:1rem}</style><link rel="preload" as="style" href="/pages/colindembovsky/assets/css/hydejack-9.1.4.css" id="_stylePreload"><link rel="preload" as="style" href="/pages/colindembovsky/assets/icomoon/style.css" id="_iconsPreload"><link rel="preload" as="style" href="https://fonts.googleapis.com/css?family=Roboto+Slab:700%7CNoto+Sans:400,400i,700,700i&display=swap" id="_fontsPreload"> <script> setRel('_stylePreload'); setRel('_iconsPreload'); /**/setRel('_fontsPreload');/**/ </script> <noscript><link rel="stylesheet" href="/pages/colindembovsky/assets/css/hydejack-9.1.4.css"><link rel="stylesheet" href="/pages/colindembovsky/assets/icomoon/style.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Slab:700%7CNoto+Sans:400,400i,700,700i&display=swap"> </noscript><style id="_pageStyle"> html{--accent-color: rgb(79, 129, 220);--accent-color-faded: rgba(79,129,220,0.5);--accent-color-highlight: rgba(79,129,220,0.1);--accent-color-darkened: #2f6ad6;--theme-color: rgb(5,19,24);--dark-mode-body-bg: #292e30;--dark-mode-border-color: #353c3e}</style><!--<![endif]--> <script async src="https://www.googletagmanager.com/gtag/js?id=G-FD31RTDXK2"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-FD31RTDXK2'); </script><body class="no-break-layout"> <script> window._sunrise = 6; window._sunset = 18; !function(e,s){var d="light-mode",o="dark-mode",a=(new Date).getHours();"matchMedia"in e&&e.matchMedia("(prefers-color-scheme)")||(o=(e=a<=e._sunrise||a>=e._sunset?o:d)==o?d:o,s.body.classList.add(e),s.body.classList.remove(o))}(window,document); </script> <hy-push-state id="_pushState" replace-selector="#_main" link-selector="a[href]:not([href^='/pages/colindembovsky/assets/']):not(.external):not(.no-push-state)" script-selector="script" duration="500" hashchange ><div id="_navbar" class="navbar fixed-top"><div class="content"> <span class="sr-only">Jump to:</span><div class="nav-btn-bar"> <a id="_menu" class="nav-btn no-hover" href="#_drawer--opened"> <span class="sr-only">Navigation</span> <span class="icon-menu"></span> </a><div class="nav-span"></div></div></div></div><hr class="sr-only" hidden /><main id="_main" class="content layout-post" role="main" ><nav id="breadcrumbs" class="screen-only"><ul><li><a href="/pages/colindembovsky/">home</a><li> <span>/</span> <span>tips-and-tricks-for-complex-iaas-deployments-using-vsts-deployment-groups</span></ul></nav><article id="post-tips-and-tricks-for-complex-iaas-deployments-using-vsts-deployment-groups" class="page post mb6" role="article"><header><h1 class="post-title flip-project-title"> Tips and Tricks for Complex IaaS Deployments Using VSTS Deployment Groups</h1><div class="post-date"> <span class="ellipsis mr1"> <time datetime="2017-12-31T13:55:50+00:00">31 Dec 2017</time> on <span>Releasemanagement</span>, <a href="/pages/colindembovsky/tag/devops/" class="flip-title">devops</a> </span></div><div class="hr pb0"></div></header><p>Recently I was working with a customer that was struggling with test environments. Their environments are complex and take many weeks to provision and configure - so they are generally kept around even though some of them are not frequently used. Besides a laborious, error-prone manual install and configuration process that usually takes over 10 business days, the team has to maintain all the clones of this environment. This means that at least two senior team members are required just to maintain existing dev and test environments as well as create new ones.<p>Using <a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-group-authoring-templates">Azure ARM templates</a> and VSTS <a href="https://docs.microsoft.com/en-us/vsts/build-release/concepts/definitions/release/what-is-release-management">Release Management</a> with <a href="https://docs.microsoft.com/en-us/vsts/build-release/concepts/definitions/release/deployment-groups/">Deployment Groups</a>, we were able to show how we could spin up the entire environment in just under two hours. That’s a 50x improvement in lead time! And it’s more consistent since the entire process is automated and the scripts are all source controlled so there’s auditability. This is a huge win for the team. Not only can they spin up an environment in a fraction of the time they are used to, they can now decommission environments that are not frequently used (some environments were only used twice a year). That means they have less maintenance to worry about. When they need an environment for a short time, they spin it up, used it and then throw it away. They’ve also disseminated “tribal knowledge” from a few team members’ heads to a button click - meaning anyone can create a new environment now.<p>This was my first time working with a larger scale provisioning and configuration project that uses Deployment Groups - and this post documents some of the lessons that we learned along the way.<h3 id="a-brief-glossary">A Brief Glossary</h3><p>Before we jump into the tips, I need to get some definitions out of the way. In VSTS, a Release Definition is made up of multiple Environments. Typically you see DEV, STAGE and PROD but you can have multiple “environments” that target the same set of machines. <!--kg-card-begin: html--><p><a href="/assets/images/files/d7bd08ff-5b27-47b4-b0f8-4aeb94295793.png"><img src="/assets/images/files/56561a03-700d-476e-9c63-7a6e90c7fa83.png" alt="image" title="image" /></a><!--kg-card-end: html--><p>The above VSTS release has three “environments”:<ul><li>Infrastructure Provision<li>Runs an ARM template to provision VMs, VNets, Storage and any other infrastructure required for the environment<li>Infrastructure Config<li>Configure the OS of each machine, DNS and any other “low-level” settings<li>App Install<li>Install and configure the application(s)</ul><p>This separation also allows you to run the “Infrastructure Provision” environment and then set it to a manual trigger and just trigger the config environment - particularly useful when you’re developing the pipeline, since you can skip environments that end up being no-ops but take a couple minutes to pass through.<p>Within an Environment, you can have 1..<em>n</em> phases. You specify tasks inside a phase - these are the smallest unit of work in the release. <!--kg-card-begin: html--><p><a href="/assets/images/files/2aa9823e-f332-4cbe-be09-427257de1fb8.png"><img src="/assets/images/files/50b0fd52-f99c-4a97-bbbf-2306512d0f68.png" alt="image" title="image" /></a><!--kg-card-end: html--><p>In the above image, there are several phases within the “Infrastructure Config” environment. Each phase (in this case) is running a single task, but you can run as many tasks as you need for that particular phase.<p>There are three types of phases: agentless, agent-based or deployment-group based. You can think of agentless phases as phases that are executed on VSTS. Agent-based phases are executed on agent(s) in a build or release queue. Deployment Group phases are executed on all agents (with optional tag matching) within the specified Deployment Group. The agent for agent-based or deployment-group based is the same agent under the hood - the difference is that deployment group agents are only referenced through the Deployment Group while build/release agents are accessed through queues. You’d typically use agent queues for build servers or for “proxy servers” in releases (where the tasks are executing on the proxy but acting on other machines). Deployment Groups are used when you don’t know the machines ahead of time - like when you’re spinning up a set of machines in the cloud on demand. They also allow you to target multiple machines at the same time.<p>The VSTS Deployment agent joins a machine (this can be any machine anywhere that can connect to VSTS) to a Deployment Group. The agent is cross-platform (runs on DotNET Core) so it can run on practically any machine anywhere. It connects out to VSTS meaning you don’t need to open incoming firewall ports at all. The agent runs on the machine and so any scripts you write can execute locally - which simplifies configuration dramatically. Executing remote instructions is typically much harder to do - you have to think about your connection and security and so on. Executing locally is much easier.<h2 id="tldr---the-top-10-tips-and-tricks">TL;DR - The Top 10 Tips and Tricks</h2><p>Here are my top 10 tips and tricks:<ol><li>Spin Up Azure VMs with the VSTS Deployment Agent Extension<li>This allows you to configure everything else locally on each machine<li>Use Tagging for Parallelization and Specialization<li>Tagging the VSTS agent allows you to repeat the same actions on many machines in parallel and/or distinguish machines for unique actions<li>Use Phases to Start New Sessions<li>Each phase in an Environment gets a new session, which is useful in a number of scenarios<li>Update Your PowerShell PackageProviders and Install DSC Modules<li>If you’re using DSC, install the modules in a separate step to ensure that they are available when you run DSC scripts. You may need to update your Package Providers for this to work<li>Install Azure PowerShell and use the <a href="https://github.com/Microsoft/vsts-tasks/tree/master/Tasks/AzurePowerShell">Azure PowerShell task</a><li>If you’re going to be doing any scripting to Azure, you can quickly install Azure PowerShell so that you can use the Azure PowerShell task<li>Use PowerShell DSC for OS Configuration<li>Configuring Windows Features, firewalls and so on is best done with PowerShell DSC<li>Use Plain PowerShell for Application Install and Config<li>Expressing application state can be challenging - so use “plain” PowerShell for application install and config<li>Attaching Data Disks in Azure VMs<li>If you add data disks in your ARM template, you still need to mount them in the OS of the VM<li>Configuring DNS on Azure VNets<li>If you create an Active Directory Domain Controller or DNS, you’ll need to do some other actions on the VNet too<li>Wait on machines when they reboot<li>If you reboot a machine and don’t pause, the subsequent deployment steps fail because the agent goes offline.</ol><p>In the next section I’ll dig into each tip.<h3 id="tip-1-spin-up-azure-vms-with-the-vsts-deployment-agent-extension">Tip 1: Spin Up Azure VMs with the VSTS Deployment Agent Extension</h3><p>You can install the VSTS Deployment Agent (or just “the agent” for the remainder of this post) on any machine using a simple script. The script downloads the agent binary and configures it to connect the agent to your VSTS account and to the specified Deployment Group. However, if you’re spinning up machines by using an ARM template, you can also install the agent via the VSTS extension. In order to do this you need a Personal Access Token (or PAT), the name of the VSTS account, the name of the Deployment Group and optionally some tags to tag the agent with. Tags will be important when you’re distinguishing between machines in the same Deployment Group later on. You’ll need to create the Deployment Group in VSTS before you run this step.<p>Here’s a snippet of an ARM template that adds the extension to the Deployment Group:<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
    "name": "[parameters('settings').vms[copyIndex()].name]",
    "type": "Microsoft.Compute/virtualMachines",
    "location": "[resourceGroup().location]",
    "apiVersion": "2017-03-30",
    "dependsOn": [
      ...
    ],
    "properties": {
      "hardwareProfile": {
        "vmSize": "[parameters('settings').vms[copyIndex()].size]"
      },
      "osProfile": {
        "computerName": "[parameters('settings').vms[copyIndex()].name]",
        "adminUsername": "[parameters('adminUsername')]",
        "adminPassword": "[parameters('adminPassword')]"
      },
      "storageProfile": {
        "imageReference": "[parameters('settings').vms[copyIndex()].imageReference]",
        "osDisk": {
          "createOption": "FromImage"
        },
        "dataDisks": [
            {
                "lun": 0,
                "name": "[concat(parameters('settings').vms[copyIndex()].name,'-datadisk1')]",
                "createOption": "Attach",
                "managedDisk": {
                    "id": "[resourceId('Microsoft.Compute/disks/', concat(parameters('settings').vms[copyIndex()].name,'-datadisk1'))]"
                }
            }
        ]
      },
      "networkProfile": {
        "networkInterfaces": [
          {
            "id": "[resourceId('Microsoft.Network/networkInterfaces', concat(parameters('settings').vms[copyIndex()].name, if(equals(parameters('settings').vms[copyIndex()].name, 'JumpBox'), '-nicpub', '-nic')))]"
          }
        ]
      }
    },
    "resources": [
      {
        "name": "[concat(parameters('settings').vms[copyIndex()].name, '/TeamServicesAgent')]",
        "type": "Microsoft.Compute/virtualMachines/extensions",
        "location": "[resourceGroup().location]",
        "apiVersion": "2015-06-15",
        "dependsOn": [
          "[resourceId('Microsoft.Compute/virtualMachines/', concat(parameters('settings').vms[copyIndex()].name))]"
        ],
        "properties": {
          "publisher": "Microsoft.VisualStudio.Services",
          "type": "TeamServicesAgent",
          "typeHandlerVersion": "1.0",
          "autoUpgradeMinorVersion": true,
          "settings": {
            "VSTSAccountName": "[parameters('vstsAccount')]",
            "TeamProject": "[parameters('vstsTeamProject')]",
            "DeploymentGroup": "[parameters('vstsDeploymentGroup')]",
            "Tags": "[parameters('settings').vms[copyIndex()].tags]"
          },
          "protectedSettings": {
            "PATToken": "[parameters('vstsPat')]"
          }
        }
      },
      ...
</code></pre></div></div><p>Notes:<ul><li>The extension is defined in the highlighted lines<li>The “settings” section of the extension is where you specify the VSTS account name, team project name, deployment group name and comma-separated list of tags for the agent. You also need to supply a PAT that has access to join machines to the Deployment Group<li>You can also specify a “Name” property if you want the agent name to be custom. By default it will be machineName-DG (so if the machine name is WebServer, the agent will be named WebServer-DG.</ul><p>Now you have a set of VMs that are bare-boned but have the VSTS agent installed. They are now ready for anything you want to throw at them - and you don’t need to worry about ports or firewalls or anything like that.<p>There are some useful extensions and patterns for configuring VMs such as <a href="https://docs.microsoft.com/en-us/azure/virtual-machines/windows/extensions-customscript">Custom Script</a> or <a href="https://azure.microsoft.com/en-us/resources/templates/201-vm-domain-join/">Join Domain</a>. The problem with these scripts is that the link to the script has to be either in a public place or in a blob store somewhere, or they assume existing infrastructure. This can complicate deployment. Either you need to publish your scripts publically or you have to deal with uploading scripts and generating SAS tokens. So I recommend just installing the VSTS agent and let it do everything else that you need to do - especially since the agent will download artifacts (like scripts and build binaries) as a first step in any deployment phase.<h3 id="tip-2-use-tagging-for-parallelization-and-specialization">Tip 2: Use Tagging for Parallelization and Specialization</h3><p>Tags are really important for Deployment Groups. They let you identify machines or groups of machines within a Deployment Group. Let’s say you have a load balanced application with two webservers and a SQL server. You’d probably want identical configuration for the webservers and a completely different configuration for the SQL server. In this case, tag two machines with WEBSERVER and the other machine with SQL. Then you’ll define the tasks in the phase  - when the phase runs, it executes all the tasks on all the machines that match the filter - for example, you can target all WEBSERVER machines with a script to configure IIS. These will execute in parallel (you can configure it to work serially if you want to) and so you’ll only specify the tasks a single time in the definition and you’ll speed up the deployment. <!--kg-card-begin: html--><p><a href="/assets/images/files/2d415fda-4852-4327-adcd-07bd80234a0e.png"><img src="/assets/images/files/5d918fca-64d5-4b20-a027-6afcb74dca7e.png" alt="image" title="image" /></a><!--kg-card-end: html--><p>Be careful though: multiple tags use AND (not OR) logic. This means if you want to do something like join a domain on machines with WEBSERVER and SQL, you would think you could specify WEBSERVER, SQL as the tag filter in the phase tag filter. But since the tags are joined with an AND, you’ll see the phase won’t match any machines. So you’d have to add a NODE tag (or something similar) and apply it to both webservers and SQL machine and then target NODE for things you want to do on all the machines. <!--kg-card-begin: html--><p><a href="/assets/images/files/d5c254eb-a976-47a4-a9eb-7b375a8d080c.png"><img src="/assets/images/files/0858d323-3c20-4bf1-9211-1d90279e32df.png" alt="image" title="image" /></a><!--kg-card-end: html--><p>The above image shows the tag filtering on the Phase settings. Note too the parallelization settings.<h3 id="tip-3-use-phases-to-start-new-sessions">Tip 3: Use Phases to Start New Sessions</h3><p>At my customer we were using Windows 2012 R2 machines. However, we wanted to use PowerShell DSC for configuring the VMs and you need Windows Management Framework 5.0 to get DSC. So we executed a PowerShell task to upgrade the PowerShell to 5.x:<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if ($PSVersionTable.PSVersion.Major -lt 5) {
    $powershell5Url = "https://go.microsoft.com/fwlink/?linkid=839516"
    wget -Uri $powershell5Url -OutFile "wmf51.msu"
    Start-Process .\wmf51.msu -ArgumentList '/quiet' -Wait
}
</code></pre></div></div><p>Notes:<ul><li>Line 1: This script checks the major version of the current PowerShell<li>Lines 2,3: If it’s less than 5, then the script downloads PowerShell 5.1 (the path to the installer can be update to whichever PowerShell version you need)<li>Line 4: The installer is invoked with the quiet parameter</ul><p>However, if we then called a task right after the update task, we’d still get the old PowerShell since all tasks within a phase are executed in <em>the same session</em>. We just added another phase with the same Deployment Group settings - the second phase started a new session and we got the upgraded PowerShell.<p>This doesn’t work for environment variables though. When you set machine environment variables, you have to restart the agent. The VSTS team are working on providing a task to do this, but for now you have to reboot the machine. We’ll cover how to do this in Tip 10.<h3 id="tip-4-update-your-powershell-packageproviders-and-install-dsc-modules">Tip 4: Update Your PowerShell PackageProviders and Install DSC Modules</h3><p>You really should be using PowerShell DSC to configure Windows. The notation is succinct and fairly easy to read and Windows plays nicely with DSC. However, if you’re using custom modules (like xNetworking) you have to ensure that the modules are installed. You can pre-install all the modules so that your scripts can assume the modules are already installed. To install modules you’ll need to update your Package Providers. Here’s how to do it:<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Import-Module PackageManagement
Install-PackageProvider -Name NuGet -MinimumVersion 2.8.5.201 -Force
</code></pre></div></div><p>You’ll need to start a new Phase in order to pick up the new packages. Then you’ll be able to install modules:<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Install-Module -Name xActiveDirectory -Force
Install-Module -Name xNetworking -Force
Install-Module -Name xStorage -Force
Install-Module -Name xDSCDomainjoin -Force
Install-Module -Name xComputerManagement -Force
</code></pre></div></div><p>Not all machines need all the modules, but this step is so quick I found it easier to just enumerate and install all the modules anyway. That way I know that any machine could run any DSC script I throw at it.<h3 id="tip-5-install-azure-powershell">Tip 5: Install Azure PowerShell</h3><p>If you’re going to do anything against Azure from the VMs (in our case we were downloading binaries from a blob store) then you’ll want to use the Azure PowerShell task. This task provides an authenticated context (via a preconfigured endpoint) so you don’t have to worry about adding passwords or anything to your script. However, for it to work, you’ll need to install Azure PowerShell. Again this must be a separate phase so that subsequent phases can make use of the Azure cmdlets. To do this simply add a PowerShell task and run this line of script: <!--kg-card-begin: html--> <font face="Courier New">Install-Module AzureRM -AllowClobber -Force</font> <!--kg-card-end: html--><h3 id="tip-6-use-powershell-dsc-for-os-configuration">Tip 6: Use PowerShell DSC for OS Configuration</h3><p>OS configuration can easily be specified by describing the state: is IIS installed or not? Which other OS roles are installed? So DSC is the perfect tool for this kind of work. You can use a single DSC script to configure a group of machines (or nodes, in DSC) but since we have the VSTS agent you can simply write your scripts for each machine using “node localhost”. DSC script are also (usually) idempotent - so they work no matter what state the environment is in when the script executes. No messy if statements to check various conditions - DSC does it for you.<p>When you’re doing DSC, you should first check if there is a “native” resource for your action - for example, configuring Windows Features uses the WindowsFeature resource. However, there are some custom actions you may want to perform. There are tons of extensions out there - we used xActiveDirectory to configure an Active Directory Domain Controller settings, for example.<p>There are times when you’ll want to do some custom work that there simply is no custom module for. In that case, you’ll need to use the Script resource. The script resource is composed of three parts: GetScript, TestScript and SetScript. GetScript is optional and should return the current state as an object if specified. TestScript should return a boolean - true for “the state is correct” or false for “the state is not correct”. If TestScript returns a false, then the SetScript is invoked. Here’s an example Script we wrote to configure SMB on a machine according to Security requirements:<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Script SMBConfig
{
	GetScript = { @{ Result = Get-SmbServerConfiguration } }
	TestScript =
	{
		$config = Get-SmbServerConfiguration
		$needConfig = $config.EnableSMB2Protocol -and (-not ($config.EnableSMB1Protocol))
		if ($needConfig) {
				Write-Host "SMB settings are not correct." 
		}
		$needConfig
	}
	SetScript =
	{
		Write-Host "Configuring SMB settings" 
		Set-SmbServerConfiguration -EnableSMB1Protocol $false -Force
		Set-SmbServerConfiguration -EnableSMB2Protocol $true -Force
	}
}
</code></pre></div></div><p>Notes:<ul><li>Line 1: Specify the type of resource (Script) and a unique name<li>Line 3: The GetScript returns an hash table with a Result property that describes the current state - in this case, the SMB settings on the machine<li>Line 4: The start of the TestScript<li>Line 6: Query the SMB settings<li>Line 7: Determine if we need to configure anything or not - this is a check on the SMBProtocol states<li>Lines 8-10: Write a message if we do need to set state<li>Line 11: return the bool: true if the state is correct, false otherwise<li>Lines 16-17: correct the state of the machine - in this case, set protocols accordingly</ul><h3 id="tip-7-use-plain-powershell-for-application-install-and-config">Tip 7: Use Plain PowerShell for Application Install and Config</h3><p>Expressing application state and configuration as a DSC script can be challenging. I once wrote some DSC that could <a href="/install-and-configure-sql-server-using-powershell-dsc">install SQL</a>. However, I ended up using a Script resource - and the TestScript just checked to see if a SQL service was running. This check isn’t enough to determine if SQL features are installed according to some config.<p>Instead of writing long Script resources, I just revert to “plain” PowerShell for app install and configuration. This is especially true for more complicated apps. Just make sure your script are <em>idempotent</em> - that is that they can run and succeed every time. For example, if you’re installing a service, you may want to first check to see if the service exists before running the installer (otherwise the installer may fail since the service already exists). This allows you to re-run scripts again if other scripts fail.<h3 id="tip-8-attaching-data-disks-in-azure-vms">Tip 8: Attaching Data Disks in Azure VMs</h3><p>If you’re creating data disks for your VMs, then you usually specify the size and type of disk in the ARM template. But even if you add a disk, you need to attach it in the OS. To do this, I used the <a href="https://github.com/PowerShell/xStorage">xStorage DSC extension</a>. This requires a disk number. When we started, the data disk was always disk 2. Later, we added <a href="https://docs.microsoft.com/en-us/azure/security/azure-security-disk-encryption">Azure Disk Encryption</a> - but this added another disk and so our disk numbers were off. We ended up needing to add some logic to determine the data disk number and pass that in as a parameter to the DSC configuration:<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Configuration DiskConfig
{
	param
	(
		[Parameter(Mandatory)]
		[string]$dataDiskId
	)

	# import DSC Resources 
	Import-DscResource -ModuleName PSDscResources
	Import-DscResource -ModuleName xStorage

	Node localhost
	{
        LocalConfigurationManager
		{
			ActionAfterReboot = 'ContinueConfiguration'
			ConfigurationMode = 'ApplyOnly'
			RebootNodeIfNeeded = $true
		}

        xWaitforDisk DataDisk
        {
            DiskId = $dataDiskId
            RetryIntervalSec = 60
            RetryCount = 3
        }

        xDisk FVolume
        {
            DiskId = $dataDiskId
            DriveLetter = 'F'
            FSLabel = 'Data'
            DependsOn = "[xWaitforDisk]DataDisk"
        }
    }
}

# work out what disk number the data disk is on
$dataDisks = Get-Disk -FriendlyName "Microsoft Virtual Disk" -ErrorAction SilentlyContinue
if ($dataDisk -eq $null) {
	$dataDisk = Get-Disk -FriendlyName "Microsoft Storage Space Device" -ErrorAction SilentlyContinue
}
# filter to GPT partitions
$diskNumber = 2
Get-Disk | Out-Host -Verbose
$dataDisk = Get-Disk | ? { $_.PartitionStyle -eq "RAW" -or $_.PartitionStyle -eq "GPT" }
if ($dataDisk -eq $null) {
	Write-Host "Cannot find any data disks"
} else {
	if ($dataDisk.GetType().Name -eq "Object[]") {
		Write-Host "Multiple data disks"
		$diskNumber = $dataDisk[0].Number
	} else {
		Write-Host "Found single data disk"
		$diskNumber = $dataDisk.Number
	}
}
Write-Host "Using $diskNumber for data disk mounting"

DiskConfig -ConfigurationData .\ConfigurationData.psd1 -dataDiskId "$($diskNumber)"
Start-DscConfiguration -Wait -Force -Path .\DiskConfig -Verbose 
</code></pre></div></div><p>Notes:<ul><li>Lines 3-7: We specify that the script requires a dataDiskId parameter<li>Lines 11,12: Import the modules we need<li>Lines 23-28: Wait for disk with number $dataDiskId to be available (usually it was immediately anyway)<li>Lines 30-36: Mount the disk and assign drive letter F with a label of Data<li>Lines 41-43: Get potential data disks<li>Lines 46-59: Calculate the data disk number, defaulting to 2<li>Lines 62,63: Compile the DSC and the invoke the configuration manager to “make it so”</ul><h3 id="tip-9-configuring-dns-on-azure-vnets">Tip 9: Configuring DNS on Azure VNets</h3><p>In our example, we needed a Domain Controller to be on one of the machines. We were able to configure the domain controller using DSC. However, I couldn’t get the other machines to join the domain since they could never find the controller. Eventually I realized the problem was a DNS problem. So we added the DNS role to the domain controller VM. We also added a private static IP address for the domain controller so that we could configure the VNet accordingly. Here’s a snippet of the DSC script for this:<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>WindowsFeature DNS
{
        Ensure = "Present"
        Name = "DNS"
        DependsOn = "[xADDomain]ADDomain"
}

xDnsServerAddress DnsServerAddress
{
        Address = '10.10.0.4', '127.0.0.1'
        InterfaceAlias = 'Ethernet 2'
        AddressFamily = 'IPv4'
        DependsOn = "[WindowsFeature]DNS"
}
</code></pre></div></div><p>Notes:<ul><li>Lines 1-6: Configure the DNS feature<li>Lines 8-14: Configure the network DNS NIC using the static private IP 10.10.0.4</ul><p>Now we needed to configure the DNS on the Azure VNet to use the domain controller IP address. We used this script:<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>param($rgName, $vnetName, $dnsAddress)
$vnet = Get-AzureRmVirtualNetwork -ResourceGroupName $rgName -Name $vnetName
if ($vnet.DhcpOptions.DnsServers[0] -ne $dnsAddress) {
    $vnet.DhcpOptions.DnsServers = @($dnsAddress)
    Set-AzureRmVirtualNetwork -VirtualNetwork $vnet
}
</code></pre></div></div><p>Notes:<ul><li>Line 2: Get the VNet using the resource group name and VNet name<li>Line 3: Check if the DNS setting of the VNet is correct<li>Lines 4,5: If it’s not, then set it to the internal IP address of the DNS server</ul><p>This script needs to run as an <a href="https://github.com/Microsoft/vsts-tasks/tree/master/Tasks/AzurePowerShell">Azure PowerShell script task</a> so that it’s already logged in to an Azure context (the equivalent of running Login-AzureRMAccount -ServicePrincipal). It’s sweet that you don’t have to provide any credentials in the script!<p>Now that we’ve set the DNS on the VNet, we have to reboot every machine on the VNet (otherwise they won’t pick up the change). That brings us to the final tip.<h3 id="tip-10-wait-on-machines-when-they-reboot">Tip 10: Wait on Machines When They Reboot</h3><p>You can easily reboot a machine by running this (plain) PowerShell: <!--kg-card-begin: html--> <font face="Courier New">Restart-Machine -ComputerName localhost -Force</font> <!--kg-card-end: html--><p>. This is so simple that you can do it as an inline PowerShell task: <!--kg-card-begin: html--><p><a href="/assets/images/files/c7a4e385-8587-4347-a7a5-77aff6f7bb7b.png"><img src="/assets/images/files/a2dd904d-386d-4f9a-8a47-a200a8aba5e7.png" alt="image" title="image" /></a><!--kg-card-end: html--><p>Rebooting the machine is easy: it’s waiting for it to start up again that’s more challenging. If you have a task right after the reboot task, the deployment fails since the agent goes offline. So you have to build in a wait. The simplest method is to add an agentless phase and add a Delay task: <!--kg-card-begin: html--><p><a href="/assets/images/files/92f15bf4-6607-4aff-85d7-a1d1a102cec2.png"><img src="/assets/images/files/be0c7bbe-79ed-4cb1-85e6-ed9b61d7ca42.png" alt="image" title="image" /></a><!--kg-card-end: html--><p>However, you can be slightly more intelligent if you poll the machine states using some Azure PowerShell:<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>param (
    [string]$ResourceGroupName,
    [string[]]$VMNames = @(),
    $TimeoutMinutes = 2,
    $DelaySeconds = 30
)

Write-Host "Delay for $DelaySeconds seconds."
Start-Sleep -Seconds $DelaySeconds

if($VMNames.Count -eq 0)
{
    $VMNames = (Get-AzureRmVm -ResourceGroupName $ResourceGroupName).Name
    Write-Host "Getting VM names."
}

$seconds = 10
$desiredStatus = "PowerState/running"

foreach($vmName in $VMNames)
{
    $timer = [Diagnostics.Stopwatch]::StartNew()
    Write-Host "Getting statuses of VMs."
    $statuses = (Get-AzureRmVm -ResourceGroupName $ResourceGroupName -VMName $vmName -Status).Statuses
    $status = $statuses | Where-Object { $_.Code -eq $desiredStatus }
    while($status -eq $null -and ($timer.Elapsed.TotalMinutes -lt $TimeoutMinutes))
    {
        Write-Verbose "Retrying in $($seconds) seconds."
        Start-Sleep -Seconds $seconds
        $statuses = (Get-AzureRmVm -ResourceGroupName $ResourceGroupName -VMName $vmName -Status).Statuses
        $status = $statuses | Where-Object { $_.Code -eq $desiredStatus }
    }

    if($timer.Elapsed.TotalMinutes -ge $TimeoutMinutes)
    {
        Write-Error "VM restart exceeded timeout."
    }
    else
    {
        Write-Host "VM name $($vmName) has current status of $($status.DisplayStatus)."
    }
}
</code></pre></div></div><p>Notes:<ul><li>The script requires a resource group name, an optional array of machine names (otherwise it will poll all the VMs in the resource group), a delay (defaulted to 30 seconds) and a timeout (defaulted to 2 minutes)<li>The script will delay for a small period (to give the machines time to start rebooting) and then poll them until they’re all running or the timeout is reached.</ul><p>This script has to run in an Azure PowerShell task in an <em>agent</em> phase from either the Hosted agent or a private agent - you can’t run it in a Deployment Group phase since those machines are rebooting!<h2 id="conclusion">Conclusion</h2><p>Deployment Groups are very powerful - they allow you to dynamically target multiple machines and execute configuration in a local context. This makes complex environment provisioning and configuration much easier to manage. However, it’s always good to know limitations, gotchas and practical tips when designing a complex deployment workflow. Hopefully these tips and tricks make your life a bit easier.<p>Happy deploying!</article><hr class="dingbat related mb6" /><aside class="comments related" role="complementary"><h2 class="hr-bottom">Comments</h2><div id="giscus"><div></div></div><script> function toggle_giscus() { const c = document.body.classList; const dark = c.contains("dark-mode") || "_sunset" in window && !c.contains("light-mode") && matchMedia("(prefers-color-scheme: dark)").matches; const theme = dark ? "dark" : "light"; const scriptEl = document.createElement("script"); scriptEl.src = "https://giscus.app/client.js"; scriptEl.setAttribute("data-repo", "colindembovsky/colindembovsky.github.io"); scriptEl.setAttribute("data-repo-id", "MDEwOlJlcG9zaXRvcnk0MDczMjI3MjU="); scriptEl.setAttribute("data-category", "Giscussions"); scriptEl.setAttribute("data-category-id", "DIC_kwDOGEdAZc4B_F18"); scriptEl.setAttribute("data-mapping", "pathname"); scriptEl.setAttribute("data-reactions-enabled", "1"); scriptEl.setAttribute("data-emit-metadata", "colindembovsky/colindembovsky.github.io"); scriptEl.setAttribute("data-theme", theme); scriptEl.setAttribute("crossorigin", "anonymous"); const container = document.getElementById("giscus"); const old = container.firstElementChild; container.removeChild(old); container.appendChild(scriptEl); } document.addEventListener("hydejack-dark-mode-toggle", function() { toggle_giscus(); }); toggle_giscus(); </script></aside><aside class="other-projects related mb0" role="complementary"><h2>Related Posts</h2><div class="columns"><div class="column column-1-2"><article class="project-card"> <a href="/pages/colindembovsky/implement-an-azure-devops-release-gate-to-servicenow/" class="no-hover no-print-link flip-project" tabindex="-1"><div class="project-card-img aspect-ratio sixteen-nine flip-project-img"> <img src="/pages/colindembovsky/assets/images/default.jpeg" alt="Implement an Azure DevOps Release Gate to ServiceNow" width="864" height="486" loading="lazy"/></div></a><h3 class="project-card-title flip-project-title"> <a href="/pages/colindembovsky/implement-an-azure-devops-release-gate-to-servicenow/" class="flip-title">Implement an Azure DevOps Release Gate to ServiceNow</a></h3><a class="fill-card no-hover" href="/pages/colindembovsky/implement-an-azure-devops-release-gate-to-servicenow/" tabindex="-1"><span class="sr-only">Continue reading Implement an Azure DevOps Release Gate to ServiceNow</span></a></article></div><div class="column column-1-2"><article class="project-card"> <a href="/pages/colindembovsky/serverless-parallel-selenium-grid-testing-with-vsts-and-azure-container-instances/" class="no-hover no-print-link flip-project" tabindex="-1"><div class="project-card-img aspect-ratio sixteen-nine flip-project-img"> <img src="/pages/colindembovsky/assets/images/default.jpeg" alt="Serverless Parallel Selenium Grid Testing with VSTS and Azure Container Instances" width="864" height="486" loading="lazy"/></div></a><h3 class="project-card-title flip-project-title"> <a href="/pages/colindembovsky/serverless-parallel-selenium-grid-testing-with-vsts-and-azure-container-instances/" class="flip-title">Serverless Parallel Selenium Grid Testing with VSTS and Azure Container Instances</a></h3><a class="fill-card no-hover" href="/pages/colindembovsky/serverless-parallel-selenium-grid-testing-with-vsts-and-azure-container-instances/" tabindex="-1"><span class="sr-only">Continue reading Serverless Parallel Selenium Grid Testing with VSTS and Azure Container Instances</span></a></article></div></div></aside><aside class="related mb4" role="complementary"><h2 class="hr-bottom">Random Posts</h2><ul class="related-posts"><li class="h4"> <a href="/pages/colindembovsky/modernizing-source-control-migrating-to-git/" class="flip-title"><span>Modernizing Source Control - Migrating to Git</span></a> <time class="faded fine" datetime="2018-12-19T08:22:15+00:00">19 Dec 2018</time><li class="h4"> <a href="/pages/colindembovsky/tfs-and-project-server-integration-tips-from-the-trenches-part-3/" class="flip-title"><span>Links to this series:</span></a> <time class="faded fine" datetime="2011-07-07T20:15:00+00:00">07 Jul 2011</time><li class="h4"> <a href="/pages/colindembovsky/actions-authenticate-to-azure-without-a-secret/" class="flip-title"><span>GitHub Actions: Authenticate to Azure Without a Secret using OIDC</span></a> <time class="faded fine" datetime="2021-11-09T01:22:01+00:00">09 Nov 2021</time></ul></aside><footer class="content" role="contentinfo"><hr/><p><small class="copyright">© 2021. All rights reserved. </small><hr class="sr-only"/></footer></main><hy-drawer id="_drawer" class="" side="left" threshold="10" noscroll ><header id="_sidebar" class="sidebar" role="banner"><div class="sidebar-bg sidebar-overlay" style="background-color:rgb(5,19,24);background-image:url(/pages/colindembovsky/assets/img/sidebar-bg.jpg)"></div><div class="sidebar-sticky"><div class="sidebar-about"> <a class="no-hover" href="/pages/colindembovsky/" tabindex="-1"> <img src="/pages/colindembovsky/assets/img/logo.png" class="avatar" alt="Colin's ALM Corner" width="120" height="120" loading="lazy" /> </a> <a class="sidebar-title" href="/pages/colindembovsky/"><h2 class="h1">Colin's ALM Corner</h2></a><p class=""> DevOpsology &amp; GitHub. <br /> <em>Opinions my own</em>.</div><nav class="sidebar-nav heading" role="navigation"> <span class="sr-only">Navigation:</span><ul><li> <a id="_drawer--opened" href="/pages/colindembovsky/tags/" class="sidebar-nav-item " > Tags </a><li> <a href="/pages/colindembovsky/about/" class="sidebar-nav-item " > About </a></ul></nav><div class="sidebar-social"> <span class="sr-only">Social:</span><ul><li> <a href="https://twitter.com/colindembovsky" title="Twitter" class="no-mark-external"> <span class="icon-twitter"></span> <span class="sr-only">Twitter</span> </a><li> <a href="https://github.com/colindembovsky" title="GitHub" class="no-mark-external"> <span class="icon-github"></span> <span class="sr-only">GitHub</span> </a><li> <a href="https://colinsalmcorner.com/feed.xml" title="RSS" class="no-mark-external"> <span class="icon-rss2"></span> <span class="sr-only">RSS</span> </a></ul></div></div></header></hy-drawer><hr class="sr-only" hidden /> </hy-push-state> <!--[if gt IE 10]><!----> <script nomodule>!function(){var t,n=document.createElement("script");!("noModule"in n)&&"onbeforeload"in n&&(t=!1,document.addEventListener("beforeload",function(e){if(e.target===n)t=!0;else if(!e.target.hasAttribute("nomodule")||!t)return;e.preventDefault()},!0),n.type="module",n.src=".",document.head.appendChild(n),n.remove())}(); </script> <script src="/pages/colindembovsky/assets/js/hydejack-9.1.4.js" type="module"></script> <script src="/pages/colindembovsky/assets/js/LEGACY-hydejack-9.1.4.js" nomodule defer></script> <script type="module"> if ('serviceWorker' in navigator) { /**/ navigator.serviceWorker.getRegistration() .then(r => r.unregister()) .catch(() => {}); /**/ } </script> <!--<![endif]--><div hidden><h2 class="sr-only">Templates (for web app):</h2><clap-config> <clap-text at="1">Keep going!</clap-text> <clap-text at="2">Keep going ×2!</clap-text> <clap-text at="3">Give me more!</clap-text> <clap-text at="5">Thank you, thank you</clap-text> <clap-text at="7">Far too kind!</clap-text> <clap-text at="10">Never gonna give me up?</clap-text> <clap-text at="14">Never gonna let me down?</clap-text> <clap-text at="20">Turn around and desert me!</clap-text> <clap-text at="30">You're an addict!</clap-text> <clap-text at="40">Son of a clapper!</clap-text> <clap-text at="50">No way</clap-text> <clap-text at="60">Go back to work!</clap-text> <clap-text at="70">This is getting out of <em>hand</em></clap-text> <clap-text at="80">Unbelievable</clap-text> <clap-text at="90">PREPOSTEROUS</clap-text> <clap-text at="100">I N S A N I T Y</clap-text> <clap-text at="185"><span style="font-family:monospace">FEED ME A STRAY CAT</span></clap-text> </clap-config> <template id="_animation-template"><div class="animation-main fixed-top"><nav id="breadcrumbs" class="screen-only"><ul></ul></nav><div class="content"><div class="page"></div></div></div></template> <template id="_loading-template"><div class="loading nav-btn fr"> <span class="sr-only">Loading…</span> <span class="icon-cog"></span></div></template> <template id="_error-template"><div class="page"><h1 class="page-title">Error</h1><p class="lead"> Sorry, an error occurred while loading <a class="this-link" href=""></a>.</div></template> <template id="_permalink-template"> <a href="#" class="permalink"> <span class="sr-only">Permalink</span> <span class="content-hash"></span> </a> </template> <template id="_cookies-banner-template"><div id="_cookies-banner" class="navbar fixed-bottom CookiesOK"><div class="content"><div class="nav-btn-bar"> <small class="faded"> <span>This site uses cookies. <a href="/cookies-policy/">Cookies Policy</a>. </span> <button id="_cookies-ok" class="btn btn-primary btn-sm">Okay</button> </small></div></div></div></template> <template id="_dark-mode-template"> <button id="_dark-mode" class="nav-btn no-hover" > <span class="sr-only">Dark Mode</span> <span class="icon-brightness-contrast"></span> </button> </template> <template id="_search-template"> <button id="_search" class="nav-btn no-hover"> <label class="sr-only" for="_search-input">Search</label> <span class="icon-search"></span> </button><div id="_search-box"><div class="nav-btn"> <span class="icon-search"></span></div><input id="_search-input" type="search" class="form-control form-control-lg nav-btn" placeholder="Type something…" /> <button type="reset" class="nav-btn no-hover"> <span class="sr-only">Close</span> <span class="icon-cross"></span> </button></div><div id="_hits"></div></template></div></html>
