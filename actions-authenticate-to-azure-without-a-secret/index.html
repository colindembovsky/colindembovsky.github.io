<!DOCTYPE html>
<html lang="en"><head><title>GitHub Actions: Authenticate to Azure Without a Secret using OIDC | Colin’s ALM Corner</title><meta name="generator" content="Jekyll v3.9.0" /><meta property="og:title" content="GitHub Actions: Authenticate to Azure Without a Secret using OIDC" /><meta name="author" content="Colin Dembovsky" /><meta property="og:locale" content="en" /><meta name="description" content="Authenticating to Azure in GitHub Actions requires a secret for a Service Principal. However, at Universe, GitHub released a new OIDC-based authentication mechanism that eliminates the need for secrets in secure deployments." /><meta property="og:description" content="Authenticating to Azure in GitHub Actions requires a secret for a Service Principal. However, at Universe, GitHub released a new OIDC-based authentication mechanism that eliminates the need for secrets in secure deployments." /><link rel="canonical" href="https://github.com/pages/colindembovsky/actions-authenticate-to-azure-without-a-secret/" /><meta property="og:url" content="https://github.com/pages/colindembovsky/actions-authenticate-to-azure-without-a-secret/" /><meta property="og:site_name" content="Colin’s ALM Corner" /><meta property="og:image" content="https://github.com/pages/colindembovsky/assets/images/2021/11/oidc/Data_security_27.jpg" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-11-09T01:22:01+00:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://github.com/pages/colindembovsky/assets/images/2021/11/oidc/Data_security_27.jpg" /><meta property="twitter:title" content="GitHub Actions: Authenticate to Azure Without a Secret using OIDC" /><meta name="twitter:site" content="@colindembovsky" /><meta name="twitter:creator" content="@colindembovsky" /> <script type="application/ld+json"> {"description":"Authenticating to Azure in GitHub Actions requires a secret for a Service Principal. However, at Universe, GitHub released a new OIDC-based authentication mechanism that eliminates the need for secrets in secure deployments.","url":"https://github.com/pages/colindembovsky/actions-authenticate-to-azure-without-a-secret/","@type":"BlogPosting","headline":"GitHub Actions: Authenticate to Azure Without a Secret using OIDC","dateModified":"2021-11-09T01:22:01+00:00","datePublished":"2021-11-09T01:22:01+00:00","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://github.com/pages/colindembovsky/assets/img/logo.png"},"name":"Colin Dembovsky"},"image":"https://github.com/pages/colindembovsky/assets/images/2021/11/oidc/Data_security_27.jpg","mainEntityOfPage":{"@type":"WebPage","@id":"https://github.com/pages/colindembovsky/actions-authenticate-to-azure-without-a-secret/"},"author":{"@type":"Person","name":"Colin Dembovsky"},"@context":"https://schema.org"}</script><meta name="keywords" content="devops,github,actions,build,ci,cd"><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Colin's ALM Corner"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="application-name" content="Colin's ALM Corner"><meta name="theme-color" content="rgb(5,19,24)"><meta name="generator" content="Hydejack v9.1.4" /><link rel="alternate" href="https://github.com/pages/colindembovsky/actions-authenticate-to-azure-without-a-secret/" hreflang="en"><link type="application/atom+xml" rel="alternate" href="https://github.com/pages/colindembovsky/feed.xml" title="Colin's ALM Corner" /><link rel="shortcut icon" href="/pages/colindembovsky/assets/icons/favicon.ico"><link rel="apple-touch-icon" href="/pages/colindembovsky/assets/icons/icon-192x192.png"><link rel="manifest" href="/pages/colindembovsky/assets/site.webmanifest"><link rel="dns-prefetch" href="https://fonts.googleapis.com"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preload" href="/pages/colindembovsky/assets/img/swipe.svg" as="image" id="_hrefSwipeSVG"><link rel="dns-prefetch" href="/pages/colindembovsky/assets/js/search-worker-9.1.4.js" as="worker" id="_hrefSearch"> <script>!function(r,c){"use strict";function a(e,t,n,o){e.addEventListener?e.addEventListener(t,n,o):e.attachEvent?e.attachEvent("on"+t,n):e["on"+t]=n}r.loadJS=function(e,t){var n=c.createElement("script");n.src=e,t&&a(n,"load",t,{once:!0});t=c.scripts[0];return t.parentNode.insertBefore(n,t),n},r._loaded=!1,r.loadJSDeferred=function(e,t){var n=c.createElement("script");function o(){r._loaded=!0,t&&a(n,"load",t,{once:!0});var e=c.scripts[0];e.parentNode.insertBefore(n,e)}return n.src=e,r._loaded?o():a(r,"load",o,{once:!0}),n},r.setRel=r.setRelStylesheet=function(e){a(c.getElementById(e),"load",function(){this.rel="stylesheet"},{once:!0})}}(window,document); !function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this); !function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this); !function(w) { w._baseURL = '/pages/colindembovsky/'; w._publicPath = '/pages/colindembovsky/assets/js/'; w._noPushState = false; w._noDrawer = false; w._noNavbar = false; w._noToc = false; w._noSearch = false; w._advertise = false; w._search = { DATA_URL: '/pages/colindembovsky/assets/sitedata.json?no-cache', STORAGE_KEY: 'mini-search/pages/colindembovsky/', INDEX_KEY: 'index--2021-11-18T20:23:33+00:00', }; w._clapButton = false; }(window);</script> <script async src="/pages/colindembovsky/assets/bower_components/MathJax/es5/tex-mml-chtml.js" id="_MathJax"></script> <!--[if gt IE 8]><!----><style id="_styleInline"> .clearfix,.sidebar-social::after{content:"";display:table;clear:both}.color-transition,body,p,hr,.hr,.hr-after::after,.hr-bottom,.message,.note-sm,.note,#markdown-toc,.navbar,.nav-btn-bar,.nav-btn,.content .avatar{transition:none}#_dark-mode{font-size:1.25rem}@media screen{body.light-mode{--body-color: #333;--body-bg: #fff;--border-color: #ebebeb;--gray: #777;--gray-bg: rgba(0,0,0,0.025);--gray-text: #666;--menu-text: #bbb;--inv-body-color: #ccc;--inv-body-bg: var(--dark-mode-body-bg)}body.light-mode .content{-webkit-font-smoothing:initial;-moz-osx-font-smoothing:initial}body.dark-mode{--body-color: #ccc;--body-bg: var(--dark-mode-body-bg);--border-color: var(--dark-mode-border-color);--gray: rgba(255,255,255,.5);--gray-bg: rgba(255,255,255,.033);--gray-text: rgba(255,255,255,.625);--menu-text: rgba(255,255,255,.25);--inv-body-color: #333;--inv-body-bg: #fff}body.dark-mode .content{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}}@media screen and (prefers-color-scheme: dark){body{--body-color: #ccc;--body-bg: var(--dark-mode-body-bg);--border-color: var(--dark-mode-border-color);--gray: rgba(255,255,255,.5);--gray-bg: rgba(255,255,255,.033);--gray-text: rgba(255,255,255,.625);--menu-text: rgba(255,255,255,.25);--inv-body-color: #333;--inv-body-bg: #fff}body .content{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.tippy-content{-webkit-font-smoothing:initial;-moz-osx-font-smoothing:initial}}html{--font-family: Noto Sans,Helvetica,Arial,sans-serif;--font-family-heading: Roboto Slab,Helvetica,Arial,sans-serif;--code-font-family: Fira Code,Menlo,Monaco,Consolas,monospace;--body-color: #333;--body-bg: #fff;--border-color: #ebebeb;--gray: #777;--gray-bg: rgba(0,0,0,0.025);--gray-text: #666;--menu-text: #bbb;--inv-body-color: #ccc;--inv-body-bg: var(--dark-mode-body-bg);--root-font-size: 15px;--root-font-size-medium: 16px;--root-font-size-large: 17px;--root-font-size-print: 8pt;--root-line-height: 1.75;--font-weight: 400;--font-weight-bold: 700;--font-weight-heading: 700;--content-width-5: 54rem;--content-margin-5: 4rem;--sidebar-width: 21rem;--half-content: 31rem;--break-point-3: 64em;--break-point-5: 86em;--break-point-dynamic: 1664px}html .content{-webkit-font-smoothing:initial;-moz-osx-font-smoothing:initial}*{box-sizing:border-box}html,body{margin:0;padding:0}html{font-family:var(--font-family);font-size:var(--root-font-size);line-height:var(--root-line-height)}body{color:var(--body-color);background-color:var(--body-bg);font-weight:var(--font-weight);overflow-y:scroll}.content img,.img,.content video,.video{max-width:100%;height:auto}.lead{margin-left:-1rem;margin-right:-1rem;margin-bottom:1.5rem}img.lead,video.lead{display:block;max-width:calc(100% + 2rem);width:calc(100% + 2rem);height:auto}.heading,.f1,h1,.h1,.f2,h2,.h2,.f3,h3,.h3,.f4,h4,.h4,.post-date,.sidebar-nav-item,.f5,h5,.h5,.f6,h6,.h6{font-family:var(--font-family-heading);font-weight:var(--font-weight-heading)}.f1,h1,.h1{font-size:2rem;line-height:1.3}.f2,h2,.h2{font-size:1.5rem;line-height:1.4}.f3,h3,.h3{font-size:1.2em;line-height:1.5}.f4,h4,.h4,.post-date,.sidebar-nav-item{font-size:1.08rem;line-height:1.6}.f5,h5,.h5{font-size:1.04rem;line-height:1.7}.f6,h6,.h6{font-size:1rem}.content h1>a,.content .h1>a{text-decoration:none;border-bottom:none}@media screen and (max-width: 42em){.content h1,.content .h1{font-size:1.7rem;line-height:1.35}}@media screen and (min-width: 86em){.content h1,.content .h1{font-size:2.4rem;line-height:1.25}}@media screen and (min-width: 1664px){body:not(.no-large-headings) .content h1,body:not(.no-large-headings) .content .h1{width:calc(100% + 50vw - 32rem);font-size:3rem;line-height:1.2}}@media screen and (min-width: 124em){body:not(.no-large-headings) .content h1,body:not(.no-large-headings) .content .h1{font-size:4rem;line-height:1.1}}h1,h2,h3,.h1,.h2,.h3{margin:4rem 0 1rem}h4,h5,h6,.h4,.post-date,.h5,.h6{margin:3rem 0 .5rem}p{margin-top:0;margin-bottom:1rem}p.lead{font-size:1.2em;margin-top:1.5rem;margin-bottom:1.5rem;padding:0 1rem}ul,ol,dl{margin-top:0;margin-bottom:1rem}ul,ol{padding-left:1.25rem}hr,.hr{border:0;margin:1rem 0;border-top:1px solid var(--border-color)}.hr-after::after{content:"";display:block;margin:1rem 0;border-top:1px solid var(--border-color)}.hr-bottom{border-bottom:1px solid var(--border-color);padding-bottom:.75rem;margin-bottom:1rem}.page{margin-bottom:3em}.page li+li{margin-top:.25rem}.page>header{position:relative;margin-bottom:1.5rem}@media screen and (min-width: 1664px){body:not(.no-third-column) .page>header>.lead+.note-sm,body:not(.no-third-column) .page>header>.lead+.note,body:not(.no-third-column) .page>header>.lead+#markdown-toc,body:not(.no-third-column) .page>header>a.no-hover+.note-sm,body:not(.no-third-column) .page>header>a.no-hover+.note,body:not(.no-third-column) .page>header>a.no-hover+#markdown-toc{position:absolute;right:-25rem;width:21rem;bottom:0;margin-bottom:0}}.page-title,.post-title{margin-top:0}.post-date{display:flex;justify-content:space-between;margin-top:-.6rem;height:2rem;margin-bottom:.85rem;color:var(--gray)}.post-date>.ellipsis,#breadcrumbs.post-date>ul{cursor:pointer}.post-date [class^="icon-"]{display:inline-block;font-size:smaller;margin-right:.25rem}.related-posts{padding-left:0;list-style:none;margin-bottom:2rem}.related-posts>li,.related-posts>li+li{margin-top:1rem}.message,.note-sm,.note,#markdown-toc{margin-bottom:1rem;padding:1rem;color:var(--gray-text);background-color:var(--gray-bg);margin-left:-1rem;margin-right:-1rem}.note-sm,.note,#markdown-toc{background:transparent;color:var(--body-color);font-size:smaller;border-left:1px solid var(--border-color);padding:1.2rem 1rem 0 1rem;margin:1rem -1rem;position:relative}.note-sm:before,.note:before,#markdown-toc:before{font-size:0.667rem;font-weight:bold;font-style:normal;letter-spacing:.025rem;text-transform:uppercase;color:var(--menu-text);position:absolute;top:0}.note-sm[title]:before,[title].note:before,[title]#markdown-toc:before{content:attr(title) !important}.note{font-size:1rem}@media screen{body::before{content:'';width:.5rem;background:var(--gray-bg);position:fixed;left:0;top:0;bottom:0}}@media (min-width: 64em){body::before{width:21rem}}@media (min-width: 1664px){body::before{width:calc(50% - 31rem)}}@media screen and (min-width: 42em){html{font-size:var(--root-font-size-medium)}}@media screen and (min-width: 124em){html{font-size:var(--root-font-size-large)}}#breadcrumbs>ul{height:1rem;margin:-1.5rem 0 .5rem;padding:0;font-size:.667rem;color:var(--menu-text);text-transform:uppercase;width:100%;list-style:none}#breadcrumbs>ul>li{display:inline}#breadcrumbs>ul>li a{color:var(--gray);text-decoration:none;border-bottom:none}.fl{float:left}.fr{float:right}.mb4{margin-bottom:4rem}.mb6{margin-bottom:6rem}.mt0{margin-top:0}.mt1{margin-top:1rem}.mt2{margin-top:2rem}.mt3{margin-top:3rem}.mt4{margin-top:4rem}.pb0{padding-bottom:0}.ml1{margin-left:1rem}.mr1{margin-right:1rem}.sixteen-nine{position:relative}.sixteen-nine::before{display:block;content:"";width:100%;padding-top:56.25%}.sixteen-nine>*{position:absolute;top:0;left:0;right:0;bottom:0}.sixteen-ten{position:relative}.sixteen-ten::before{display:block;content:"";width:100%;padding-top:62.5%}.sixteen-ten>*{position:absolute;top:0;left:0;right:0;bottom:0}.four-three{position:relative}.four-three::before{display:block;content:"";width:100%;padding-top:75%}.four-three>*{position:absolute;top:0;left:0;right:0;bottom:0}.sr-only{display:none}.larger{font-size:larger}.smaller{font-size:smaller}.clearfix,.sidebar-social::after{content:"";display:table;clear:both}.ellipsis,#breadcrumbs>ul{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.border{border:1px solid var(--border-color)}@media (min-width: 42em){.border-radius,.lead,.page .aspect-ratio.sixteen-nine.lead{border-radius:.5rem}}.fallback-img{background-position:center;background-repeat:no-repeat;background-image:url("data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4KPHN2ZyB3aWR0aD0iMTYwIiBoZWlnaHQ9IjkwIiB2aWV3Qm94PSIwIDAgMTYwIDkwIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgogIDxnIHRyYW5zZm9ybT0ibWF0cml4KDAuMDQ4ODI4LCAwLCAwLCAwLjA0Nzk5MSwgNTQuOTk5OTczLCAyMC40MjgxNDgpIj4KICAgIDxwYXRoIHN0eWxlPSJmaWxsOnJnYmEoMTI4LDEyOCwxMjgsLjMzKSIgZD0iTTk1OS44ODQgMTI4YzAuMDQwIDAuMDM0IDAuMDgyIDAuMDc2IDAuMTE2IDAuMTE2djc2Ny43N2MtMC4wMzQgMC4wNDAtMC4wNzYgMC4wODItMC4xMTYgMC4xMTZoLTg5NS43N2MtMC4wNDAtMC4wMzQtMC4wODItMC4wNzYtMC4xMTQtMC4xMTZ2LTc2Ny43NzJjMC4wMzQtMC4wNDAgMC4wNzYtMC4wODIgMC4xMTQtMC4xMTRoODk1Ljc3ek05NjAgNjRoLTg5NmMtMzUuMiAwLTY0IDI4LjgtNjQgNjR2NzY4YzAgMzUuMiAyOC44IDY0IDY0IDY0aDg5NmMzNS4yIDAgNjQtMjguOCA2NC02NHYtNzY4YzAtMzUuMi0yOC44LTY0LTY0LTY0djB6Ii8+CiAgICA8cGF0aCBzdHlsZT0iZmlsbDpyZ2JhKDEyOCwxMjgsMTI4LC4zMykiIGQ9Ik04MzIgMjg4YzAgNTMuMDIwLTQyLjk4IDk2LTk2IDk2cy05Ni00Mi45OC05Ni05NiA0Mi45OC05NiA5Ni05NiA5NiA0Mi45OCA5NiA5NnoiLz4KICAgIDxwYXRoIHN0eWxlPSJmaWxsOnJnYmEoMTI4LDEyOCwxMjgsLjMzKSIgZD0iTTg5NiA4MzJoLTc2OHYtMTI4bDIyNC0zODQgMjU2IDMyMGg2NGwyMjQtMTkyeiIvPgogIDwvZz4KPC9zdmc+")}hy-push-state a{color:var(--body-color)}@supports not ((text-decoration-thickness: initial) and (text-underline-offset: initial)){hy-push-state a{text-decoration:none;border-bottom:2px solid}}@supports (text-decoration-thickness: initial) and (text-underline-offset: initial){hy-push-state a{text-decoration-style:solid;text-underline-offset:.35rem;text-decoration-thickness:2px}}hy-push-state a.no-hover{border-bottom:none;text-decoration-thickness:unset;text-underline-offset:unset}.content a:not(.btn):not(.no-hover){border-color:var(--accent-color-faded)}@supports (text-decoration-thickness: initial) and (text-underline-offset: initial){.content a:not(.btn):not(.no-hover){text-decoration-color:var(--accent-color-faded)}}.content .aspect-ratio{overflow:hidden}.content .aspect-ratio img{margin:0;width:100%;height:100%;background-color:var(--gray-bg)}hy-drawer{width:100%;position:relative;overflow:hidden;display:block;z-index:4}@media screen and (min-width: 64em){hy-drawer{position:fixed;width:21rem;top:0;left:0;bottom:0;margin-left:0}hy-drawer.cover{position:relative;width:100%}}@media screen and (min-width: 1664px){hy-drawer{width:calc(50% - 31rem)}}.sidebar{position:relative;display:flex;justify-content:center;align-items:center;color:rgba(255,255,255,0.75);text-align:center;min-height:100vh}.sidebar.invert{color:rgba(32,32,32,0.75)}.sidebar a{color:#fff;border-bottom-color:rgba(255,255,255,0.2);text-decoration-color:rgba(255,255,255,0.2)}.sidebar.invert a{color:#222;border-bottom-color:rgba(32,32,32,0.2);text-decoration-color:rgba(32,32,32,0.2)}.sidebar-bg{position:absolute;top:0;left:calc(50% - 50vw);width:100vw;height:100%;background:#202020 center / cover}.sidebar-bg::after{content:"";position:absolute;top:0;left:0;bottom:0;right:0;background:rgba(0,0,0,0.05)}.sidebar-bg.sidebar-overlay::after{background:linear-gradient(to bottom, rgba(32,32,32,0) 0%, rgba(32,32,32,0.5) 50%, rgba(32,32,32,0) 100%)}.sidebar-sticky{position:relative;z-index:3;max-width:21rem;padding:1.5rem;contain:content}.sidebar-about .avatar{margin-bottom:1.5rem}.sidebar-about>a.sidebar-title{text-decoration:none}.sidebar-about>a.sidebar-title>h2{margin:0;padding-bottom:.5rem}.sidebar-about>a.sidebar-title::after{content:'';display:block;border-bottom:2px solid;margin:0 auto .5rem;width:4rem;border-color:rgba(255,255,255,0.2);transition:border-color 250ms}.sidebar-about>a.sidebar-title:hover::after{border-color:#fff;transition:border-color 50ms}.sidebar.invert .sidebar-about>a.sidebar-title::after{border-color:rgba(32,32,32,0.2)}.sidebar.invert .sidebar-about>a.sidebar-title:hover::after{border-color:#222}.sidebar-nav>ul{list-style:none;padding-left:0}.sidebar-nav-item{display:inline-block;margin-bottom:.5rem}@media (min-width: 64em){#_main.no-drawer #_menu{display:none}#_main.no-drawer .nav-btn-bar>:nth-child(2){border:none}}.sidebar-social>ul{display:inline-block;list-style:none;padding-left:0;margin-bottom:0}.sidebar-social>ul>li{float:left}.sidebar-social>ul>li>a{display:inline-block;text-align:center;font-size:1.4rem;width:3rem;height:4rem;padding:.5rem 0;line-height:3rem;text-decoration:none;border-bottom-width:2px;border-bottom-style:solid}.sidebar-social>ul li+li{margin-top:0}.fixed-common,.fixed-top,.fixed-bottom{position:fixed;left:0;width:100%;z-index:2}.fixed-top{top:0}.fixed-bottom{bottom:0}.navbar>.content{position:relative;padding-top:0;padding-bottom:0;min-height:0;max-height:5rem}.nav-btn-bar{margin:0 -1rem;background-color:white;background-color:var(--body-bg);height:5rem;display:flex;align-items:center;position:relative}.nav-btn-bar>:first-child,.nav-btn-bar>:last-child{border:none}.nav-btn{background:none;border:none;text-decoration:none;display:flex;align-items:center;justify-content:center;width:3.25rem;height:5rem;color:var(--menu-text);border-right:1px solid var(--border-color);border-left:1px solid var(--border-color);margin-left:-1px}#markdown-toc{margin:2rem -1rem 2rem calc(-1rem + 1px);padding-left:2.5rem;padding-bottom:.5rem}#markdown-toc:before{left:1rem}@media screen and (min-width: 1664px){body:not(.no-toc) #markdown-toc{position:absolute;z-index:4;width:20.5rem;right:0;margin:auto;overflow:auto}}@media screen and (min-width: 1664px){body.no-break-layout:not(.no-toc) #markdown-toc{width:calc(50% - 31rem)}}.content{margin-left:auto;margin-right:auto;padding:8rem 1rem 12rem}@media screen{.content{padding-left:1.5rem;min-height:100vh}}@media screen and (min-width: 42em){.content{max-width:42rem}}@media screen and (min-width: 54em){.content{max-width:48rem}}@media screen and (min-width: 64em){.content{padding-left:1rem;margin-left:24rem;margin-right:3rem}}@media screen and (min-width: 86em){.content{padding-top:9rem;margin-left:25rem;margin-right:4rem;max-width:54rem}}@media screen and (min-width: 1664px){.content{margin:auto}}.large-only{display:none}@media screen and (min-width: 1664px){.large-only{display:block}}.avatar{width:7rem;height:7rem;border-radius:100%;overflow:hidden;display:inline-block}.avatar img{width:100%}.content .avatar{float:right;box-sizing:content-box;border:1rem solid var(--body-bg);transition:border-color 1s ease;margin-top:-1.5rem;margin-right:-1rem}hr.dingbat{display:none}.center-image{margin:auto;display:block}.note:before{content:"Note"}.page>header>.note-sm:before,.page>header>.note:before,.page>header>#markdown-toc:before{content:"Description"}#markdown-toc:before{content:"Table of Contents"}.layout-resume .note-sm:before,.layout-resume .note:before,.layout-resume #markdown-toc:before{content:"Summary"} .clearfix,main:not(.layout-resume) .columns::after{content:"";display:table;clear:both}.color-transition,main:not(.layout-resume) .project-card{transition:none}main:not(.layout-resume) .columns{margin-left:-1rem;display:flex;flex-wrap:wrap;contain:content;padding-top:1rem;margin-top:1rem;padding-right:1rem;margin-right:-1rem}main:not(.layout-resume) .column{float:left;padding-left:1rem;margin-bottom:2rem;width:100%;display:flex}@media screen and (min-width: 42em){main:not(.layout-resume) .columns{margin-left:-2rem;margin-right:-2rem}main:not(.layout-resume) .column-1-2{width:50%}}@media screen and (min-width: 1664px){main:not(.layout-resume) .columns-break{width:calc(50vw + 25rem)}main:not(.layout-resume) .columns-break>.column-1-2,main:not(.layout-resume) .columns-break>.column-1{width:27.5rem}}@media print{main:not(.layout-resume) .columns{display:block}main:not(.layout-resume) .column{display:block;width:50%}}main:not(.layout-resume) .project-card{width:100%;color:var(--gray-text);background-color:var(--gray-bg);padding-bottom:1rem;position:relative;overflow:hidden;box-shadow:0.125rem 0.125rem 1rem rgba(0,0,0,0.2);contain:content;border-radius:.5rem;page-break-inside:avoid;transition:transform 500ms ease;will-change:transform}main:not(.layout-resume) .project-card:hover{transform:translateY(-0.25rem);transition:transform 250ms ease}main:not(.layout-resume) .project-card>a.flip-project{display:block}main:not(.layout-resume) .project-card>a.flip-project .project-card-img{margin-bottom:0}main:not(.layout-resume) .project-card>a.flip-project .project-card-img img{display:block;border-top-left-radius:.5rem;border-top-right-radius:.5rem}main:not(.layout-resume) .project-card a{position:relative;z-index:1}main:not(.layout-resume) .project-card a.fill-card{position:absolute;top:0;left:0;right:0;bottom:0;z-index:0}main:not(.layout-resume) .project-card>.project-card-title,main:not(.layout-resume) .project-card>.project-card-text{text-align:center;padding:0 1rem}main:not(.layout-resume) .project-card>.project-card-title{display:block;font-size:1.08rem;margin-top:.75rem;margin-bottom:.25rem;color:inherit}main:not(.layout-resume) .project-card>.project-card-text{margin:.25rem 0}main:not(.layout-resume) .column-1>.project-card>.project-card-title{font-size:1.2rem}main:not(.layout-resume) .column-1>.project-card>.project-card-text{font-size:1rem}</style><link rel="preload" as="style" href="/pages/colindembovsky/assets/css/hydejack-9.1.4.css" id="_stylePreload"><link rel="preload" as="style" href="/pages/colindembovsky/assets/icomoon/style.css" id="_iconsPreload"><link rel="preload" as="style" href="https://fonts.googleapis.com/css?family=Roboto+Slab:700%7CNoto+Sans:400,400i,700,700i&display=swap" id="_fontsPreload"> <script> setRel('_stylePreload'); setRel('_iconsPreload'); /**/setRel('_fontsPreload');/**/ </script> <noscript><link rel="stylesheet" href="/pages/colindembovsky/assets/css/hydejack-9.1.4.css"><link rel="stylesheet" href="/pages/colindembovsky/assets/icomoon/style.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Slab:700%7CNoto+Sans:400,400i,700,700i&display=swap"> </noscript><style id="_pageStyle"> html{--accent-color: rgb(79, 129, 220);--accent-color-faded: rgba(79,129,220,0.5);--accent-color-highlight: rgba(79,129,220,0.1);--accent-color-darkened: #2f6ad6;--theme-color: rgb(5,19,24);--dark-mode-body-bg: #292e30;--dark-mode-border-color: #353c3e}</style><!--<![endif]--> <script async src="https://www.googletagmanager.com/gtag/js?id=G-FD31RTDXK2"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-FD31RTDXK2'); </script><body class="no-break-layout"> <script> window._sunrise = 6; window._sunset = 18; !function(e,s){var d="light-mode",o="dark-mode",a=(new Date).getHours();"matchMedia"in e&&e.matchMedia("(prefers-color-scheme)")||(o=(e=a<=e._sunrise||a>=e._sunset?o:d)==o?d:o,s.body.classList.add(e),s.body.classList.remove(o))}(window,document); </script> <hy-push-state id="_pushState" replace-selector="#_main" link-selector="a[href]:not([href^='/pages/colindembovsky/assets/']):not(.external):not(.no-push-state)" script-selector="script" duration="500" hashchange ><div id="_navbar" class="navbar fixed-top"><div class="content"> <span class="sr-only">Jump to:</span><div class="nav-btn-bar"> <a id="_menu" class="nav-btn no-hover" href="#_drawer--opened"> <span class="sr-only">Navigation</span> <span class="icon-menu"></span> </a><div class="nav-span"></div></div></div></div><hr class="sr-only" hidden /><main id="_main" class="content layout-post" role="main" ><nav id="breadcrumbs" class="screen-only"><ul><li><a href="/pages/colindembovsky/">home</a><li> <span>/</span> <span>actions-authenticate-to-azure-without-a-secret</span></ul></nav><article id="post-actions-authenticate-to-azure-without-a-secret" class="page post mb6" role="article"><header><h1 class="post-title flip-project-title"> GitHub Actions: Authenticate to Azure Without a Secret using OIDC</h1><div class="post-date"> <span class="ellipsis mr1"> <time datetime="2021-11-09T01:22:01+00:00">09 Nov 2021</time> on <a href="/pages/colindembovsky/tag/build/" class="flip-title">build</a>, <a href="/pages/colindembovsky/tag/security/" class="flip-title">security</a> </span></div><div class="img-wrapper lead aspect-ratio sixteen-nine flip-project-img"> <img src="/pages/colindembovsky/assets/images/2021/11/oidc/Data_security_27.jpg" alt="GitHub Actions: Authenticate to Azure Without a Secret using OIDC" width="864" height="486" loading="lazy" /></div><p class="note-sm" > Authenticating to Azure in GitHub Actions requires a secret for a Service Principal. However, at Universe, GitHub released a new OIDC-based authentication mechanism that eliminates the need for secrets in secure deployments.</header><ol id="markdown-toc"><li><a href="#update-11172021" id="markdown-toc-update-11172021">Update: 11/17/2021</a><li><a href="#problem-statement" id="markdown-toc-problem-statement">Problem Statement</a><li><a href="#oidc" id="markdown-toc-oidc">OIDC</a><li><a href="#sample-action-using-oidc" id="markdown-toc-sample-action-using-oidc">Sample Action using OIDC</a><li><a href="#azure-configuration" id="markdown-toc-azure-configuration">Azure Configuration</a><ol><li><a href="#creating-a-service-principal-app-registration" id="markdown-toc-creating-a-service-principal-app-registration">Creating a Service Principal (App Registration)</a><ol><li><a href="#authorize-the-spn" id="markdown-toc-authorize-the-spn">Authorize the SPN</a></ol></ol><li><a href="#github-configuration" id="markdown-toc-github-configuration">GitHub Configuration</a><li><a href="#the-main-workflow" id="markdown-toc-the-main-workflow">The Main Workflow</a><ol><li><a href="#the-composite-workflow" id="markdown-toc-the-composite-workflow">The Composite Workflow</a></ol><li><a href="#running-the-workflow" id="markdown-toc-running-the-workflow">Running the Workflow</a><ol><li><a href="#dev-logs" id="markdown-toc-dev-logs">Dev Logs</a><li><a href="#prod-logs" id="markdown-toc-prod-logs">Prod Logs</a><li><a href="#bad-prod-logs" id="markdown-toc-bad-prod-logs">Bad-prod Logs</a></ol><li><a href="#limitations" id="markdown-toc-limitations">Limitations</a><li><a href="#conclusion" id="markdown-toc-conclusion">Conclusion</a></ol><blockquote><p>Image from <a href="https://www.freepik.com/vectors/business">www.freepik.com</a></blockquote><h1 id="update-11172021">Update: 11/17/2021</h1><p>In the original version of this post, I extracted the Azure login task to a Composite Action because you need a beta version of the <code class="language-plaintext highlighter-rouge">az cli</code> for the OIDC to work. As of today, you can use the <code class="language-plaintext highlighter-rouge">@v1</code> tag of <code class="language-plaintext highlighter-rouge">azure/login</code> (which has been updated to include OIDC logic) and you do not have to install the beta <code class="language-plaintext highlighter-rouge">az cli</code>. This makes the Composite Action obsolete - all you have to do now is call the <code class="language-plaintext highlighter-rouge">azure/login</code> task as before, not passing the secret (assuming you configure the federated credential on the SPN in Azure).<h1 id="problem-statement">Problem Statement</h1><p>Deploying to Azure or other cloud providers from Actions requires that you authenticate to the provider. Not only do you have to authenticate, but the credential you use needs authorization to perform tasks in the cloud platform.<p>For Azure, this is accomplished by creating a Service Principal (SPN) and then saving the credentials for that SPN to your GitHub repo (or organization) as a secret. The secret is then consumed by the <code class="language-plaintext highlighter-rouge">actions/login</code> <a href="https://github.com/azure/login">task</a> to authenticate to Azure before you perform any other steps:<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">
</span><span class="p">{</span><span class="w">
  </span><span class="nl">"clientId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"GUID"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"clientSecret"</span><span class="p">:</span><span class="w"> </span><span class="s2">"some value"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"tenantId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"GUID"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"subscriptionId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"GUID"</span><span class="w">
</span><span class="p">}</span><span class="w">

</span></code></pre></div></div><p class="figcaption">The format of the <code class="language-plaintext highlighter-rouge">AZURE_CREDENTIAL</code> secret.<p>The problem with this secret is that it has to be maintained in GitHub. What happens when you rotate the client secret? Deployments will start to fail unless you update the secret. And if you’re using the credential across multiple repos, you’ll have to update the secret in each place it’s used.<h1 id="oidc">OIDC</h1><p>To help solve this problem, GitHub has been working with cloud providers to implement <a href="https://openid.net/connect/">OpenID Connect</a> (OIDC) authentication. This is an established, standard protocol that allows systems to request and receive information about authenticated users. You can read more about the supported providers in the <a href="https://docs.github.com/en/actions/deployment/security-hardening-your-deployments">official documentation</a>.<p>The idea is that you configure your cloud provider to issue a short-lived token to a specific GitHub repo (optionally scoping to a branch, environment, tag or “any PR”). When you run a workflow, you configure the cloud provider authentication step to request a token for a given security context (SPN for Azure, ARN for AWS for example). If the provider is happy with the request, it issues a token that the step then uses to authenticate the session and the rest of the steps proceed as usual.<p>For Azure, this means that we can eliminate the <em>secret</em> part of the Azure credential - we still need to know the tenant, subscription and client ID. Since these values are useless without the secret (which you don’t need) you don’t have to rotate them, or even store them secretly, though storing them as secrets is convenient.<h1 id="sample-action-using-oidc">Sample Action using OIDC</h1><p>You can take a look at <a href="https://github.com/colindembovsky/azure-oidc-demo">this repo</a> which contains the code for this post.<p>For this sample, I wanted to configure two service Principals (<code class="language-plaintext highlighter-rouge">mona-oidc-dev</code> and <code class="language-plaintext highlighter-rouge">mon-oidc-prod</code>) that are given access to <code class="language-plaintext highlighter-rouge">oidc-dev</code> and <code class="language-plaintext highlighter-rouge">oidc-prod</code> resource groups respectively. I used <code class="language-plaintext highlighter-rouge">dev</code> and <code class="language-plaintext highlighter-rouge">prod</code> environments in the repo, and configured the OIDC scoped to the environment, as we’ll see later.<p>I then set up a workflow that used the correct clients for <code class="language-plaintext highlighter-rouge">dev</code> and <code class="language-plaintext highlighter-rouge">prod</code>, expecting those to work as advertised. Finally I added a “bad” job that hard-coded the <code class="language-plaintext highlighter-rouge">mona-oidc-dev</code> client ID and attempted to authenticate to the <code class="language-plaintext highlighter-rouge">prod</code> environment, just to make sure that the authentication fails.<h1 id="azure-configuration">Azure Configuration</h1><p>For the Azure side, I started by creating two service Principals. Nothing special about these, apart from the fact that I have created a <strong>federated credential</strong> that enables the OIDC connection.<h2 id="creating-a-service-principal-app-registration">Creating a Service Principal (App Registration)</h2><p>Navigate to the Active Directory blade in the Azure Portal and click <strong>+Add -&gt; App registration</strong>. Type in the name and URL - these just have to be unique, but can be any value:<p><img src="/assets/images/2021/11/oidc/create-spn.png" alt="Create a new SPN" class="center-image" /><p class="figcaption">Create a new SPN.<p>Once created, click on <strong>Certificates &amp; Secrets</strong> and then on <strong>Federated credentials</strong>. Click <strong>+ Add Credential</strong> to add a new federated credential.<p><img src="/assets/images/2021/11/oidc/oidc-federation-config.png" alt="Configure the OIDC settings" class="center-image" /><p class="figcaption">Configure the OIDC settings.<p>Enter in the <code class="language-plaintext highlighter-rouge">org</code>, <code class="language-plaintext highlighter-rouge">repo</code>, <code class="language-plaintext highlighter-rouge">entity type</code> and additional entity filters if applicable, as well as the <code class="language-plaintext highlighter-rouge">name</code> and <code class="language-plaintext highlighter-rouge">description</code> for the credential. You can see at the bottom how Azure constructs the <code class="language-plaintext highlighter-rouge">Subject identifier</code> for you based on the values you select. Under the hood, when Actions requests a token, it will send a <code class="language-plaintext highlighter-rouge">sub</code> parameter, and if this matched, Azure will issue a token.<p>Finally, go back to the <strong>Overview</strong> tab of the app registration and note the <strong>Application (client) ID</strong> and <strong>Directory (tenant) ID</strong>. You’ll also need the ID of the subscription you plan to target.<p>I repeated these steps to create a new SPN (<code class="language-plaintext highlighter-rouge">mona-oidc-prod</code>) and configured the federated credentials the same way as <code class="language-plaintext highlighter-rouge">mona-oidc-dev</code> except that I set the <code class="language-plaintext highlighter-rouge">environment</code> value to <code class="language-plaintext highlighter-rouge">prod</code> instead of <code class="language-plaintext highlighter-rouge">dev</code>.<h3 id="authorize-the-spn">Authorize the SPN</h3><p>Don’t forget that you have to grant the SPN roles within your subscription(s). If you plan to create resource groups, then assign the SPN the <code class="language-plaintext highlighter-rouge">Contributor</code> role on your subscription(s). If you want to scope the SPN a little more narrowly, then add it as <code class="language-plaintext highlighter-rouge">Contributor</code> on one or more resource groups. You can of course use whatever custom roles you need as well.<p>In my case, I created two resource groups, <code class="language-plaintext highlighter-rouge">oidc-dev</code> and <code class="language-plaintext highlighter-rouge">oidc-prod</code> and assigned <code class="language-plaintext highlighter-rouge">mona-oidc-dev</code> and <code class="language-plaintext highlighter-rouge">mona-oidc-prod</code> respectively as <code class="language-plaintext highlighter-rouge">Contributors</code>. This means the <code class="language-plaintext highlighter-rouge">mona-oidc-dev</code> can only “see” the <code class="language-plaintext highlighter-rouge">oidc-dev</code> resource group and that <code class="language-plaintext highlighter-rouge">mona-oidc-prod</code> can only “see” the <code class="language-plaintext highlighter-rouge">oidc-prod</code> resource group.<h1 id="github-configuration">GitHub Configuration</h1><p>Now we can configure the GitHub side. In <strong>Settings -&gt; Environments</strong> I create two environments: <code class="language-plaintext highlighter-rouge">dev</code> and <code class="language-plaintext highlighter-rouge">prod</code>. I then create the following secrets:<table><thead><tr><th>Name<th>Scope<th>Value<tbody><tr><td><code class="language-plaintext highlighter-rouge">AZURE_TENANT_ID</code><td>Repo<td>ID of the AAD tenant<tr><td><code class="language-plaintext highlighter-rouge">AZURE_SUBSCRIPTION_ID</code><td>Repo<td>ID of the target subscription<tr><td><code class="language-plaintext highlighter-rouge">AZURE_CLIENT_ID</code><td><code class="language-plaintext highlighter-rouge">dev</code> environment<td>App (client) ID for <code class="language-plaintext highlighter-rouge">mona-oidc-dev</code><tr><td><code class="language-plaintext highlighter-rouge">AZURE_CLIENT_ID</code><td><code class="language-plaintext highlighter-rouge">prod</code> environment<td>App (client) ID for <code class="language-plaintext highlighter-rouge">mona-oidc-prod</code></table><blockquote><p>Note: I could have specified the <code class="language-plaintext highlighter-rouge">AZURE_SUBSCRIPTION_ID</code> and <code class="language-plaintext highlighter-rouge">AZURE_TENANT_ID</code> at environment level if they differed. Most organizations will have separate <code class="language-plaintext highlighter-rouge">dev</code> and <code class="language-plaintext highlighter-rouge">prod</code> subscriptions, but usually share a single tenant.</blockquote><p><img src="/assets/images/2021/11/oidc/secret-config.png" alt="Configure environments and secrets" class="center-image" /><p class="figcaption">Configure environments and secrets.<blockquote><p>Note: none of these values constitutes a “secret” value. We have not added a secret for the client secret anywhere - just enough information to tell Azure which context we are going to request a token for.</blockquote><p>Of course you can add other environment configuration like approvals and deployment branches. I’ve left those as empty for this sample.<h1 id="the-main-workflow">The Main Workflow</h1><p>Here is the workflow that we’ll be using:<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1"># file: '.github/workflows/azure.yml'</span>
<span class="na">name</span><span class="pi">:</span> <span class="s">OIDC Demo</span>

<span class="na">on</span><span class="pi">:</span>
  <span class="na">workflow_dispatch</span><span class="pi">:</span>

<span class="na">permissions</span><span class="pi">:</span>
  <span class="na">id-token</span><span class="pi">:</span> <span class="s">write</span>

<span class="na">jobs</span><span class="pi">:</span>
  <span class="na">dev</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">Deploy to Dev</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">environment</span><span class="pi">:</span> <span class="s">dev</span>
    <span class="na">steps</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v2</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Azure Login using OIDC</span>
      <span class="na">uses</span><span class="pi">:</span> <span class="s">./.github/workflows/composite/azure-oidc-login</span>
      <span class="na">with</span><span class="pi">:</span>
        <span class="na">tenant_id</span><span class="pi">:</span> <span class="s">${{ secrets.AZURE_TENANT_ID }}</span>
        <span class="na">client_id</span><span class="pi">:</span> <span class="s">${{ secrets.AZURE_CLIENT_ID }}</span>
        <span class="na">subscription_id</span><span class="pi">:</span> <span class="s">${{ secrets.AZURE_SUBSCRIPTION_ID }}</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Run</span><span class="nv"> </span><span class="s">az</span><span class="nv"> </span><span class="s">commands'</span>
      <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
        <span class="s">az account show</span>
        <span class="s">az group list</span>
        <span class="s">pwd</span>

  <span class="na">prod</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">Deploy to Prod</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">environment</span><span class="pi">:</span> <span class="s">prod</span>
    <span class="na">steps</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v2</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Azure Login using OIDC</span>
      <span class="na">uses</span><span class="pi">:</span> <span class="s">./.github/workflows/composite/azure-oidc-login</span>
      <span class="na">with</span><span class="pi">:</span>
        <span class="na">tenant_id</span><span class="pi">:</span> <span class="s">${{ secrets.AZURE_TENANT_ID }}</span>
        <span class="na">client_id</span><span class="pi">:</span> <span class="s">${{ secrets.AZURE_CLIENT_ID }}</span>
        <span class="na">subscription_id</span><span class="pi">:</span> <span class="s">${{ secrets.AZURE_SUBSCRIPTION_ID }}</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Run</span><span class="nv"> </span><span class="s">az</span><span class="nv"> </span><span class="s">commands'</span>
      <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
        <span class="s">az account show</span>
        <span class="s">az group list</span>
        <span class="s">pwd</span>
        
  <span class="na">bad-prod</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">Deploy to Prod using dev</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">environment</span><span class="pi">:</span> <span class="s">prod</span>
    <span class="na">steps</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v2</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Azure Login using OIDC</span>
      <span class="na">uses</span><span class="pi">:</span> <span class="s">./.github/workflows/composite/azure-oidc-login</span>
      <span class="na">with</span><span class="pi">:</span>
        <span class="na">tenant_id</span><span class="pi">:</span> <span class="s">${{ secrets.AZURE_TENANT_ID }}</span>
        <span class="na">client_id</span><span class="pi">:</span> <span class="s">84b86cb5-5fbd-4950-88fa-1ab04be41de5</span>
        <span class="na">subscription_id</span><span class="pi">:</span> <span class="s">${{ secrets.AZURE_SUBSCRIPTION_ID }}</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Run</span><span class="nv"> </span><span class="s">az</span><span class="nv"> </span><span class="s">commands'</span>
      <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
        <span class="s">az account show</span>
        <span class="s">az group list</span>
        <span class="s">pwd</span>

</code></pre></div></div><p class="figcaption">The main workflow file.<p>Notes:<ol><li>We have to specify the <code class="language-plaintext highlighter-rouge">id-token: write</code> <code class="language-plaintext highlighter-rouge">permission</code> for this workflow to be able to retrieve and use an OIDC token.<li>There are three jobs: <code class="language-plaintext highlighter-rouge">dev</code> (which authenticates to <code class="language-plaintext highlighter-rouge">dev</code>), <code class="language-plaintext highlighter-rouge">prod</code> (which authenticates to <code class="language-plaintext highlighter-rouge">prod</code>) and <code class="language-plaintext highlighter-rouge">bad-prod</code> which uses the <code class="language-plaintext highlighter-rouge">dev</code> client ID and attempts to get a token for the <code class="language-plaintext highlighter-rouge">prod</code> environment.<li>Each job uses a composite action (<code class="language-plaintext highlighter-rouge">./.github/workflows/composite/azure-oidc-login</code>) to authenticate to Azure, passing in the <code class="language-plaintext highlighter-rouge">tenant_id</code>, <code class="language-plaintext highlighter-rouge">client_id</code> and <code class="language-plaintext highlighter-rouge">subscription_id</code>. The values that get passed are the values from the corresponding <code class="language-plaintext highlighter-rouge">environment</code> that is specified in each job.<li>After the authentication, <code class="language-plaintext highlighter-rouge">az cli</code> commands are executed, in this case just showing the current subscription (account) and listing the resource groups.<li>The <code class="language-plaintext highlighter-rouge">bad-prod</code> job is targeting the <code class="language-plaintext highlighter-rouge">prod</code> environment, so can’t use <code class="language-plaintext highlighter-rouge">secrets.AZURE_CLIENT_ID</code> otherwise it would get the ID for <code class="language-plaintext highlighter-rouge">mona-oidc-prod</code>. Just for demonstration, I have hard-coded the client ID of <code class="language-plaintext highlighter-rouge">mona-oidc-dev</code>.</ol><h2 id="the-composite-workflow">The Composite Workflow</h2><p>Why is there a <a href="/github-composite-actions/">composite action</a> at all? This is because in order to authenticate to Azure using OIDC, we have to use a beta version of the <code class="language-plaintext highlighter-rouge">az cli</code>. Rather than install this each time, I extracted this script and the <code class="language-plaintext highlighter-rouge">azure/login</code> step into a composite that can be reused.<p>Here is the composite action code:<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1"># file: '.github/workflows/composite/azure-oidc-login/action.yml</span>
<span class="na">name</span><span class="pi">:</span> <span class="s">OIDC Azure Login</span>

<span class="na">inputs</span><span class="pi">:</span>
  <span class="na">tenant_id</span><span class="pi">:</span>
    <span class="na">description</span><span class="pi">:</span> <span class="s">Azure AAD tenant ID</span>
    <span class="na">require</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">subscription_id</span><span class="pi">:</span>
    <span class="na">description</span><span class="pi">:</span> <span class="s">Azure subscription ID</span>
    <span class="na">require</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">client_id</span><span class="pi">:</span>
    <span class="na">description</span><span class="pi">:</span> <span class="s">Azure client ID that has been federated to repo/env/branch/tag</span>
    <span class="na">require</span><span class="pi">:</span> <span class="no">true</span>

<span class="na">runs</span><span class="pi">:</span>
  <span class="na">using</span><span class="pi">:</span> <span class="s">composite</span>
  <span class="na">steps</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Installing CLI-beta for OpenID Connect</span>
    <span class="na">shell</span><span class="pi">:</span> <span class="s">bash</span>
    <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
      <span class="s">cd ../..</span>
      <span class="s">CWD="$(pwd)"</span>
      <span class="s">python3 -m venv oidc-venv</span>
      <span class="s">. oidc-venv/bin/activate</span>
      <span class="s">echo "activated environment"</span>
      <span class="s">python3 -m pip install -q --upgrade pip</span>
      <span class="s">echo "started installing cli beta"</span>
      <span class="s">pip install -q --extra-index-url https://azcliprod.blob.core.windows.net/beta/simple/ azure-cli</span>
      <span class="s">echo "***************installed cli beta*******************"</span>
      <span class="s">echo "$CWD/oidc-venv/bin" &gt;&gt; $GITHUB_PATH</span>
  <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">azure/login@v1.4.0</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">Log in using OIDC</span>
    <span class="na">with</span><span class="pi">:</span>
      <span class="na">tenant-id</span><span class="pi">:</span> <span class="s">${{ inputs.tenant_id }}</span>
      <span class="na">client-id</span><span class="pi">:</span> <span class="s">${{ inputs.client_id }}</span>
      <span class="na">subscription-id</span><span class="pi">:</span> <span class="s">${{ inputs.subscription_id }}</span>

</code></pre></div></div><p class="figcaption">The composite action to login using OIDC.<p>Notes:<ol><li>The composite requires three <code class="language-plaintext highlighter-rouge">inputs</code> - the <code class="language-plaintext highlighter-rouge">tenant_id</code>, <code class="language-plaintext highlighter-rouge">subscription_id</code> and <code class="language-plaintext highlighter-rouge">client_id</code> that we need for the authentication.<li>The first step executes a script to install the beta <code class="language-plaintext highlighter-rouge">az cli</code>. When the <code class="language-plaintext highlighter-rouge">az cli</code> is updated to include OIDC features, this step (and the composite action) will no longer be necessary.<li>The second step uses <code class="language-plaintext highlighter-rouge">azure/login@v1.4.0</code> - this is the release that supports OIDC. It uses the inputs to request a token, and if successful, uses the token to authenticate the remainder of this session (job).</ol><h1 id="running-the-workflow">Running the Workflow</h1><p>When we run the workflow, it works as expected. The <code class="language-plaintext highlighter-rouge">dev</code> and <code class="language-plaintext highlighter-rouge">prod</code> jobs both work correctly. However, the <code class="language-plaintext highlighter-rouge">bad-prod</code> job fails since the <code class="language-plaintext highlighter-rouge">environment</code> does not match (remember, this was an attempt to authenticate to the <code class="language-plaintext highlighter-rouge">prod</code> environment using <code class="language-plaintext highlighter-rouge">mona-oidc-dev</code> credentials):<p><img src="/assets/images/2021/11/oidc/workflow-run.png" alt="Workflow run" class="center-image" /><p class="figcaption">A workflow run.<h2 id="dev-logs">Dev Logs</h2><p>Looking at the logs for <code class="language-plaintext highlighter-rouge">dev</code> we can see a successful authentication, and we can see that the context only has access to the <code class="language-plaintext highlighter-rouge">oidc-dev</code> resource group:<p><img src="/assets/images/2021/11/oidc/dev-log.png" alt="Dev logs" class="center-image" /><p class="figcaption">Dev logs.<h2 id="prod-logs">Prod Logs</h2><p>Similarly, the <code class="language-plaintext highlighter-rouge">prod</code> logs show a successful authentication, and we the context only has access to the <code class="language-plaintext highlighter-rouge">oidc-prod</code> resource group:<p><img src="/assets/images/2021/11/oidc/prod-log.png" alt="Prod logs" class="center-image" /><p class="figcaption">Prod logs.<h2 id="bad-prod-logs">Bad-prod Logs</h2><p>Finally, we see that the authentication failed for <code class="language-plaintext highlighter-rouge">bad-prod</code> since the environment was <code class="language-plaintext highlighter-rouge">prod</code> but the client ID was for <code class="language-plaintext highlighter-rouge">mona-oidc-dev</code>, which would have failed the <code class="language-plaintext highlighter-rouge">sub</code> match in AAD:<p><img src="/assets/images/2021/11/oidc/bad-prod-log.png" alt="Bad prod logs" class="center-image" /><p class="figcaption">Bad prod logs.<h1 id="limitations">Limitations</h1><p>At present, you cannot specify individual users for the OIDC credential - only repo-level entities.<p>Also, if you were thinking you could use a reusable workflow and request tokens from consuming workflows this way, you’re out of luck. Even if the <code class="language-plaintext highlighter-rouge">azure/login</code> step is in a reusable workflow, the <code class="language-plaintext highlighter-rouge">sub</code> will contain the child repo context. This means that if you use the same reusable workflow in 10 repos, you will have to add all 10 repos as federated identities in the SPN Federated Credentials settings in Azure AAD.<h1 id="conclusion">Conclusion</h1><p>Authenticating to cloud providers without secrets using OIDC is arguably more secure than having to store secrets. Tokens issues are short-lived, and because teams don’t have to store secrets, there is no need to rotate keys. Using OIDC to Azure is fairly simple and does not require a large change to existing workflows.<p>Happy federating!</article><hr class="dingbat related mb6" /><aside class="comments related" role="complementary"><h2 class="hr-bottom">Comments</h2><div id="giscus"><div></div></div><script> function toggle_giscus() { const c = document.body.classList; const dark = c.contains("dark-mode") || "_sunset" in window && !c.contains("light-mode") && matchMedia("(prefers-color-scheme: dark)").matches; const theme = dark ? "dark" : "light"; const scriptEl = document.createElement("script"); scriptEl.src = "https://giscus.app/client.js"; scriptEl.setAttribute("data-repo", "colindembovsky/colindembovsky.github.io"); scriptEl.setAttribute("data-repo-id", "MDEwOlJlcG9zaXRvcnk0MDczMjI3MjU="); scriptEl.setAttribute("data-category", "Giscussions"); scriptEl.setAttribute("data-category-id", "DIC_kwDOGEdAZc4B_F18"); scriptEl.setAttribute("data-mapping", "pathname"); scriptEl.setAttribute("data-reactions-enabled", "1"); scriptEl.setAttribute("data-emit-metadata", "colindembovsky/colindembovsky.github.io"); scriptEl.setAttribute("data-theme", theme); scriptEl.setAttribute("crossorigin", "anonymous"); const container = document.getElementById("giscus"); const old = container.firstElementChild; container.removeChild(old); container.appendChild(scriptEl); } document.addEventListener("hydejack-dark-mode-toggle", function() { toggle_giscus(); }); toggle_giscus(); </script></aside><aside class="other-projects related mb0" role="complementary"><h2>Related Posts</h2><div class="columns"><div class="column column-1-2"><article class="project-card"> <a href="/pages/colindembovsky/enforcing-reusable-workflows-for-standardization/" class="no-hover no-print-link flip-project" tabindex="-1"><div class="project-card-img aspect-ratio sixteen-nine flip-project-img"> <img src="/pages/colindembovsky/assets/images/2021/11/compliance-reusable/hacker.jpg" alt="Enforcing Reusable Workflows for Standardization" width="864" height="486" loading="lazy"/></div></a><h3 class="project-card-title flip-project-title"> <a href="/pages/colindembovsky/enforcing-reusable-workflows-for-standardization/" class="flip-title">Enforcing Reusable Workflows for Standardization</a></h3><p class="project-card-text fine" property="disambiguatingDescription"> Reusable workflows are great, but how do you ensure that teams are using your reusable workflows? In this post I show how you can structure repos, teams and environments to ensure standardization for your workflows. <a class="fill-card no-hover" href="/pages/colindembovsky/enforcing-reusable-workflows-for-standardization/" tabindex="-1"><span class="sr-only">Continue reading Enforcing Reusable Workflows for Standardization</span></a></article></div><div class="column column-1-2"><article class="project-card"> <a href="/pages/colindembovsky/on-demand-ephemeral-self-hosted-runners/" class="no-hover no-print-link flip-project" tabindex="-1"><div class="project-card-img aspect-ratio sixteen-nine flip-project-img"> <img src="/pages/colindembovsky/assets/images/2021/10/self-hosted-runners/boom.jpeg" alt="On Demand Ephemeral Self-Hosted Runners" width="864" height="486" loading="lazy"/></div></a><h3 class="project-card-title flip-project-title"> <a href="/pages/colindembovsky/on-demand-ephemeral-self-hosted-runners/" class="flip-title">On Demand Ephemeral Self-Hosted Runners</a></h3><p class="project-card-text fine" property="disambiguatingDescription"> Do you need to deploy to private VNets using GitHub Actions, but don’t want to have to keep self-hosted runners running all the time? In this post I show you how you can use Ephemeral Runners to create on-demand self-hosted runners. <a class="fill-card no-hover" href="/pages/colindembovsky/on-demand-ephemeral-self-hosted-runners/" tabindex="-1"><span class="sr-only">Continue reading On Demand Ephemeral Self-Hosted Runners</span></a></article></div></div></aside><aside class="related mb4" role="complementary"><h2 class="hr-bottom">Random Posts</h2><ul class="related-posts"><li class="h4"> <a href="/pages/colindembovsky/2012-lab-management-standard-environment-configuring-ui-tests-agent-identity-problem/" class="flip-title"><span>2012 Lab Management Standard Environment: Configuring UI Tests Agent Identity Problem</span></a> <time class="faded fine" datetime="2012-07-12T21:58:00+00:00">12 Jul 2012</time><li class="h4"> <a href="/pages/colindembovsky/musings-on-reusable-workflows/" class="flip-title"><span>Musings on GitHub Actions Reusable Workflows</span></a> <time class="faded fine" datetime="2021-10-05T01:22:01+00:00">05 Oct 2021</time><li class="h4"> <a href="/pages/colindembovsky/azdo-create-work-item-action/" class="flip-title"><span>Create Azure DevOps Work Item Action</span></a> <time class="faded fine" datetime="2021-09-01T17:22:01+00:00">01 Sep 2021</time></ul></aside><footer class="content" role="contentinfo"><hr/><p><small class="copyright">© 2021. All rights reserved. </small><hr class="sr-only"/></footer></main><hy-drawer id="_drawer" class="" side="left" threshold="10" noscroll ><header id="_sidebar" class="sidebar" role="banner"><div class="sidebar-bg sidebar-overlay" style="background-color:rgb(5,19,24);background-image:url(/pages/colindembovsky/assets/img/sidebar-bg.jpg)"></div><div class="sidebar-sticky"><div class="sidebar-about"> <a class="no-hover" href="/pages/colindembovsky/" tabindex="-1"> <img src="/pages/colindembovsky/assets/img/logo.png" class="avatar" alt="Colin's ALM Corner" width="120" height="120" loading="lazy" /> </a> <a class="sidebar-title" href="/pages/colindembovsky/"><h2 class="h1">Colin's ALM Corner</h2></a><p class=""> DevOpsology &amp; GitHub. <br /> <em>Opinions my own</em>.</div><nav class="sidebar-nav heading" role="navigation"> <span class="sr-only">Navigation:</span><ul><li> <a id="_drawer--opened" href="/pages/colindembovsky/tags/" class="sidebar-nav-item " > Tags </a><li> <a href="/pages/colindembovsky/about/" class="sidebar-nav-item " > About </a></ul></nav><div class="sidebar-social"> <span class="sr-only">Social:</span><ul><li> <a href="https://twitter.com/colindembovsky" title="Twitter" class="no-mark-external"> <span class="icon-twitter"></span> <span class="sr-only">Twitter</span> </a><li> <a href="https://github.com/colindembovsky" title="GitHub" class="no-mark-external"> <span class="icon-github"></span> <span class="sr-only">GitHub</span> </a><li> <a href="https://colinsalmcorner.com/feed.xml" title="RSS" class="no-mark-external"> <span class="icon-rss2"></span> <span class="sr-only">RSS</span> </a></ul></div></div></header></hy-drawer><hr class="sr-only" hidden /> </hy-push-state> <!--[if gt IE 10]><!----> <script nomodule>!function(){var t,n=document.createElement("script");!("noModule"in n)&&"onbeforeload"in n&&(t=!1,document.addEventListener("beforeload",function(e){if(e.target===n)t=!0;else if(!e.target.hasAttribute("nomodule")||!t)return;e.preventDefault()},!0),n.type="module",n.src=".",document.head.appendChild(n),n.remove())}(); </script> <script src="/pages/colindembovsky/assets/js/hydejack-9.1.4.js" type="module"></script> <script src="/pages/colindembovsky/assets/js/LEGACY-hydejack-9.1.4.js" nomodule defer></script> <script type="module"> if ('serviceWorker' in navigator) { /**/ navigator.serviceWorker.getRegistration() .then(r => r.unregister()) .catch(() => {}); /**/ } </script> <!--<![endif]--><div hidden><h2 class="sr-only">Templates (for web app):</h2><clap-config> <clap-text at="1">Keep going!</clap-text> <clap-text at="2">Keep going ×2!</clap-text> <clap-text at="3">Give me more!</clap-text> <clap-text at="5">Thank you, thank you</clap-text> <clap-text at="7">Far too kind!</clap-text> <clap-text at="10">Never gonna give me up?</clap-text> <clap-text at="14">Never gonna let me down?</clap-text> <clap-text at="20">Turn around and desert me!</clap-text> <clap-text at="30">You're an addict!</clap-text> <clap-text at="40">Son of a clapper!</clap-text> <clap-text at="50">No way</clap-text> <clap-text at="60">Go back to work!</clap-text> <clap-text at="70">This is getting out of <em>hand</em></clap-text> <clap-text at="80">Unbelievable</clap-text> <clap-text at="90">PREPOSTEROUS</clap-text> <clap-text at="100">I N S A N I T Y</clap-text> <clap-text at="185"><span style="font-family:monospace">FEED ME A STRAY CAT</span></clap-text> </clap-config> <template id="_animation-template"><div class="animation-main fixed-top"><nav id="breadcrumbs" class="screen-only"><ul></ul></nav><div class="content"><div class="page"></div></div></div></template> <template id="_loading-template"><div class="loading nav-btn fr"> <span class="sr-only">Loading…</span> <span class="icon-cog"></span></div></template> <template id="_error-template"><div class="page"><h1 class="page-title">Error</h1><p class="lead"> Sorry, an error occurred while loading <a class="this-link" href=""></a>.</div></template> <template id="_permalink-template"> <a href="#" class="permalink"> <span class="sr-only">Permalink</span> <span class="content-hash"></span> </a> </template> <template id="_cookies-banner-template"><div id="_cookies-banner" class="navbar fixed-bottom CookiesOK"><div class="content"><div class="nav-btn-bar"> <small class="faded"> <span>This site uses cookies. <a href="/cookies-policy/">Cookies Policy</a>. </span> <button id="_cookies-ok" class="btn btn-primary btn-sm">Okay</button> </small></div></div></div></template> <template id="_dark-mode-template"> <button id="_dark-mode" class="nav-btn no-hover" > <span class="sr-only">Dark Mode</span> <span class="icon-brightness-contrast"></span> </button> </template> <template id="_search-template"> <button id="_search" class="nav-btn no-hover"> <label class="sr-only" for="_search-input">Search</label> <span class="icon-search"></span> </button><div id="_search-box"><div class="nav-btn"> <span class="icon-search"></span></div><input id="_search-input" type="search" class="form-control form-control-lg nav-btn" placeholder="Type something…" /> <button type="reset" class="nav-btn no-hover"> <span class="sr-only">Close</span> <span class="icon-cross"></span> </button></div><div id="_hits"></div></template></div></html>
